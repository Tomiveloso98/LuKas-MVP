<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="Lucas"/>
<title>Lucas ‚Äî Tus Finanzas</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">

</script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
<style>
  :root {
    --blue: #3B82F6;
    --blue-light: rgba(59,130,246,0.15);
    --red: #EF4444;
    --red-light: rgba(239,68,68,0.15);
    --green: #10B981;
    --green-light: rgba(16,185,129,0.15);
    --amber: #F59E0B;
    --amber-light: rgba(245,158,11,0.15);
    --purple: #8B5CF6;
    --bg: #0A1628;
    --bg2: #101022;
    --card: #1A2B45;
    --card2: #111d30;
    --text: #F8FAFC;
    --muted: #94A3B8;
    --border: rgba(255,255,255,0.08);
    --shadow: 0 2px 8px rgba(0,0,0,0.3);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.4);
    --radius: 16px;
    --radius-sm: 10px;
    --tab-height: 72px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow: hidden; background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; color: var(--text); }

  /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
  #app { height: 100%; display: flex; flex-direction: column; max-width: 430px; margin: 0 auto; background: var(--bg); overflow: hidden; box-shadow: 0 0 60px rgba(0,0,0,0.4); position: relative; }

  /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
  /* Screens sit between top=0 and bottom=tabbar height */
  .screen { position: absolute; top: 0; left: 0; right: 0; bottom: calc(var(--tab-height) + var(--safe-bottom)); overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; background: var(--bg); display: none; flex-direction: column; }
  .screen.active { display: flex; }

  /* Modals slide in from right, cover full height including tabbar */
  .screen-modal { position: absolute; inset: 0; background: var(--bg); z-index: 100; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.32s cubic-bezier(0.4,0,0.2,1); pointer-events: none; }
  .screen-modal.open { transform: translateX(0); pointer-events: all; }

  /* Overlays stack on top of modals */
  .screen-overlay { position: absolute; inset: 0; background: var(--bg); z-index: 200; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.32s cubic-bezier(0.4,0,0.2,1); pointer-events: none; }
  .screen-overlay.open { transform: translateX(0); pointer-events: all; }

  /* ‚îÄ‚îÄ TAB BAR ‚Äî always at bottom ‚îÄ‚îÄ */
  #tabbar {
    position: fixed;
    bottom: 0; left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 430px;
    z-index: 200;
    height: calc(var(--tab-height) + var(--safe-bottom));
    padding-bottom: var(--safe-bottom);
    background: rgba(10,22,40,0.97);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255,255,255,0.08);
    display: flex;
    align-items: flex-start;
    padding-top: 8px;
    flex-shrink: 0;
  }
  .tab-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 4px 0; cursor: pointer; background: none; border: none; }
  .tab-btn .ti { font-size: 24px; color: var(--muted); transition: color 0.2s; font-variation-settings: 'FILL' 0; }
  .tab-btn .tl { font-size: 10px; font-weight: 600; color: var(--muted); transition: color 0.2s; letter-spacing: 0.02em; }
  .tab-btn.active .ti { color: var(--blue); font-variation-settings: 'FILL' 1; }
  .tab-btn.active .tl { color: var(--blue); }
  .fab { width: 56px; height: 56px; border-radius: 50%; background: var(--blue); box-shadow: 0 4px 16px rgba(37,99,235,0.45); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-top: -22px; transition: transform 0.15s, box-shadow 0.15s; }
  .fab:active { transform: scale(0.9); }
  .fab .material-symbols-rounded { font-size: 28px; color: white; font-variation-settings: 'FILL' 1; }

  /* ‚îÄ‚îÄ TYPOGRAPHY ‚îÄ‚îÄ */
  .screen-title { font-size: 22px; font-weight: 800; }
  .section-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; }
  .lbl { font-size: 11px; font-weight: 700; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  .card { background: var(--card); border-radius: var(--radius); box-shadow: 0 2px 12px rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.09); }
  .card-p { padding: 16px; }
  .top-header { padding: 16px 20px 12px; background: var(--bg); position: sticky; top: 0; z-index: 10; }
  .back-header { display: flex; align-items: center; padding: 12px 16px; background: rgba(10,22,40,0.97); backdrop-filter: blur(16px); position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .back-btn { display: flex; align-items: center; gap: 2px; background: none; border: none; color: var(--blue); font-family: inherit; font-size: 16px; font-weight: 600; cursor: pointer; padding: 4px 0; }
  .back-header-title { flex: 1; text-align: center; font-size: 17px; font-weight: 700; }
  .sticky-footer { position: sticky; bottom: 0; background: rgba(241,245,249,0.95); backdrop-filter: blur(10px); padding: 12px 20px 20px; border-top: 1px solid var(--border); flex-shrink: 0; }

  /* ‚îÄ‚îÄ SEGMENTED + TABS ‚îÄ‚îÄ */
  .seg-control { display: flex; background: rgba(100,116,139,0.12); border-radius: 12px; padding: 3px; }
  .seg-btn { flex: 1; padding: 8px; border: none; background: none; font-family: inherit; font-size: 13px; font-weight: 600; color: var(--muted); border-radius: 9px; cursor: pointer; transition: all 0.2s; }
  .seg-btn.active { background: var(--card); color: var(--blue); box-shadow: 0 1px 6px rgba(0,0,0,0.3); }
  .underline-tabs { display: flex; gap: 20px; border-bottom: 1px solid var(--border); }
  .underline-tab { padding: 8px 0 10px; border: none; background: none; font-family: inherit; font-size: 14px; font-weight: 700; color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.2s; }
  .underline-tab.active { color: var(--text); border-bottom-color: var(--blue); }

  /* ‚îÄ‚îÄ BALANCE ‚îÄ‚îÄ */
  .balance-card { background: var(--blue); border-radius: var(--radius); padding: 20px; color: white; box-shadow: 0 8px 24px rgba(37,99,235,0.35); }
  .balance-amount { font-size: 36px; font-weight: 800; letter-spacing: -1.5px; margin: 4px 0 12px; }
  .balance-badge { display: inline-flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.2); border-radius: 100px; padding: 4px 10px; font-size: 11px; font-weight: 600; }

  /* ‚îÄ‚îÄ KPI ‚îÄ‚îÄ */
  .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .kpi-card { background: var(--card); border-radius: var(--radius-sm); padding: 14px; box-shadow: var(--shadow); }
  .kpi-value { font-size: 20px; font-weight: 800; margin: 2px 0; }
  .kpi-sub { font-size: 10px; color: var(--muted); font-weight: 500; }

  /* ‚îÄ‚îÄ CYCLE INFO BANNER ‚îÄ‚îÄ */
  .cycle-banner { background: #FFFBEB; border: 1px solid #FDE68A; border-radius: var(--radius-sm); padding: 10px 14px; display: flex; align-items: center; gap: 10px; }
  .cycle-banner .material-symbols-rounded { color: var(--amber); font-size: 18px; flex-shrink: 0; font-variation-settings: 'FILL' 1; }
  .cycle-banner p { font-size: 11px; color: #92400E; font-weight: 600; line-height: 1.4; }

  /* ‚îÄ‚îÄ TRANSACTIONS ‚îÄ‚îÄ */
  .txn-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--card); border-radius: var(--radius-sm); box-shadow: var(--shadow); cursor: pointer; transition: transform 0.15s; }
  .txn-item:active { transform: scale(0.98); }
  .txn-icon { width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .txn-info { flex: 1; min-width: 0; }
  .txn-name { font-size: 14px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .txn-sub { font-size: 11px; color: var(--muted); font-weight: 500; margin-top: 1px; }
  .date-group { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; padding: 16px 20px 6px; }

  /* ‚îÄ‚îÄ DONUT ‚îÄ‚îÄ */
  .donut-wrap { display: flex; align-items: center; gap: 20px; }
  .cat-legend { flex: 1; display: flex; flex-direction: column; gap: 8px; }
  .cat-legend-item { display: flex; align-items: center; justify-content: space-between; font-size: 12px; }
  .cat-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn-primary { width: 100%; padding: 16px; background: linear-gradient(135deg,#3B82F6,#2563EB); color: white; border: none; border-radius: 14px; font-family: inherit; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 16px rgba(59,130,246,0.35); transition: all 0.15s; box-shadow: 0 4px 12px rgba(37,99,235,0.3); display: flex; align-items: center; justify-content: center; gap: 8px; }
  .btn-primary:active { transform: scale(0.97); }
  .btn-ghost { width: 100%; padding: 14px; background: none; color: var(--muted); border: none; font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; }
  .btn-danger { background: none; border: none; color: var(--red); font-family: inherit; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; justify-content: center; width: 100%; padding: 14px; }

  /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
  .form-field { margin-bottom: 18px; }
  .form-label { font-size: 12px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; display: block; }
  .form-input { width: 100%; padding: 13px 16px; background: var(--card2); border: 1.5px solid rgba(255,255,255,0.1); border-radius: 12px; font-family: inherit; font-size: 15px; color: var(--text); outline: none; transition: border-color 0.2s; }
  .form-input:focus { border-color: var(--blue); }
  .form-select { width: 100%; padding: 13px 16px; background: var(--card); border: 1.5px solid var(--border); border-radius: var(--radius-sm); font-family: inherit; font-size: 15px; color: var(--text); outline: none; appearance: none; }
  .form-select:focus { border-color: var(--blue); }
  .amount-input-wrap { display: flex; align-items: baseline; gap: 6px; justify-content: center; padding: 28px 20px 20px; }
  .amount-prefix { font-size: 36px; font-weight: 800; color: var(--muted); }
  .amount-input { background: none; border: none; outline: none; font-family: inherit; font-size: 60px; font-weight: 800; color: var(--text); width: 100%; text-align: center; max-width: 260px; }
  .amount-input::placeholder { color: #CBD5E1; }

  /* ‚îÄ‚îÄ CATEGORY GRID ‚îÄ‚îÄ */
  .cat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .cat-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 14px 8px; background: var(--card); border: 2px solid transparent; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.18s; box-shadow: var(--shadow); font-family: inherit; }
  .cat-btn.selected { border-color: var(--blue); background: var(--blue-light); }
  .cat-icon-wrap { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--bg); transition: background 0.18s; }
  .cat-btn.selected .cat-icon-wrap { background: rgba(37,99,235,0.12); }
  .cat-btn .cat-name { font-size: 11px; font-weight: 600; color: var(--muted); text-align: center; }
  .cat-btn.selected .cat-name { color: var(--blue); }
  /* "Agregar" button in grid */
  .cat-add-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 14px 8px; background: var(--bg); border: 2px dashed var(--border); border-radius: var(--radius-sm); cursor: pointer; font-family: inherit; transition: all 0.18s; }
  .cat-add-btn:active { border-color: var(--blue); }

  /* ‚îÄ‚îÄ PAYMENT SEGMENT ‚îÄ‚îÄ */
  .pay-seg { display: grid; grid-template-columns: repeat(3,1fr); background: rgba(100,116,139,0.1); border-radius: var(--radius-sm); padding: 3px; gap: 3px; }
  .pay-btn { padding: 10px; border: none; background: none; font-family: inherit; font-size: 13px; font-weight: 600; color: var(--muted); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
  .pay-btn.active { background: var(--card); color: var(--text); box-shadow: 0 1px 6px rgba(0,0,0,0.3); }

  /* ‚îÄ‚îÄ TOGGLE ‚îÄ‚îÄ */
  .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; }
  .toggle-row + .toggle-row { border-top: 1px solid var(--border); }
  .toggle { position: relative; width: 51px; height: 31px; flex-shrink: 0; }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider { position: absolute; inset: 0; background: #D1D5DB; border-radius: 100px; transition: 0.3s; cursor: pointer; }
  .toggle-slider:before { content: ''; position: absolute; height: 27px; width: 27px; left: 2px; bottom: 2px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  .toggle input:checked + .toggle-slider { background: var(--blue); }
  .toggle input:checked + .toggle-slider:before { transform: translateX(20px); }

  /* ‚îÄ‚îÄ CAPTURE CARDS ‚îÄ‚îÄ */
  .capture-primary { background: var(--blue); border-radius: var(--radius); padding: 20px; display: flex; align-items: center; gap: 16px; cursor: pointer; transition: transform 0.15s; box-shadow: 0 6px 20px rgba(37,99,235,0.35); }
  .capture-primary:active { transform: scale(0.97); }
  .capture-card { background: var(--card); border-radius: var(--radius); padding: 18px 20px; display: flex; align-items: center; gap: 16px; cursor: pointer; box-shadow: var(--shadow); transition: transform 0.15s; }
  .capture-card:active { transform: scale(0.97); }
  .cap-icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

  /* ‚îÄ‚îÄ QUICK CHIPS ‚îÄ‚îÄ */
  .quick-chip { display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 12px 14px; background: var(--card); border-radius: var(--radius-sm); box-shadow: var(--shadow); cursor: pointer; flex-shrink: 0; min-width: 68px; transition: transform 0.15s; border: none; font-family: inherit; }
  .quick-chip:active { transform: scale(0.93); }

  /* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
  .settings-group { background: var(--card); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
  .settings-row { display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
  .settings-row:last-child { border-bottom: none; }
  .settings-row:active { background: var(--bg); }
  .s-icon { width: 34px; height: 34px; border-radius: 9px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

  /* ‚îÄ‚îÄ CONFIDENCE BADGE ‚îÄ‚îÄ */
  .conf-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 100px; font-size: 12px; font-weight: 700; }
  .conf-alta { background: var(--green-light); color: var(--green); }
  .conf-media { background: #FFFBEB; color: #D97706; }
  .conf-baja { background: var(--red-light); color: var(--red); }

  /* ‚îÄ‚îÄ CUOTA BADGE ‚îÄ‚îÄ */
  .cuota-badge { display: inline-flex; align-items: center; gap: 3px; background: #EDE9FE; color: #A78BFA; border-radius: 6px; padding: 2px 7px; font-size: 10px; font-weight: 700; }

  /* ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ */
  .ob-screen { position: absolute; inset: 0; background: var(--bg); z-index: 500; display: flex; flex-direction: column; overflow-y: auto; }
  .ob-option { padding: 16px; border-radius: var(--radius-sm); cursor: pointer; border: 2px solid var(--border); background: var(--card); font-family: inherit; width: 100%; text-align: left; transition: all 0.2s; }
  .ob-option.selected { border-color: var(--blue); background: var(--blue-light); }
  .progress-wrap { height: 4px; background: var(--border); border-radius: 2px; }
  .progress-fill { height: 100%; background: var(--blue); border-radius: 2px; transition: width 0.4s cubic-bezier(0.4,0,0.2,1); }

  /* ‚îÄ‚îÄ CAMERA ‚îÄ‚îÄ */
  .camera-screen-inner { background: #0F172A; color: white; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .camera-frame { width: 260px; height: 360px; border: 2px solid rgba(255,255,255,0.3); border-radius: 16px; position: relative; }
  .corner { position: absolute; width: 24px; height: 24px; border-color: var(--blue); border-style: solid; }
  .c-tl { top:-2px; left:-2px; border-width:3px 0 0 3px; border-radius:4px 0 0 0; }
  .c-tr { top:-2px; right:-2px; border-width:3px 3px 0 0; border-radius:0 4px 0 0; }
  .c-bl { bottom:-2px; left:-2px; border-width:0 0 3px 3px; border-radius:0 0 0 4px; }
  .c-br { bottom:-2px; right:-2px; border-width:0 3px 3px 0; border-radius:0 0 4px 0; }

  /* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
  .search-bar { display: flex; align-items: center; gap: 10px; background: var(--card); border-radius: 12px; padding: 10px 14px; box-shadow: var(--shadow); }
  .search-bar input { flex: 1; border: none; background: none; font-family: inherit; font-size: 14px; outline: none; color: var(--text); }
  .filter-chips { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; }
  .filter-chips::-webkit-scrollbar { display: none; }
  .filter-chip { flex-shrink: 0; padding: 7px 14px; background: var(--card); border: 1.5px solid var(--border); border-radius: 100px; font-size: 12px; font-weight: 600; color: var(--muted); cursor: pointer; white-space: nowrap; transition: all 0.2s; }
  .filter-chip.active { background: var(--blue); border-color: var(--blue); color: white; }

  /* ‚îÄ‚îÄ TIP ‚îÄ‚îÄ */
  .tip-card { background: var(--blue-light); border-radius: var(--radius-sm); padding: 12px 14px; display: flex; gap: 10px; align-items: flex-start; }
  .tip-card .material-symbols-rounded { color: var(--blue); font-size: 18px; flex-shrink: 0; font-variation-settings: 'FILL' 1; }
  .tip-text { font-size: 12px; color: var(--blue); font-weight: 500; line-height: 1.5; }

  /* ‚îÄ‚îÄ SPINNER ‚îÄ‚îÄ */
  .spinner { width: 48px; height: 48px; border: 3px solid var(--border); border-top-color: var(--blue); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ */
  .profile-card { display: flex; align-items: center; gap: 14px; padding: 20px; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); }

  /* ‚îÄ‚îÄ CATEGORY MANAGER ‚îÄ‚îÄ */
  .cat-manage-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--card); border-radius: var(--radius-sm); box-shadow: var(--shadow); margin-bottom: 8px; }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast { position: fixed; bottom: calc(var(--tab-height) + var(--safe-bottom) + 16px); left: 50%; transform: translateX(-50%) translateY(16px); background: #1E293B; color: white; padding: 12px 22px; border-radius: 100px; font-size: 13px; font-weight: 600; white-space: nowrap; opacity: 0; transition: all 0.3s; z-index: 999; pointer-events: none; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
  .divider { height: 1px; background: var(--border); }
  .text-blue { color: var(--blue); }
  .text-red { color: var(--red); }
  .text-green { color: var(--green); }
  .text-muted { color: var(--muted); }

  /* ‚îÄ‚îÄ VISUAL CREDIT CARDS ‚Äî Stitch Dark Style ‚îÄ‚îÄ */
  .card-visual {
    width: 100%; height: 176px; border-radius: 16px;
    padding: 20px 22px; position: relative; overflow: hidden;
    display: flex; flex-direction: column; justify-content: space-between;
    box-shadow: 0 4px 24px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.12); cursor: pointer;
    transition: transform 0.18s ease;
    border: none;
  }
  .card-visual:active { transform: scale(0.975); }
  /* Diagonal stripe overlay like stitch */
  .card-visual::before {
    content:'';
    position:absolute; inset:0;
    background: repeating-linear-gradient(
      -55deg,
      transparent,
      transparent 8px,
      rgba(255,255,255,0.04) 8px,
      rgba(255,255,255,0.04) 9px
    );
    pointer-events:none;
  }
  .card-chip { width:36px; height:28px; background:linear-gradient(135deg,#f0d060,#c8a020); border-radius:5px; }
  .card-contactless { width:28px; height:28px; border-radius:50%; background:rgba(255,255,255,0.12); display:flex; align-items:center; justify-content:center; }
  .card-network { font-size:22px; font-weight:900; font-style:italic; color:rgba(255,255,255,0.95); letter-spacing:-0.5px; }
  .card-network-plain { font-size:16px; font-weight:900; color:rgba(255,255,255,0.95); letter-spacing:1px; }
  .card-number { font-size:14px; font-weight:500; letter-spacing:4px; color:rgba(255,255,255,0.8); font-family:monospace; }
  .card-lbl { font-size:8px; text-transform:uppercase; letter-spacing:0.12em; color:rgba(255,255,255,0.45); margin-bottom:2px; }
  .card-val { font-size:12px; font-weight:700; color:rgba(255,255,255,0.9); }
  .card-bankname { font-size:13px; font-weight:600; color:rgba(255,255,255,0.75); }

  /* Card info panel below visual card */
  .card-info-panel {
    background: var(--card);
    border-radius: 0 0 16px 16px;
    padding: 16px 18px 18px;
    margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.06);
    border-top: none;
  }
  .card-info-panel-top {
    background: var(--card);
    border-radius: 16px;
    padding: 16px 18px 18px;
    margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.06);
  }
  .prog-bar { height:4px; background:rgba(255,255,255,0.08); border-radius:3px; overflow:hidden; margin:8px 0 4px; }
  .prog-fill { height:100%; border-radius:3px; transition:width 0.8s ease; }

  /* Segment control */
  .seg-ctrl { display:flex; background:rgba(255,255,255,0.06); border-radius:10px; padding:3px; margin:0 20px 14px; }
  .seg-btn { flex:1; padding:8px 4px; border:none; border-radius:8px; font-family:inherit; font-size:12px; font-weight:700; cursor:pointer; background:transparent; color:var(--muted); transition:all 0.2s; }
  .seg-btn.active { background:var(--card); color:var(--blue); box-shadow:0 1px 4px rgba(0,0,0,0.3); }

  /* Cycle blocks */
  .cyc-block { background:#162033; border-radius:14px; padding:16px; margin:0 20px 12px; box-shadow:0 4px 16px rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.09); }
  .cyc-row { display:flex; justify-content:space-between; align-items:center; padding:7px 0; border-bottom:1px solid var(--border); }
  .cyc-row:last-child { border-bottom:none; }
  .cuota-line { display:flex; justify-content:space-between; padding:5px 0 5px 12px; border-bottom:1px solid var(--border); font-size:13px; }
  .cuota-line:last-child { border-bottom:none; }
  .hist-item { background:#162033; border-radius:12px; padding:14px 16px; margin:0 20px 10px; box-shadow:0 4px 16px rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.09); }

  .bank-chip { padding:7px 14px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:20px; font-family:inherit; font-size:13px; font-weight:600; color:var(--text); cursor:pointer; transition:all 0.15s; }
  .bank-chip:active, .bank-chip.selected { background:rgba(59,130,246,0.15); border-color:var(--blue); color:var(--blue); }
</style>
</head>
<body>
<div id="app">

  <!-- ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ -->
  <div id="authScreen" style="position:absolute;inset:0;background:var(--bg);z-index:600;display:flex;flex-direction:column;overflow-y:auto;">
    <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 28px;">
      <div style="width:72px;height:72px;border-radius:20px;background:linear-gradient(135deg,#2563EB,#7C3AED);display:flex;align-items:center;justify-content:center;margin-bottom:20px;box-shadow:0 8px 24px rgba(37,99,235,0.35);">
        <span style="font-size:36px;">‚Ç°</span>
      </div>
      <h1 style="font-size:28px;font-weight:800;margin-bottom:6px;">Lucas</h1>
      <p style="font-size:14px;color:#64748B;margin-bottom:36px;text-align:center;">Tus finanzas personales en Chile</p>
      <div style="display:flex;background:rgba(255,255,255,0.06);border-radius:10px;padding:4px;margin-bottom:24px;width:100%;">
        <button id="authTabLogin" onclick="switchAuthTab('login')" style="flex:1;padding:10px;border:none;border-radius:8px;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;background:var(--card);color:var(--blue);box-shadow:0 1px 6px rgba(0,0,0,0.1);">Ingresar</button>
        <button id="authTabRegister" onclick="switchAuthTab('register')" style="flex:1;padding:10px;border:none;border-radius:8px;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;background:transparent;color:#64748B;">Crear cuenta</button>
      </div>
      <div style="width:100%;display:flex;flex-direction:column;gap:12px;">
        <div>
          <label style="font-size:12px;font-weight:700;color:#64748B;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:6px;">Email</label>
          <input type="email" id="authEmail" placeholder="tu@email.com" inputmode="email"
            style="width:100%;border:1.5px solid #E2E8F0;border-radius:10px;padding:13px 16px;font-family:inherit;font-size:15px;outline:none;box-sizing:border-box;"
            onfocus="this.style.borderColor='#2563EB'" onblur="this.style.borderColor='#E2E8F0'"
            onkeydown="if(event.key==='Enter')document.getElementById('authPassword').focus()"/>
        </div>
        <div>
          <label style="font-size:12px;font-weight:700;color:#64748B;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:6px;">Contrase√±a</label>
          <input type="password" id="authPassword" placeholder="M√≠nimo 6 caracteres"
            style="width:100%;border:1.5px solid #E2E8F0;border-radius:10px;padding:13px 16px;font-family:inherit;font-size:15px;outline:none;box-sizing:border-box;"
            onfocus="this.style.borderColor='#2563EB'" onblur="this.style.borderColor='#E2E8F0'"
            onkeydown="if(event.key==='Enter')submitAuth()"/>
        </div>
        <p id="authError" style="font-size:13px;color:#EF4444;display:none;text-align:center;margin:0;"></p>
        <button id="authSubmitBtn" onclick="submitAuth()" style="width:100%;padding:16px;background:#2563EB;border:none;border-radius:12px;font-family:inherit;font-size:16px;font-weight:800;color:white;cursor:pointer;margin-top:4px;">Ingresar</button>
      </div>
      <p style="font-size:11px;color:#94A3B8;margin-top:28px;text-align:center;line-height:1.6;">üîí Sin claves bancarias ¬∑ Datos encriptados</p>
    </div>
  </div>

  <!-- iframe notice ‚Äî shown when running inside Claude viewer -->
  <div id="iframeNotice" style="display:none;background:rgba(245,158,11,0.12);border-bottom:2px solid #FCD34D;padding:10px 16px;gap:10px;align-items:flex-start;z-index:9999;flex-shrink:0;">
    <span style="font-size:18px;flex-shrink:0;">üí°</span>
    <div>
      <p style="font-size:12px;font-weight:700;color:#F59E0B;">Para usar OCR real con tu boleta</p>
      <p style="font-size:11px;color:#F59E0B;margin-top:2px;line-height:1.5;">Descarga el archivo y √°brelo directamente en Chrome o Safari. El visor de Claude bloquea las llamadas a OpenAI.</p>
    </div>
  </div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ONBOARDING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="ob-screen" id="obScreen" style="position:absolute;inset:0;background:var(--bg);z-index:500;display:none;flex-direction:column;overflow-y:auto;">

  <!-- STEP 1: Bienvenida + Ingreso -->
  <div id="ob1" style="display:flex;flex-direction:column;flex:1;">
    <div style="padding:20px 24px 0;">
      <div class="progress-wrap"><div class="progress-fill" style="width:25%"></div></div>
      <div style="display:flex;justify-content:space-between;margin-top:14px;">
        <span style="font-size:13px;font-weight:600;color:var(--muted)">1 de 4</span>
        <button onclick="skipOB()" style="background:none;border:none;font-family:inherit;font-size:13px;font-weight:600;color:var(--muted);cursor:pointer;">Omitir todo</button>
      </div>
    </div>
    <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0 28px;">
      <div style="width:80px;height:80px;background:var(--blue-light);border-radius:24px;display:flex;align-items:center;justify-content:center;margin-bottom:24px;">
        <span class="material-symbols-rounded" style="font-size:44px;color:var(--blue);font-variation-settings:'FILL' 1;">account_balance_wallet</span>
      </div>
      <h1 style="font-size:30px;font-weight:800;text-align:center;margin-bottom:8px;line-height:1.2;">Bienvenido a<br/><span style="color:var(--blue)">Lucas</span></h1>
      <p style="font-size:14px;color:var(--muted);text-align:center;line-height:1.6;margin-bottom:32px;">Controla tus gastos en Chile. Sin claves bancarias, sin complicaciones.</p>
      <div style="width:100%;">
        <p style="font-size:13px;color:var(--muted);text-align:center;line-height:1.6;">Configura tus tarjetas e ingresos en los pr√≥ximos pasos.<br/>Todo es opcional y editable luego en Ajustes.</p>
      </div>
    </div>
    <div style="padding:0 24px 32px;">
      <button class="btn-primary" onclick="goOb(2)">Continuar ‚Üí</button>
    </div>
  </div>

  <!-- STEP 2: Tarjeta de cr√©dito -->
  <div id="ob2" style="display:none;flex-direction:column;flex:1;overflow-y:auto;">
    <div style="padding:20px 24px 0;">
      <div class="progress-wrap"><div class="progress-fill" style="width:50%"></div></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;">
        <button onclick="goOb(1)" style="background:none;border:none;font-size:22px;color:var(--muted);cursor:pointer;">‚Äπ</button>
        <span style="font-size:13px;font-weight:600;color:var(--muted)">2 de 4</span>
        <button onclick="goOb(3)" style="background:none;border:none;font-family:inherit;font-size:13px;font-weight:600;color:var(--muted);cursor:pointer;">Omitir</button>
      </div>
    </div>
    <div style="flex:1;padding:20px 24px;overflow-y:auto;">
      <h2 style="font-size:22px;font-weight:800;margin-bottom:6px;">Tu tarjeta de cr√©dito</h2>
      <p style="font-size:14px;color:var(--muted);margin-bottom:24px;line-height:1.5;">Agrega tu tarjeta principal para que Lucas calcule tu ciclo correctamente.</p>
      <div class="form-field">
        <label class="form-label">Nombre de la tarjeta</label>
        <input type="text" id="ob2Name" class="form-input" placeholder="Ej: Visa Santander, CMR Falabella"/>
      </div>
      <div class="form-field">
        <label class="form-label">Tipo</label>
        <div class="pay-seg" style="grid-template-columns:1fr 1fr;">
          <button class="pay-btn active" id="obtype-credito" onclick="selectOBCardType('credito')">Cr√©dito</button>
          <button class="pay-btn" id="obtype-debito" onclick="selectOBCardType('debito')">D√©bito</button>
        </div>
      </div>
      <div id="obCreditFields">
        <!-- Visual cycle explainer ‚Äî Tenpo-style, simple & friendly -->
        <div style="margin-bottom:20px;">
          <p style="font-size:13px;font-weight:700;margin-bottom:10px;">¬øC√≥mo funciona el ciclo? üí≥</p>
          <!-- Timeline visual -->
          <div style="display:flex;flex-direction:column;gap:0;">
            <!-- Step 1 -->
            <div style="display:flex;gap:12px;align-items:flex-start;">
              <div style="display:flex;flex-direction:column;align-items:center;flex-shrink:0;">
                <div style="width:36px;height:36px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;">
                  <span style="font-size:16px;">üõí</span>
                </div>
                <div style="width:2px;flex:1;min-height:28px;background:var(--border);margin:4px 0;"></div>
              </div>
              <div style="padding:4px 0 16px;">
                <p style="font-size:13px;font-weight:700;">Compras durante el mes</p>
                <p style="font-size:12px;color:var(--muted);line-height:1.5;margin-top:2px;">Todo lo que gastas con la tarjeta queda registrado en tu cuenta.</p>
              </div>
            </div>
            <!-- Step 2 -->
            <div style="display:flex;gap:12px;align-items:flex-start;">
              <div style="display:flex;flex-direction:column;align-items:center;flex-shrink:0;">
                <div style="width:36px;height:36px;border-radius:50%;background:#7C3AED;display:flex;align-items:center;justify-content:center;">
                  <span style="font-size:16px;">‚úÇÔ∏è</span>
                </div>
                <div style="width:2px;flex:1;min-height:28px;background:var(--border);margin:4px 0;"></div>
              </div>
              <div style="padding:4px 0 16px;">
                <p style="font-size:13px;font-weight:700;">D√≠a de cierre</p>
                <p style="font-size:12px;color:var(--muted);line-height:1.5;margin-top:2px;">El banco "corta" el per√≠odo y suma todo lo que gastaste. Nada de lo que compres despu√©s queda en esta cuenta.</p>
              </div>
            </div>
            <!-- Step 3 -->
            <div style="display:flex;gap:12px;align-items:flex-start;">
              <div style="display:flex;flex-direction:column;align-items:center;flex-shrink:0;">
                <div style="width:36px;height:36px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;">
                  <span style="font-size:16px;">üí∏</span>
                </div>
              </div>
              <div style="padding:4px 0;">
                <p style="font-size:13px;font-weight:700;">D√≠a de vencimiento</p>
                <p style="font-size:12px;color:var(--muted);line-height:1.5;margin-top:2px;">Tienes hasta este d√≠a para pagar lo que debes. Si no pagas, el banco te cobra intereses.</p>
              </div>
            </div>
          </div>
          <!-- Example card -->
          <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:var(--radius-sm);padding:12px 14px;margin-top:14px;">
            <p style="font-size:11px;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">üìå Ejemplo real</p>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:12px;line-height:1.8;">
              <span style="background:var(--blue);color:white;border-radius:6px;padding:2px 8px;font-weight:700;">Cierre d√≠a 20</span>
              <span style="color:var(--muted);">‚Üí Compras del 21 ene al 20 feb</span>
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:12px;margin-top:4px;">
              <span style="background:var(--green);color:white;border-radius:6px;padding:2px 8px;font-weight:700;">Vence d√≠a 5</span>
              <span style="color:var(--muted);">‚Üí Pagar antes del 5 de marzo</span>
            </div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="form-field">
            <label class="form-label">D√≠a de cierre ‚úÇÔ∏è</label>
            <input type="number" id="ob2Close" class="form-input" placeholder="Ej: 20" min="1" max="31" inputmode="numeric" oninput="updateCyclePreview()"/>
            <p style="font-size:10px;color:var(--muted);margin-top:4px;">Cuando se "corta" tu cuenta</p>
          </div>
          <div class="form-field">
            <label class="form-label">D√≠a de vencimiento üí∏</label>
            <input type="number" id="ob2Due" class="form-input" placeholder="Ej: 5" min="1" max="31" inputmode="numeric" oninput="updateCyclePreview()"/>
            <p style="font-size:10px;color:var(--muted);margin-top:4px;">L√≠mite para pagar</p>
          </div>
        </div>
        <!-- Live preview updates as user types -->
        <div id="cyclePreview" style="display:none;background:var(--green-light);border:1.5px solid #6EE7B7;border-radius:var(--radius-sm);padding:12px 14px;">
          <p style="font-size:12px;font-weight:700;color:var(--green);">‚úì Tu ciclo quedar√° as√≠:</p>
          <p style="font-size:12px;color:#34D399;margin-top:4px;line-height:1.6;" id="cyclePreviewText"></p>
        </div>
      </div>
    </div>
    <div style="padding:0 24px 32px;">
      <button class="btn-primary" onclick="saveOBCard()">Continuar ‚Üí</button>
      <button class="btn-ghost" onclick="goOb(3)">Omitir por ahora</button>
    </div>
  </div>

  <!-- STEP 3: Ingresos recurrentes -->
  <div id="ob3" style="display:none;flex-direction:column;flex:1;overflow-y:auto;">
    <div style="padding:20px 24px 0;">
      <div class="progress-wrap"><div class="progress-fill" style="width:100%"></div></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;">
        <button onclick="goOb(2)" style="background:none;border:none;font-size:22px;color:var(--muted);cursor:pointer;">‚Äπ</button>
        <span style="font-size:13px;font-weight:600;color:var(--muted)">3 de 3</span>
        <div style="width:40px;"></div>
      </div>
    </div>
    <div style="flex:1;padding:20px 24px 32px;">
      <h2 style="font-size:22px;font-weight:800;margin-bottom:6px;">¬øCu√°nto recibes al mes? üí∞</h2>
      <p style="font-size:14px;color:var(--muted);margin-bottom:24px;line-height:1.5;">Tu ingreso mensual ayuda a Lucas a mostrarte cu√°nto porcentaje de tu sueldo has gastado.</p>
      <div class="form-field">
        <label class="form-label">Ingreso mensual neto (CLP)</label>
        <div style="display:flex;align-items:center;gap:8px;background:var(--bg);border:2px solid var(--blue);border-radius:var(--radius-sm);padding:14px 16px;">
          <span style="font-size:18px;font-weight:800;color:var(--blue)">$</span>
          <input type="number" id="ob3Income" placeholder="Ej: 1.800.000" style="flex:1;border:none;background:none;font-family:inherit;font-size:18px;font-weight:700;color:var(--text);outline:none;" inputmode="numeric"/>
        </div>
        <p style="font-size:11px;color:var(--muted);margin-top:5px;">Ingresa tu sueldo l√≠quido. Puedes cambiarlo en Ajustes.</p>
      </div>
      <div style="background:rgba(16,185,129,0.08);border:1.5px solid #86EFAC;border-radius:var(--radius-sm);padding:14px;margin-top:8px;">
        <p style="font-size:12px;font-weight:700;color:#34D399;margin-bottom:6px;">üìä Con esto Lucas puede mostrarte</p>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <p style="font-size:12px;color:#34D399;">‚úì Barra de progreso: gastaste X% del sueldo</p>
          <p style="font-size:12px;color:#34D399;">‚úì Balance mensual: ingresos menos gastos</p>
          <p style="font-size:12px;color:#34D399;">‚úì Alertas cuando te acercas al l√≠mite</p>
        </div>
      </div>
    </div>
    <div style="padding:0 24px 32px;">
      <button class="btn-primary" onclick="saveOBIncome()">¬°Comenzar! üöÄ</button>
      <button class="btn-ghost" onclick="finishOBDash()">Omitir e ir al dashboard</button>
    </div>
  </div>

  <!-- STEP 4: Primer gasto (onboarding completo) -->
  <div id="ob4" style="display:none;flex-direction:column;flex:1;">
    <div style="padding:20px 24px 0;">
      <div class="progress-wrap"><div class="progress-fill" style="width:100%"></div></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;">
        <button onclick="goOb(3)" style="background:none;border:none;font-size:22px;color:var(--muted);cursor:pointer;">‚Äπ</button>
        <span style="font-size:13px;font-weight:600;color:var(--muted)">4 de 4</span>
        <div style="width:40px;"></div>
      </div>
    </div>
    <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0 28px;text-align:center;">
      <div style="font-size:72px;margin-bottom:20px;">üéâ</div>
      <h2 style="font-size:26px;font-weight:800;margin-bottom:10px;">¬°Listo para empezar!</h2>
      <p style="font-size:14px;color:var(--muted);line-height:1.6;margin-bottom:32px;">Lucas est√° configurado. Registra tu primer gasto para ver el dashboard en acci√≥n.</p>
      <div style="background:var(--blue-light);border-radius:var(--radius);padding:16px;width:100%;text-align:left;margin-bottom:8px;">
        <p style="font-size:12px;font-weight:700;color:var(--blue);margin-bottom:4px;">üí° ¬øSab√≠as que...?</p>
        <p style="font-size:12px;color:var(--blue);line-height:1.5;">En "Consumo" ves el total de lo que gastaste. En "Por Pagar" ves solo la cuota de este per√≠odo de tu tarjeta. As√≠ nunca te confundes.</p>
      </div>
    </div>
    <div style="padding:0 24px 32px;">
      <button class="btn-primary" onclick="finishOB()">
        <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">add_circle</span>
        Registrar mi primer gasto
      </button>
      <button class="btn-ghost" onclick="finishOBDash()">Ir al dashboard primero</button>
    </div>
  </div>
</div><!-- /obScreen -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN APP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="mainApp" style="display:none;flex:1;flex-direction:column;overflow:hidden;padding-bottom:0;">

  <!-- ‚îÄ‚îÄ SCREEN: INICIO ‚Äî 2-block architecture ‚îÄ‚îÄ -->
  <div class="screen active" id="screenInicio">

    <div class="top-header" style="padding-bottom:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:38px;height:38px;border-radius:50%;background:var(--blue-light);display:flex;align-items:center;justify-content:center;">
            <span class="material-symbols-rounded" style="color:var(--blue);font-size:22px;font-variation-settings:'FILL' 1;">account_circle</span>
          </div>
          <div>
            <p style="font-size:11px;color:var(--muted);font-weight:600;" id="dashGreeting">Hola üëã</p>
            <h1 style="font-size:18px;font-weight:800;">Mi Resumen</h1>
          </div>
        </div>
        <button style="width:36px;height:36px;border-radius:50%;background:var(--card);border:none;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);cursor:pointer;">
          <span class="material-symbols-rounded" style="font-size:20px;color:var(--muted);">notifications</span>
        </button>
      </div>
      <!-- Month navigator -->
      <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-top:14px;">
        <button onclick="navigateMonth(-1)" style="width:30px;height:30px;border-radius:50%;background:var(--bg);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;">
          <span class="material-symbols-rounded" style="font-size:18px;color:var(--muted);">chevron_left</span>
        </button>
        <p id="dashMonthLabel" style="font-size:15px;font-weight:800;min-width:150px;text-align:center;"></p>
        <button onclick="navigateMonth(1)" id="nextMonthBtn" style="width:30px;height:30px;border-radius:50%;background:var(--bg);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:opacity 0.2s;">
          <span class="material-symbols-rounded" style="font-size:18px;color:var(--muted);">chevron_right</span>
        </button>
      </div>
    </div>

    <div style="padding:8px 20px 100px;display:flex;flex-direction:column;gap:14px;">

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           BLOQUE 1: CONSUMO DEL MES
           Per√≠odo: mes calendario
           Incluye: efectivo + d√©bito + cr√©dito
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div>
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
          <span class="material-symbols-rounded" style="font-size:14px;color:var(--muted);">calendar_today</span>
          <p style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em;">Bloque 1 ‚Äî Consumo del mes</p>
        </div>

        <!-- Main spend card -->
        <div class="balance-card" style="margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <div>
              <p style="font-size:11px;font-weight:700;opacity:0.8;letter-spacing:0.05em;text-transform:uppercase;">Total gastado</p>
              <div style="font-size:38px;font-weight:800;letter-spacing:-2px;margin:2px 0;" id="dashTotalGasto">$0</div>
            </div>
            <div style="text-align:right;">
              <p style="font-size:10px;font-weight:700;opacity:0.75;text-transform:uppercase;letter-spacing:0.05em;">Ingresos</p>
              <div style="font-size:18px;font-weight:800;color:rgba(255,255,255,0.85);margin-top:3px;" id="dashTotalIngreso">$0</div>
            </div>
          </div>
          <!-- Progress bar vs income -->
          <div style="margin-top:14px;">
            <div style="height:5px;background:rgba(255,255,255,0.18);border-radius:3px;overflow:hidden;">
              <div id="spendBar" style="height:100%;border-radius:3px;width:0%;transition:width 0.7s cubic-bezier(0.4,0,0.2,1);"></div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:5px;">
              <p style="font-size:10px;opacity:0.7;" id="spendBarLabel">del ingreso mensual</p>
              <div class="balance-badge" id="dashTransCount" style="font-size:10px;">
                <span class="material-symbols-rounded" style="font-size:13px;font-variation-settings:'FILL' 1;">receipt_long</span>
                <span>0 gastos</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Method breakdown: 3 cards -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
          <!-- Efectivo -->
          <div class="kpi-card" style="text-align:center;padding:12px 8px;">
            <div style="width:32px;height:32px;border-radius:9px;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;margin:0 auto 6px;">
              <span class="material-symbols-rounded" style="font-size:18px;color:var(--muted);font-variation-settings:'FILL' 1;">payments</span>
            </div>
            <div id="kpiEfectivo" style="font-size:15px;font-weight:800;color:var(--text);">$0</div>
            <p style="font-size:10px;color:var(--muted);margin-top:2px;font-weight:600;">Efectivo</p>
            <p style="font-size:9px;color:var(--muted);margin-top:1px;" id="kpiEfectivoSub">ya pagado</p>
          </div>
          <!-- D√©bito -->
          <div class="kpi-card" style="text-align:center;padding:12px 8px;">
            <div style="width:32px;height:32px;border-radius:9px;background:rgba(59,130,246,0.12);display:flex;align-items:center;justify-content:center;margin:0 auto 6px;">
              <span class="material-symbols-rounded" style="font-size:18px;color:var(--blue);font-variation-settings:'FILL' 1;">account_balance</span>
            </div>
            <div id="kpiDebito" style="font-size:15px;font-weight:800;color:var(--blue);">$0</div>
            <p style="font-size:10px;color:var(--muted);margin-top:2px;font-weight:600;">D√©bito</p>
            <p style="font-size:9px;color:var(--muted);margin-top:1px;">ya pagado</p>
          </div>
          <!-- Cr√©dito ‚Äî clickable, anchors to block 2 -->
          <div class="kpi-card" id="kpiCreditoCard" style="text-align:center;padding:12px 8px;cursor:pointer;border:1.5px solid #DDD6FE;transition:all 0.2s;" onclick="document.getElementById('block2').scrollIntoView({behavior:'smooth'})">
            <div style="width:32px;height:32px;border-radius:9px;background:rgba(139,92,246,0.2);display:flex;align-items:center;justify-content:center;margin:0 auto 6px;">
              <span class="material-symbols-rounded" style="font-size:18px;color:#A78BFA;font-variation-settings:'FILL' 1;">credit_card</span>
            </div>
            <div id="kpiCredito" style="font-size:15px;font-weight:800;color:#A78BFA;">$0</div>
            <p style="font-size:10px;color:#A78BFA;margin-top:2px;font-weight:700;">Cr√©dito</p>
            <p style="font-size:9px;color:#A78BFA;margin-top:1px;font-weight:600;">mes calendario ‚Üì</p>
          </div>
        </div>
      </div>

      <!-- PRESUPUESTO WIDGET -->
      <div id="budgetWidget"></div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           BLOQUE 2: LO QUE DEBES A TU TARJETA
           Per√≠odo: ciclo activo de cada tarjeta
           Incluye: solo cr√©dito
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div id="block2">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
          <span class="material-symbols-rounded" style="font-size:14px;color:#A78BFA;">credit_card</span>
          <p style="font-size:11px;font-weight:700;color:#A78BFA;text-transform:uppercase;letter-spacing:0.07em;">Bloque 2 ‚Äî Lo que debes a tu tarjeta</p>
        </div>
        <div id="porPagarModule"><!-- rendered by JS --></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           EN QU√â GAST√â ‚Äî donut por categor√≠a
           Basado en Bloque 1 (mes calendario)
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="card card-p">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
          <h2 class="section-title" style="margin:0;">En qu√© gast√©</h2>
          <button class="text-blue" style="font-size:12px;font-weight:700;background:none;border:none;cursor:pointer;" onclick="switchTab('movimientos')">Ver todo</button>
        </div>
        <div class="donut-wrap">
          <svg viewBox="0 0 80 80" width="80" height="80" id="donutSVG" style="flex-shrink:0;">
            <circle cx="40" cy="40" r="30" fill="none" stroke="#E2E8F0" stroke-width="14"/>
          </svg>
          <div class="cat-legend" id="catLegend">
            <p style="font-size:12px;color:var(--muted);">Agrega gastos para ver.</p>
          </div>
        </div>
      </div>

      <!-- PENDIENTES DE CORREO -->
      <div id="emailPendingWidget"></div>

      <!-- PENDIENTES RECURRENTES -->
      <div id="pendingRecurringWidget"></div>

      <!-- √öLTIMOS MOVIMIENTOS -->
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <h2 class="section-title" style="margin:0;">√öltimos movimientos</h2>
          <button class="text-blue" style="font-size:12px;font-weight:700;background:none;border:none;cursor:pointer;" onclick="switchTab('movimientos')">Ver todos</button>
        </div>
        <div id="recentTxns" style="display:flex;flex-direction:column;gap:8px;">
          <div style="text-align:center;padding:32px;color:var(--muted);font-size:14px;">No hay gastos a√∫n.<br/>¬°Registra tu primer gasto!</div>
        </div>
      </div>
    </div>
  </div><!-- /screenInicio -->

  <!-- ‚îÄ‚îÄ SCREEN: REGISTRAR ‚îÄ‚îÄ -->
  <div class="screen" id="screenRegistrar">
    <div class="top-header">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
        <div>
          <p style="font-size:13px;color:var(--muted);font-weight:600;">Mi Cuenta</p>
          <h1 style="font-size:22px;font-weight:800;">¬°Hola! üëã</h1>
          <p style="font-size:14px;color:var(--muted);margin-top:2px;">¬øQu√© gastaste hoy?</p>
        </div>
        <button style="width:36px;height:36px;border-radius:50%;background:var(--card);border:none;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);cursor:pointer;">
          <span class="material-symbols-rounded" style="font-size:20px;color:var(--muted);">notifications</span>
        </button>
      </div>
    </div>
    <div style="padding:8px 20px 80px;display:flex;flex-direction:column;gap:12px;">
      <div class="capture-primary" onclick="openCamera()">
        <div class="cap-icon" style="background:rgba(255,255,255,0.2);">
          <span class="material-symbols-rounded" style="font-size:28px;color:white;font-variation-settings:'FILL' 1;">photo_camera</span>
        </div>
        <div style="flex:1;">
          <div style="font-size:16px;font-weight:700;color:white;">Foto boleta</div>
          <div style="font-size:12px;color:rgba(255,255,255,0.75);margin-top:2px;">Captura el comprobante con tu c√°mara</div>
        </div>
        <span class="material-symbols-rounded" style="color:rgba(255,255,255,0.6);">chevron_right</span>
      </div>
      <div class="capture-card" onclick="openUpload()">
        <div class="cap-icon" style="background:var(--blue-light);">
          <span class="material-symbols-rounded" style="font-size:26px;color:var(--blue);font-variation-settings:'FILL' 1;">upload_file</span>
        </div>
        <div style="flex:1;">
          <div style="font-size:16px;font-weight:700;">Subir PDF/imagen</div>
          <div style="font-size:12px;color:var(--muted);margin-top:2px;">Importa desde galer√≠a o mail</div>
        </div>
        <span class="material-symbols-rounded" style="color:var(--muted);">chevron_right</span>
      </div>
      <div class="capture-card" onclick="openManual()">
        <div class="cap-icon" style="background:rgba(16,185,129,0.08);">
          <span class="material-symbols-rounded" style="font-size:26px;color:var(--green);font-variation-settings:'FILL' 1;">edit_note</span>
        </div>
        <div style="flex:1;">
          <div style="font-size:16px;font-weight:700;">Ingreso Manual</div>
          <div style="font-size:12px;color:var(--muted);margin-top:2px;">Escribe los detalles paso a paso</div>
        </div>
        <span class="material-symbols-rounded" style="color:var(--muted);">chevron_right</span>
      </div>
      <!-- Quick access -->
      <div>
        <p class="section-title">Accesos r√°pidos</p>
        <div style="display:flex;gap:10px;overflow-x:auto;padding-bottom:4px;">
          <button class="quick-chip" onclick="quickEntry('Supermercado','comida')"><span style="font-size:22px;">üõí</span><span style="font-size:11px;font-weight:600;color:var(--muted);">Super</span></button>
          <button class="quick-chip" onclick="quickEntry('Bencina','transporte')"><span style="font-size:22px;">‚õΩ</span><span style="font-size:11px;font-weight:600;color:var(--muted);">Bencina</span></button>
          <button class="quick-chip" onclick="quickEntry('Feria','comida')"><span style="font-size:22px;">üçé</span><span style="font-size:11px;font-weight:600;color:var(--muted);">Feria</span></button>
          <button class="quick-chip" onclick="quickEntry('Caf√©','comida')"><span style="font-size:22px;">‚òï</span><span style="font-size:11px;font-weight:600;color:var(--muted);">Caf√©</span></button>
          <button class="quick-chip" onclick="quickEntry('Micro/Metro','transporte')"><span style="font-size:22px;">üöå</span><span style="font-size:11px;font-weight:600;color:var(--muted);">Micro</span></button>
        </div>
      </div>
      <div class="tip-card">
        <span class="material-symbols-rounded">lightbulb</span>
        <p class="tip-text">Puedes subir fotos de tus boletas y las leeremos autom√°ticamente con IA.</p>
      </div>
    </div>
  </div><!-- /screenRegistrar -->

  <!-- ‚îÄ‚îÄ SCREEN: AJUSTES ‚îÄ‚îÄ -->
  <div class="screen" id="screenAjustes">
    <div style="padding:20px 20px 80px;">
      <h1 class="screen-title" style="margin-bottom:20px;">Configuraci√≥n</h1>
      <div class="profile-card" style="margin-bottom:24px;">
        <div style="width:52px;height:52px;border-radius:50%;background:var(--blue-light);display:flex;align-items:center;justify-content:center;">
          <span class="material-symbols-rounded" style="font-size:30px;color:var(--blue);font-variation-settings:'FILL' 1;">account_circle</span>
        </div>
        <div style="flex:1;">
          <p style="font-size:16px;font-weight:700;">Mi Cuenta</p>
          <p style="font-size:13px;color:var(--muted);" id="profileEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ff8a8c8a9e8d9690bf9a929e9693d19c9092">[email&#160;protected]</a></p>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <p class="lbl" style="padding:0 4px;margin-bottom:8px;">Finanzas</p>
        <div class="settings-group">
          <div class="settings-row" onclick="openModal('screenTarjetas')">
            <div class="s-icon" style="background:rgba(59,130,246,0.12);"><span class="material-symbols-rounded" style="font-size:18px;color:var(--blue);font-variation-settings:'FILL' 1;">credit_card</span></div>
            <div style="flex:1;"><div style="font-size:15px;font-weight:600;">Tarjetas y Cuentas</div><div style="font-size:12px;color:var(--muted)" id="cardsCount">0 tarjetas</div></div>
            <span class="material-symbols-rounded" style="color:var(--muted);font-size:20px;">chevron_right</span>
          </div>
          <div class="settings-row" onclick="openModal('screenBudgetConfig');renderBudgetConfig();">
            <div class="s-icon" style="background:rgba(245,158,11,0.12);"><span class="material-symbols-rounded" style="font-size:18px;color:#F59E0B;font-variation-settings:'FILL' 1;">savings</span></div>
            <div style="flex:1;"><div style="font-size:15px;font-weight:600;">Presupuesto Mensual</div><div style="font-size:12px;color:var(--muted);" id="budgetSettingsStatus">No configurado</div></div>
            <span class="material-symbols-rounded" style="color:var(--muted);font-size:20px;">chevron_right</span>
          </div>
          <div class="settings-row" onclick="editIncome()">
            <div class="s-icon" style="background:rgba(16,185,129,0.12);"><span class="material-symbols-rounded" style="font-size:18px;color:var(--green);font-variation-settings:'FILL' 1;">payments</span></div>
            <div style="flex:1;"><div style="font-size:15px;font-weight:600;">Ingreso Mensual</div><div style="font-size:12px;color:var(--muted)" id="incomeDisplay">No configurado</div></div>
            <span class="material-symbols-rounded" style="color:var(--muted);font-size:20px;">chevron_right</span>
          </div>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <p class="lbl" style="padding:0 4px;margin-bottom:8px;">Personalizaci√≥n</p>
        <div class="settings-group">
          <!-- ‚òÖ Categories manager -->
          <div class="settings-row" onclick="openModal('screenCatManager')">
            <div class="s-icon" style="background:rgba(245,158,11,0.12);"><span class="material-symbols-rounded" style="font-size:18px;color:#D97706;font-variation-settings:'FILL' 1;">category</span></div>
            <div style="flex:1;"><div style="font-size:15px;font-weight:600;">Gesti√≥n de Categor√≠as</div><div style="font-size:12px;color:var(--muted);" id="catCount">Agrega y edita categor√≠as</div></div>
            <span class="material-symbols-rounded" style="color:var(--muted);font-size:20px;">chevron_right</span>
          </div>
          <div class="settings-row">
            <div class="s-icon" style="background:rgba(139,92,246,0.12);"><span class="material-symbols-rounded" style="font-size:18px;color:#A78BFA;font-variation-settings:'FILL' 1;">visibility</span></div>
            <div style="flex:1;"><div style="font-size:15px;font-weight:600;">Vista Predeterminada</div><div style="font-size:12px;color:var(--muted);" id="defaultViewDisplay">Mes ¬∑ Consumo</div></div>
            <span class="material-symbols-rounded" style="color:var(--muted);font-size:20px;">chevron_right</span>
          </div>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <p class="lbl" style="padding:0 4px;margin-bottom:8px;">Datos y Seguridad</p>
        <div class="settings-group">
          <div class="settings-row" onclick="exportCSV()">
            <div class="s-icon" style="background:rgba(16,185,129,0.12);"><span class="material-symbols-rounded" style="font-size:18px;color:var(--green);font-variation-settings:'FILL' 1;">download</span></div>
            <div style="flex:1;"><div style="font-size:15px;font-weight:600;">Exportar CSV</div><div style="font-size:12px;color:var(--muted);">Descarga todos tus movimientos</div></div>
            <span class="material-symbols-rounded" style="color:var(--muted);font-size:20px;">chevron_right</span>
          </div>
          <div class="settings-row">
            <div class="s-icon" style="background:var(--red-light);"><span class="material-symbols-rounded" style="font-size:18px;color:var(--red);font-variation-settings:'FILL' 1;">lock</span></div>
            <div style="flex:1;"><div style="font-size:15px;font-weight:600;">Privacidad</div><div style="font-size:12px;color:var(--muted);">Sin claves bancarias ¬∑ Datos locales</div></div>
            <span class="material-symbols-rounded" style="color:var(--muted);font-size:20px;">chevron_right</span>
          </div>
        </div>
      </div>

      <div style="padding:8px 0 4px;">
        <button onclick="handleLogout()" style="width:100%;padding:16px;background:rgba(239,68,68,0.1);border:1.5px solid rgba(239,68,68,0.3);border-radius:14px;font-family:inherit;font-size:15px;font-weight:700;color:var(--red);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
          <span class="material-symbols-rounded" style="font-size:20px;">logout</span>
          Cerrar Sesi√≥n
        </button>
      </div>
      
      <!-- AUTOMATIZACI√ìN EMAIL -->
      <div style="margin-bottom:24px;">
        <p class="lbl" style="padding:0 4px;margin-bottom:8px;">Automatizaci√≥n</p>
        <div class="settings-group">
          <div style="padding:14px 16px;">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
              <div class="s-icon" style="background:rgba(59,130,246,0.12);flex-shrink:0;">
                <span class="material-symbols-rounded" style="font-size:18px;color:var(--blue);font-variation-settings:'FILL' 1;">forward_to_inbox</span>
              </div>
              <div style="flex:1;">
                <div style="font-size:15px;font-weight:600;">Reenv√≠o de correos</div>
                <div style="font-size:12px;color:var(--muted);" id="emailAutoStatus">No configurado</div>
              </div>
              <label class="toggle">
                <input type="checkbox" id="emailAutoToggle" onchange="toggleEmailAuto()"/>
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div id="emailAutoSetup" style="display:none;">
              <!-- Unique forwarding email -->
              <div style="background:#F0F9FF;border:1.5px solid #BAE6FD;border-radius:10px;padding:12px 14px;margin-bottom:12px;">
                <p style="font-size:11px;font-weight:700;color:#0369A1;margin-bottom:6px;">TU EMAIL DE LUKAS</p>
                <div style="display:flex;align-items:center;gap:8px;">
                  <p style="font-size:13px;font-weight:800;color:#0C4A6E;flex:1;word-break:break-all;" id="userForwardEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0468716f6577296061696b4468716f65772a657474">[email&#160;protected]</a></p>
                  <button onclick="copyForwardEmail()" style="background:var(--blue);border:none;border-radius:8px;padding:6px 12px;font-family:inherit;font-size:12px;font-weight:700;color:white;cursor:pointer;flex-shrink:0;">Copiar</button>
                </div>
              </div>
              <!-- Setup steps -->
              <p style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:8px;">C√≥mo configurar en Gmail:</p>
              <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
                <div style="display:flex;gap:8px;align-items:flex-start;">
                  <span style="background:var(--blue);color:white;border-radius:50%;width:18px;height:18px;font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;">1</span>
                  <p style="font-size:12px;color:var(--muted);line-height:1.5;">En Gmail ‚Üí Configuraci√≥n ‚Üí Filtros ‚Üí Crear filtro</p>
                </div>
                <div style="display:flex;gap:8px;align-items:flex-start;">
                  <span style="background:var(--blue);color:white;border-radius:50%;width:18px;height:18px;font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;">2</span>
                  <p style="font-size:12px;color:var(--muted);line-height:1.5;">En "De" escribe el email de notificaciones de tu banco (ej: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0e6f626b7c7a6f7d4e6c6d67206d62">[email&#160;protected]</a>)</p>
                </div>
                <div style="display:flex;gap:8px;align-items:flex-start;">
                  <span style="background:var(--blue);color:white;border-radius:50%;width:18px;height:18px;font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;">3</span>
                  <p style="font-size:12px;color:var(--muted);line-height:1.5;">Selecciona "Reenviar a" y pega tu email de Lukas</p>
                </div>
              </div>
              <!-- Add bank email -->
              <p style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:8px;">Emails de banco configurados:</p>
              <div id="bankEmailsList" style="margin-bottom:10px;display:flex;flex-direction:column;gap:6px;"></div>
              <div style="display:flex;gap:8px;">
                <input type="email" id="newBankEmail" placeholder="alertas@bci.cl"
                  style="flex:1;border:1.5px solid var(--border);border-radius:8px;padding:9px 12px;font-family:inherit;font-size:13px;"/>
                <button onclick="addBankEmail()" style="background:var(--blue);border:none;border-radius:8px;padding:9px 14px;font-family:inherit;font-size:13px;font-weight:700;color:white;cursor:pointer;flex-shrink:0;">+ Agregar</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- OCR API Key -->
      <div style="margin-bottom:16px;">
        <p class="lbl" style="padding:0 4px;margin-bottom:8px;">Inteligencia Artificial</p>
        <div class="settings-group">
          <div style="padding:14px 16px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <div class="s-icon" style="background:rgba(16,185,129,0.08);flex-shrink:0;"><span class="material-symbols-rounded" style="font-size:18px;color:#16A34A;font-variation-settings:'FILL' 1;">smart_toy</span></div>
              <div>
                <div style="font-size:15px;font-weight:600;">OpenAI API Key</div>
                <div style="font-size:12px;color:var(--green);">‚úì Activo ‚Äî GPT-4o en servidor</div>
              </div>
            </div>
            <div style="display:flex;gap:8px;">
              <input type="password" id="apiKeyInput" placeholder="sk-proj-..." 
                style="flex:1;border:1.5px solid var(--border);border-radius:8px;padding:10px 12px;font-family:inherit;font-size:13px;background:var(--bg);"
                oninput="updateApiKeyStatus()"/>
              <button onclick="saveApiKey()" style="background:var(--blue);border:none;border-radius:8px;padding:10px 16px;font-family:inherit;font-size:13px;font-weight:700;color:white;cursor:pointer;flex-shrink:0;">Guardar</button>
            </div>
            <p style="font-size:10px;color:var(--muted);margin-top:6px;">üîí Solo se guarda en tu dispositivo. Nunca sale a nuestros servidores.</p>
          </div>
        </div>
      </div>

      <!-- Demo tools -->
      <div style="margin:8px 0 4px;background:rgba(234,88,12,0.08);border:1px solid rgba(234,88,12,0.2);border-radius:var(--radius-sm);padding:12px 14px;">
        <p style="font-size:11px;font-weight:700;color:#C2410C;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">üóëÔ∏è Resetear datos</p>
        <button onclick="resetAllData()" style="width:100%;padding:12px;background:rgba(239,68,68,0.1);border:1.5px solid rgba(239,68,68,0.4);border-radius:10px;font-family:inherit;font-size:14px;font-weight:700;color:var(--red);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
          <span class="material-symbols-rounded" style="font-size:18px;font-variation-settings:'FILL' 1;">delete_forever</span>
          Borrar todos mis datos
        </button>
        <p style="font-size:11px;color:var(--muted);margin-top:6px;text-align:center;">Elimina gastos, tarjetas y presupuesto permanentemente</p>
      </div>
      
      <p style="text-align:center;font-size:11px;color:var(--muted);margin-top:6px;">Lucas v2.0 Demo</p>
    </div>
  </div><!-- /screenAjustes -->

  <!-- ‚îÄ‚îÄ TAB BAR ‚îÄ‚îÄ -->
  <!-- FAB ‚Äî floats above Ajustes tab -->
  <button id="fabBtn" onclick="openAddSheet()" style="
    position:fixed;
    bottom:calc(var(--tab-height) + var(--safe-bottom) + 12px);
    right:calc(50% - 215px + 12px);
    width:52px; height:52px;
    border-radius:16px;
    background:var(--blue);
    border:none;
    box-shadow:0 4px 16px rgba(37,99,235,0.45);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    z-index:190;
    transform:translateX(0);
  ">
    <span class="material-symbols-rounded" style="color:white;font-size:26px;font-variation-settings:'FILL' 1;">add</span>
  </button>

  <div id="tabbar">
    <button class="tab-btn active" id="tab-inicio" onclick="switchTab('inicio')">
      <span class="material-symbols-rounded ti">home</span>
      <span class="tl">Inicio</span>
    </button>
    <button class="tab-btn" id="tab-movimientos" onclick="switchTab('movimientos')">
      <span class="material-symbols-rounded ti">receipt_long</span>
      <span class="tl">Movimientos</span>
    </button>
    <button class="tab-btn" id="tab-ajustes" onclick="switchTab('ajustes')">
      <span class="material-symbols-rounded ti">settings</span>
      <span class="tl">Ajustes</span>
    </button>
  </div>

  <!-- ‚îÄ‚îÄ MODAL: MOVIMIENTOS ‚îÄ‚îÄ -->
  <div class="screen-modal" id="screenMovimientos">
    <div style="background:var(--card);padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <button class="back-btn" style="position:static;" onclick="closeModal('screenMovimientos')">
          <span class="material-symbols-rounded" style="font-size:20px;">chevron_left</span>Volver
        </button>
        <h1 style="font-size:18px;font-weight:800;">Movimientos</h1>
        <div style="width:70px;"></div>
      </div>
      <!-- Month navigation -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;background:rgba(255,255,255,0.05);border-radius:12px;padding:6px 8px;">
        <button onclick="movNavMonth(-1)" style="background:none;border:none;color:var(--text);cursor:pointer;padding:4px 8px;font-size:20px;line-height:1;">‚Äπ</button>
        <span id="movMonthLabel" style="font-size:14px;font-weight:700;text-transform:capitalize;"></span>
        <button onclick="movNavMonth(1)" style="background:none;border:none;color:var(--text);cursor:pointer;padding:4px 8px;font-size:20px;line-height:1;">‚Ä∫</button>
      </div>
      <div class="search-bar" style="margin-bottom:12px;">
        <span class="material-symbols-rounded" style="color:var(--muted);font-size:20px;">search</span>
        <input type="text" placeholder="Buscar..." id="searchInput" oninput="filterTxns()"/>
      </div>
      <!-- Gastos / Ingresos tabs -->
      <div style="display:flex;background:rgba(255,255,255,0.06);border-radius:10px;padding:4px;margin-bottom:10px;">
        <button id="movTabGastos" onclick="switchMovTab('gastos')"
          style="flex:1;padding:9px;border:none;border-radius:8px;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;background:var(--card);color:var(--blue);box-shadow:0 1px 6px rgba(0,0,0,0.3);">Gastos</button>
        <button id="movTabIngresos" onclick="switchMovTab('ingresos')"
          style="flex:1;padding:9px;border:none;border-radius:8px;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;background:transparent;color:var(--muted);">Ingresos</button>
      </div>
      <p id="movTabSummary" style="font-size:12px;color:var(--muted);margin:0 0 8px;text-align:right;"></p>
      <!-- Payment method filter -->
      <div style="display:flex;gap:6px;margin-bottom:8px;overflow-x:auto;-webkit-overflow-scrolling:touch;" id="payFilterChips">
        <div class="filter-chip active" onclick="setPayFilter('all',this)" style="white-space:nowrap;">Todos</div>
        <div class="filter-chip" onclick="setPayFilter('efectivo',this)" style="white-space:nowrap;">üíµ Efectivo</div>
        <div class="filter-chip" onclick="setPayFilter('debito',this)" style="white-space:nowrap;">üè¶ D√©bito</div>
        <div class="filter-chip" onclick="setPayFilter('tarjeta',this)" style="white-space:nowrap;">üí≥ Cr√©dito</div>
      </div>
      <div class="filter-chips" id="filterChips"></div>
    </div>
    <div style="flex:1;overflow-y:auto;padding-bottom:80px;" id="movimientosList"></div>
  </div>

  <!-- ‚îÄ‚îÄ MODAL: TARJETAS ‚îÄ‚îÄ -->
  <div class="screen-modal" id="screenTarjetas">
    <div class="back-header">
      <button class="back-btn" onclick="closeModal('screenTarjetas')"><span class="material-symbols-rounded" style="font-size:20px;">chevron_left</span>Volver</button>
      <span class="back-header-title">Mis Tarjetas</span>
      <button onclick="openAddCard()" style="background:none;border:none;color:var(--blue);font-family:inherit;font-size:20px;font-weight:300;cursor:pointer;line-height:1;">+</button>
    </div>
    <div style="flex:1;overflow-y:auto;display:flex;flex-direction:column;">
    <div style="padding:20px 16px 0;" id="cardsList"></div>
    <div style="padding:16px 16px 100px;">
      <button onclick="openAddCard()" style="width:100%;padding:14px;background:transparent;border:1.5px solid rgba(59,130,246,0.4);border-radius:14px;font-family:inherit;font-size:14px;font-weight:700;color:var(--blue);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.15s;" onmouseenter="this.style.background='rgba(59,130,246,0.08)'" onmouseleave="this.style.background='transparent'">
        <span class="material-symbols-rounded" style="font-size:20px;">add_card</span>
        Agregar tarjeta
      </button>
    </div>
  </div>
  </div>

  <!-- ‚îÄ‚îÄ CARD DETAIL SCREEN ‚îÄ‚îÄ -->
  <div class="screen-modal" id="screenCardDetail">
    <div class="back-header">
      <button class="back-btn" onclick="closeModal('screenCardDetail')"><span class="material-symbols-rounded" style="font-size:20px;">chevron_left</span>Tarjetas</button>
      <span class="back-header-title" id="cardDetailTitle">Detalle</span>
      <button onclick="openEditCard(currentDetailCardId)" style="background:none;border:none;color:var(--blue);font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;">Editar</button>
    </div>
    <div style="flex:1;overflow-y:auto;padding-bottom:100px;" id="cardDetailContent"></div>
  </div>

  <!-- ‚îÄ‚îÄ MODAL: CATEGORY MANAGER ‚îÄ‚îÄ -->
  <div class="screen-modal" id="screenCatManager">
    <div class="back-header">
      <button class="back-btn" onclick="closeModal('screenCatManager')"><span class="material-symbols-rounded" style="font-size:20px;">chevron_left</span>Volver</button>
      <span class="back-header-title">Categor√≠as</span>
      <button onclick="openAddCategory()" style="background:none;border:none;color:var(--blue);font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;">+ Nueva</button>
    </div>
    <div style="padding:16px 20px 100px;flex:1;overflow-y:auto;" id="catManagerList"></div>
  </div>

  <!-- ‚îÄ‚îÄ OVERLAY: INGRESO MANUAL ‚îÄ‚îÄ -->
  <div class="screen-overlay" id="screenManual">
    <div class="back-header">
      <button class="back-btn" onclick="closeOverlay('screenManual')"><span class="material-symbols-rounded" style="font-size:20px;">chevron_left</span>Cancelar</button>
      <span class="back-header-title">Nuevo Gasto</span>
      <div style="width:80px;"></div>
    </div>
    <div style="flex:1;overflow-y:auto;padding-bottom:100px;">
      <div class="amount-input-wrap">
        <span class="amount-prefix">$</span>
        <input type="number" class="amount-input" id="manualAmount" placeholder="0" inputmode="numeric"/>
      </div>
      <div style="padding:0 20px;">
        <div class="form-field">
          <label class="form-label" id="merchantFieldLabel">Comercio (opcional)</label>
          <input type="text" class="form-input" id="manualMerchant" placeholder="Ej: Jumbo, Copec, Netflix‚Ä¶"/>
        </div>
        <div class="form-field">
          <label class="form-label">Categor√≠a</label>
          <div class="cat-grid" id="manualCatGrid"></div>
        </div>
        <div id="payMethodSection" class="form-field">
          <label class="form-label">M√©todo de Pago</label>
          <div class="pay-seg">
            <button class="pay-btn active" id="pay-efectivo" onclick="selectPayMethod('efectivo')">Efectivo</button>
            <button class="pay-btn" id="pay-debito" onclick="selectPayMethod('debito')">D√©bito</button>
            <button class="pay-btn" id="pay-tarjeta" onclick="selectPayMethod('tarjeta')">Tarjeta Cr√©d.</button>
          </div>
          <div id="cardSelector" style="display:none;margin-top:10px;">
            <label class="form-label" id="cardSelectorLabel" style="margin-bottom:6px;">Selecciona tarjeta</label>
            <select class="form-select" id="manualCard"></select>
          </div>
        </div>
        <div id="cuotasSection" style="display:none;" class="form-field">
          <label class="form-label">¬øEn cuotas?</label>
          <div class="card card-p">
            <div class="toggle-row">
              <div><div style="font-size:15px;font-weight:600;">Pago en cuotas</div><div style="font-size:12px;color:var(--muted);">Divide este pago</div></div>
              <label class="toggle"><input type="checkbox" id="cuotasToggle" onchange="toggleCuotas()"/><span class="toggle-slider"></span></label>
            </div>
            <div id="cuotasInput" style="display:none;margin-top:12px;">
              <label class="form-label">N√∫mero de cuotas (2‚Äì24)</label>
              <input type="number" class="form-input" id="numCuotas" min="2" max="24" value="12" inputmode="numeric"/>
            </div>
          </div>
        </div>
        <div class="form-field">
          <div class="card card-p" style="margin:0;">
            <div class="toggle-row">
              <div>
                <div style="font-size:15px;font-weight:600;">Gasto recurrente</div>
                <div style="font-size:12px;color:var(--muted);">Se replica por 12 meses autom√°ticamente</div>
              </div>
              <label class="toggle"><input type="checkbox" id="recurringToggle"/><span class="toggle-slider"></span></label>
            </div>
          </div>
        </div>
        <div class="form-field">
          <label class="form-label">Fecha</label>
          <input type="date" class="form-input" id="manualDate"/>
        </div>
        <div class="form-field">
          <label class="form-label">Nota (opcional)</label>
          <input type="text" class="form-input" id="manualNote" placeholder="Agrega un comentario‚Ä¶"/>
        </div>
      </div>
    </div>
    <div class="sticky-footer">
      <button class="btn-primary" id="saveManualBtn" onclick="saveManual()">
        <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">save</span>
        Guardar Gasto
      </button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ OVERLAY: CAMERA ‚îÄ‚îÄ -->
  <div class="screen-overlay" id="screenCamera" style="background:#0F172A;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;">
      <button onclick="closeOverlay('screenCamera')" style="background:none;border:none;color:white;font-size:24px;cursor:pointer;">‚úï</button>
      <span style="font-size:17px;font-weight:700;color:white;">Escanear Boleta</span>
      <button style="background:none;border:none;color:white;cursor:pointer;"><span class="material-symbols-rounded" style="font-size:24px;">flash_off</span></button>
    </div>
    <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0 20px 20px;gap:20px;">
      <div style="position:relative;display:flex;align-items:center;justify-content:center;">
        <div class="camera-frame">
          <div class="corner c-tl"></div><div class="corner c-tr"></div>
          <div class="corner c-bl"></div><div class="corner c-br"></div>
          <p style="color:rgba(255,255,255,0.4);font-size:12px;text-align:center;margin-top:160px;">Centra tu boleta aqu√≠</p>
        </div>
      </div>
      <div style="background:rgba(255,255,255,0.08);border-radius:var(--radius);padding:16px;width:100%;">
        <p style="font-size:13px;font-weight:700;color:white;margin-bottom:10px;">Consejos para un buen escaneo</p>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;gap:10px;align-items:center;"><span style="font-size:18px;">‚òÄÔ∏è</span><p style="font-size:12px;color:rgba(255,255,255,0.7);">Buena iluminaci√≥n ‚Äî evita sombras</p></div>
          <div style="display:flex;gap:10px;align-items:center;"><span style="font-size:18px;">üìÑ</span><p style="font-size:12px;color:rgba(255,255,255,0.7);">Boleta plana y sin arrugas</p></div>
          <div style="display:flex;gap:10px;align-items:center;"><span style="font-size:18px;">üîç</span><p style="font-size:12px;color:rgba(255,255,255,0.7);">El monto total debe ser legible</p></div>
        </div>
      </div>
      <button class="btn-primary" onclick="triggerFile('camera')">Tomar foto</button>
    </div>
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;" onchange="processFile(this)"/>
  </div>

  <!-- ‚îÄ‚îÄ OVERLAY: UPLOAD ‚îÄ‚îÄ -->
  <div class="screen-overlay" id="screenUpload">
    <div class="back-header">
      <button class="back-btn" onclick="closeOverlay('screenUpload')"><span class="material-symbols-rounded" style="font-size:20px;">chevron_left</span>Cancelar</button>
      <span class="back-header-title">Subir Comprobante</span>
      <div style="width:80px;"></div>
    </div>
    <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;gap:20px;">
      <div style="width:90px;height:90px;background:var(--blue-light);border-radius:24px;display:flex;align-items:center;justify-content:center;">
        <span class="material-symbols-rounded" style="font-size:48px;color:var(--blue);font-variation-settings:'FILL' 1;">upload_file</span>
      </div>
      <div style="text-align:center;">
        <h2 style="font-size:20px;font-weight:800;margin-bottom:8px;">Subir desde galer√≠a o archivos</h2>
        <p style="font-size:14px;color:var(--muted);line-height:1.5;">Soporta im√°genes JPG, PNG y documentos PDF</p>
      </div>
      <button class="btn-primary" style="max-width:300px;" onclick="triggerFile('upload')">Seleccionar archivo</button>
    </div>
    <input type="file" id="uploadInput" accept="image/*,.pdf" style="display:none;" onchange="processFile(this)"/>
  </div>

  <!-- ‚îÄ‚îÄ OVERLAY: OCR PROCESSING ‚îÄ‚îÄ -->
  <div class="screen-overlay" id="screenOCR">
    <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:40px;">
      <div class="spinner"></div>
      <p id="ocrMessage" style="font-size:17px;font-weight:700;">Leyendo tu boleta‚Ä¶</p>
      <p id="ocrSubMessage" style="font-size:13px;color:var(--muted);text-align:center;">Analizando imagen con IA‚Ä¶</p>
      <button onclick="cancelOCR()" style="margin-top:12px;background:none;border:1.5px solid var(--border);border-radius:10px;padding:10px 28px;font-family:inherit;font-size:14px;font-weight:600;color:var(--muted);cursor:pointer;">Cancelar</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ OVERLAY: CONFIRM RECEIPT ‚îÄ‚îÄ -->
  <div class="screen-overlay" id="screenConfirm">
    <div class="back-header">
      <button class="back-btn" onclick="closeOverlay('screenConfirm')"><span class="material-symbols-rounded" style="font-size:20px;">chevron_left</span>Atr√°s</button>
      <span class="back-header-title">Verificar Boleta</span>
      <div style="width:80px;"></div>
    </div>
    <div style="flex:1;overflow-y:auto;padding:16px 20px 100px;">
      <div class="card card-p" style="margin-bottom:14px;display:flex;gap:12px;align-items:center;">
        <div id="receiptThumb" style="width:56px;height:56px;border-radius:8px;background:var(--bg);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;">
          <span class="material-symbols-rounded" style="font-size:28px;color:var(--muted);font-variation-settings:'FILL' 1;">receipt</span>
        </div>
        <div>
          <p style="font-size:14px;font-weight:700;">Boleta procesada</p>
          <p style="font-size:11px;color:var(--muted);" id="confirmTimestamp">Ahora</p>
          <button class="text-blue" style="font-size:12px;font-weight:700;background:none;border:none;cursor:pointer;">Ver completo</button>
        </div>
      </div>
      <div class="card card-p" style="margin-bottom:14px;">
        <div id="confidenceBadge" class="conf-badge conf-alta">
          <span class="material-symbols-rounded" style="font-size:16px;font-variation-settings:'FILL' 1;">verified</span>
          Confianza: Alta
        </div>
        <p style="font-size:12px;color:var(--muted);margin-top:6px;" id="confidenceText">La informaci√≥n fue extra√≠da correctamente</p>
      </div>
      <p class="lbl" style="margin-bottom:10px;">Detalles del Gasto</p>
      <div class="card card-p" style="margin-bottom:14px;display:flex;flex-direction:column;gap:14px;">
        <div>
          <label class="form-label">Comercio</label>
          <input type="text" class="form-input" id="confirmMerchant" placeholder="Nombre del comercio"/>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div><label class="form-label">Fecha</label><input type="date" class="form-input" id="confirmDate"/></div>
          <div><label class="form-label">Total CLP</label>
            <div style="position:relative;"><span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-weight:700;color:var(--muted);">$</span>
            <input type="number" class="form-input" id="confirmAmount" style="padding-left:28px;" inputmode="numeric"/></div>
          </div>
        </div>
        <div>
          <label class="form-label">Categor√≠a</label>
          <select class="form-select" id="confirmCategory"></select>
        </div>
        <div>
          <label class="form-label">Medio de Pago</label>
          <div class="pay-seg">
            <button class="pay-btn active" id="cpay-efectivo" onclick="selectConfirmPay('efectivo')">Efectivo</button>
            <button class="pay-btn" id="cpay-debito" onclick="selectConfirmPay('debito')">D√©bito</button>
            <button class="pay-btn" id="cpay-tarjeta" onclick="selectConfirmPay('tarjeta')">Cr√©dito</button>
          </div>
          <div id="confirmCardSelector" style="display:none;margin-top:10px;">
            <label class="form-label" id="confirmCardLabel">Tarjeta de cr√©dito</label>
            <select class="form-select" id="confirmCardSelect"></select>
          </div>
        </div>
        <div>
          <label class="form-label">Comentario (opcional)</label>
          <input type="text" class="form-input" id="confirmNote" placeholder="Ej: almuerzo de trabajo, regalo cumplea√±os‚Ä¶"/>
        </div>
      </div>
      <div class="card card-p" style="margin-bottom:14px;">
        <div class="toggle-row">
          <div><div style="font-size:15px;font-weight:600;">¬øEn cuotas?</div><div style="font-size:12px;color:var(--muted);">Activa si el pago es diferido</div></div>
          <label class="toggle"><input type="checkbox" id="confirmCuotasToggle" onchange="toggleConfirmCuotas()"/><span class="toggle-slider"></span></label>
        </div>
        <div id="confirmCuotasInput" style="display:none;margin-top:12px;">
          <label class="form-label">N¬∞ de cuotas</label>
          <input type="number" class="form-input" id="confirmNumCuotas" min="2" max="24" value="12" inputmode="numeric"/>
        </div>
      </div>
    </div>
    <div class="sticky-footer" style="display:flex;flex-direction:column;gap:8px;">
      <button class="btn-primary" onclick="saveConfirmed()">
        <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">save</span>Guardar Gasto
      </button>
      <button class="btn-ghost" onclick="closeOverlay('screenConfirm');openManual()">Ingresar manual en su lugar</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ OVERLAY: DETALLE ‚îÄ‚îÄ -->
  <div class="screen-overlay" id="screenDetalle">
    <div class="back-header">
      <button class="back-btn" onclick="closeOverlay('screenDetalle')"><span class="material-symbols-rounded" style="font-size:20px;">chevron_left</span>Atr√°s</button>
      <span class="back-header-title">Detalle</span>
      <div style="width:70px;"></div>
    </div>
    <div style="flex:1;overflow-y:auto;padding:20px;padding-bottom:130px;" id="detalleContent"></div>
    <div class="sticky-footer" style="display:flex;flex-direction:column;gap:8px;">
      <button class="btn-primary" onclick="saveDetalle()">Guardar cambios</button>
      <button class="btn-danger" onclick="deleteCurrentTxn()">
        <span class="material-symbols-rounded" style="font-size:18px;font-variation-settings:'FILL' 1;">delete</span>Eliminar movimiento
      </button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ OVERLAY: ADD CARD ‚îÄ‚îÄ -->
  <div class="screen-overlay" id="screenAddCard">
    <div class="back-header">
      <button class="back-btn" onclick="closeOverlay('screenAddCard')"><span class="material-symbols-rounded" style="font-size:20px;">chevron_left</span>Cancelar</button>
      <span class="back-header-title">Agregar Tarjeta</span>
      <div style="width:80px;"></div>
    </div>
    <div style="flex:1;padding:20px;overflow-y:auto;padding-bottom:100px;">

      <!-- Tip card -->
      <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);border-radius:12px;padding:12px 14px;margin-bottom:20px;display:flex;gap:10px;align-items:flex-start;">
        <span class="material-symbols-rounded" style="color:#F59E0B;font-size:20px;flex-shrink:0;margin-top:1px;">lightbulb</span>
        <p style="font-size:12px;color:#F59E0B;font-weight:600;line-height:1.6;">El d√≠a de cierre y vencimiento aparecen en tu estado de cuenta o en la app de tu banco. Si no los sabes, puedes agregarlos despu√©s.</p>
      </div>

      <!-- Quick bank selection -->
      <p class="form-label" style="margin-bottom:10px;">Selecci√≥n r√°pida de banco</p>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px;" id="bankChips">
        <button onclick="selectBank('Banco de Chile','#2563EB')" class="bank-chip">Banco de Chile</button>
        <button onclick="selectBank('BCI','#7C3AED')" class="bank-chip">BCI</button>
        <button onclick="selectBank('Santander','#EF4444')" class="bank-chip">Santander</button>
        <button onclick="selectBank('Scotiabank','#EF4444')" class="bank-chip">Scotiabank</button>
        <button onclick="selectBank('Falabella','#10B981')" class="bank-chip">Falabella</button>
        <button onclick="selectBank('Ita√∫','#F59E0B')" class="bank-chip">Ita√∫</button>
      </div>

      <div class="form-field"><label class="form-label">Nombre de la tarjeta</label><input type="text" class="form-input" id="newCardName" placeholder="Ej: Visa Santander"/></div>

      <div class="form-field"><label class="form-label">√öltimos 4 d√≠gitos (opcional)</label><input type="number" class="form-input" id="newCardLast4" placeholder="Ej: 4521" maxlength="4" inputmode="numeric"/></div>

      <div class="form-field">
        <label class="form-label">Tipo</label>
        <div class="pay-seg" style="grid-template-columns:1fr 1fr;">
          <button class="pay-btn active" id="cardtype-credito" onclick="selectCardType('credito')">Cr√©dito</button>
          <button class="pay-btn" id="cardtype-debito" onclick="selectCardType('debito')">D√©bito</button>
        </div>
      </div>

      <div id="creditCardFields">
        <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.15);border-radius:12px;padding:12px 14px;margin-bottom:18px;">
          <p style="font-size:12px;color:var(--blue);font-weight:600;line-height:1.6;">El ciclo va del d√≠a siguiente al cierre hasta el pr√≥ximo cierre. Todo lo consumido en ese per√≠odo se debe pagar antes del d√≠a de vencimiento.</p>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="form-field"><label class="form-label">D√≠a de cierre</label><input type="number" class="form-input" id="newCardClose" placeholder="Ej: 20" min="1" max="31" inputmode="numeric"/></div>
          <div class="form-field"><label class="form-label">D√≠a de vencimiento</label><input type="number" class="form-input" id="newCardDue" placeholder="Ej: 5" min="1" max="31" inputmode="numeric"/></div>
        </div>
      </div>

      <div class="form-field">
        <label class="form-label">Color de la tarjeta</label>
        <div style="display:flex;gap:12px;margin-top:4px;">
          <div class="color-pick" data-c="#2563EB" onclick="pickColor('#2563EB')" style="width:36px;height:36px;border-radius:50%;background:#2563EB;cursor:pointer;border:3px solid #000;box-shadow:0 0 0 2px white inset;"></div>
          <div class="color-pick" data-c="#7C3AED" onclick="pickColor('#7C3AED')" style="width:36px;height:36px;border-radius:50%;background:#7C3AED;cursor:pointer;border:3px solid transparent;"></div>
          <div class="color-pick" data-c="#10B981" onclick="pickColor('#10B981')" style="width:36px;height:36px;border-radius:50%;background:#10B981;cursor:pointer;border:3px solid transparent;"></div>
          <div class="color-pick" data-c="#EF4444" onclick="pickColor('#EF4444')" style="width:36px;height:36px;border-radius:50%;background:#EF4444;cursor:pointer;border:3px solid transparent;"></div>
          <div class="color-pick" data-c="#F59E0B" onclick="pickColor('#F59E0B')" style="width:36px;height:36px;border-radius:50%;background:#F59E0B;cursor:pointer;border:3px solid transparent;"></div>
          <div class="color-pick" data-c="#EC4899" onclick="pickColor('#EC4899')" style="width:36px;height:36px;border-radius:50%;background:#EC4899;cursor:pointer;border:3px solid transparent;"></div>
        </div>
      </div>
    </div>
    <div class="sticky-footer"><button class="btn-primary" onclick="saveCard()">Agregar tarjeta</button></div>
  </div>

  <!-- ‚îÄ‚îÄ OVERLAY: ADD CATEGORY ‚îÄ‚îÄ -->
  <div class="screen-overlay" id="screenAddCat">
    <div class="back-header">
      <button class="back-btn" onclick="closeOverlay('screenAddCat')"><span class="material-symbols-rounded" style="font-size:20px;">chevron_left</span>Cancelar</button>
      <span class="back-header-title">Nueva Categor√≠a</span>
      <div style="width:80px;"></div>
    </div>
    <div style="flex:1;padding:20px;overflow-y:auto;">
      <div class="form-field"><label class="form-label">Nombre</label><input type="text" class="form-input" id="newCatName" placeholder="Ej: Deporte, Mascota, Inversiones‚Ä¶"/></div>
      <div class="form-field">
        <label class="form-label">√çcono</label>
        <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;" id="iconPicker">
          <!-- filled dynamically -->
        </div>
      </div>
      <div class="form-field">
        <label class="form-label">Color</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap;" id="catColorPicker">
          <div class="catcolor-pick" data-c="#2563EB" onclick="pickCatColor('#2563EB')" style="width:32px;height:32px;border-radius:50%;background:#2563EB;cursor:pointer;border:3px solid #2563EB;"></div>
          <div class="catcolor-pick" data-c="#10B981" onclick="pickCatColor('#10B981')" style="width:32px;height:32px;border-radius:50%;background:#10B981;cursor:pointer;border:3px solid transparent;"></div>
          <div class="catcolor-pick" data-c="#EF4444" onclick="pickCatColor('#EF4444')" style="width:32px;height:32px;border-radius:50%;background:#EF4444;cursor:pointer;border:3px solid transparent;"></div>
          <div class="catcolor-pick" data-c="#F59E0B" onclick="pickCatColor('#F59E0B')" style="width:32px;height:32px;border-radius:50%;background:#F59E0B;cursor:pointer;border:3px solid transparent;"></div>
          <div class="catcolor-pick" data-c="#8B5CF6" onclick="pickCatColor('#8B5CF6')" style="width:32px;height:32px;border-radius:50%;background:#8B5CF6;cursor:pointer;border:3px solid transparent;"></div>
          <div class="catcolor-pick" data-c="#EC4899" onclick="pickCatColor('#EC4899')" style="width:32px;height:32px;border-radius:50%;background:#EC4899;cursor:pointer;border:3px solid transparent;"></div>
          <div class="catcolor-pick" data-c="#14B8A6" onclick="pickCatColor('#14B8A6')" style="width:32px;height:32px;border-radius:50%;background:#14B8A6;cursor:pointer;border:3px solid transparent;"></div>
          <div class="catcolor-pick" data-c="#64748B" onclick="pickCatColor('#64748B')" style="width:32px;height:32px;border-radius:50%;background:#64748B;cursor:pointer;border:3px solid transparent;"></div>
        </div>
      </div>
    </div>
    <div class="sticky-footer"><button class="btn-primary" onclick="saveNewCat()">Crear Categor√≠a</button></div>
  </div>


  <!-- ‚îÄ‚îÄ EDIT CARD OVERLAY ‚îÄ‚îÄ -->
  <div class="screen-overlay" id="screenEditCard">
    <div class="back-header">
      <button class="back-btn" onclick="closeOverlay('screenEditCard')"><span class="material-symbols-rounded" style="font-size:20px;">chevron_left</span>Cancelar</button>
      <span class="back-header-title">Editar Tarjeta</span>
      <div style="width:80px;"></div>
    </div>
    <div style="flex:1;padding:20px;overflow-y:auto;padding-bottom:120px;" id="editCardForm"></div>
    <div class="sticky-footer" style="display:flex;flex-direction:column;gap:8px;">
      <button class="btn-primary" onclick="saveEditCard()">
        <span class="material-symbols-rounded" style="font-size:18px;font-variation-settings:'FILL' 1;vertical-align:-4px;margin-right:6px;">save</span>
        Guardar cambios
      </button>
      <button onclick="confirmDeleteCard()" style="width:100%;padding:14px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:14px;font-family:inherit;font-size:15px;font-weight:700;color:var(--red);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
        <span class="material-symbols-rounded" style="font-size:18px;font-variation-settings:'FILL' 1;">delete</span>
        Eliminar tarjeta
      </button>
    </div>
  </div>


  <!-- ‚îÄ‚îÄ MODAL: BUDGET DETAIL ‚îÄ‚îÄ -->
  <div class="screen-modal" id="screenBudgetDetail">
    <div class="back-header">
      <button class="back-btn" onclick="closeModal('screenBudgetDetail')"><span class="material-symbols-rounded" style="font-size:20px;">chevron_left</span>Volver</button>
      <span class="back-header-title">Presupuesto</span>
      <button onclick="openModal('screenBudgetConfig')" style="background:none;border:none;color:var(--blue);font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;">Editar</button>
    </div>
    <div style="flex:1;overflow-y:auto;padding:16px 20px 100px;" id="budgetDetailContent"></div>
  </div>

  <!-- ‚îÄ‚îÄ MODAL: BUDGET CONFIG ‚îÄ‚îÄ -->
  <div class="screen-modal" id="screenBudgetConfig">
    <div class="back-header">
      <button class="back-btn" onclick="closeModal('screenBudgetConfig')"><span class="material-symbols-rounded" style="font-size:20px;">chevron_left</span>Cancelar</button>
      <span class="back-header-title">Configurar Presupuesto</span>
      <div style="width:80px;"></div>
    </div>
    <div style="flex:1;overflow-y:auto;padding:16px 20px 200px;" id="budgetConfigContent"></div>
    <div class="sticky-footer" style="display:flex;flex-direction:column;gap:8px;">
      <button class="btn-primary" onclick="saveBudget()">
        <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;font-size:18px;vertical-align:-3px;margin-right:4px;">save</span>
        Guardar presupuesto
      </button>
      <button onclick="copyLastMonthBudget()" style="background:none;border:none;color:var(--blue);font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;padding:8px;">Copiar del mes anterior</button>
    </div>
  </div>

</div><!-- /mainApp -->
</div><!-- /app -->

<div class="toast" id="toast"></div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE + DATA LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://jluxeblunprmwibdwtml.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsdXhlYmx1bnBybXdpYmR3dG1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTAyMzUsImV4cCI6MjA4NzQyNjIzNX0.0Czfp1WagmnJMAM7YHDKaVsOApvJKGB1c2Us__3Y3tc';
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
  auth: { persistSession: true, storageKey: 'lucas-auth-token', storage: window.localStorage, autoRefreshToken: true }
});
const STORE = {};
let CURRENT_USER = null;
const DB = {
  get: (k, d) => { return (k in STORE) ? JSON.parse(JSON.stringify(STORE[k])) : d; },
  set: (k, v) => { STORE[k] = JSON.parse(JSON.stringify(v)); }
};

const SB = {
  async signUp(email, pw) { const {data,error} = await supa.auth.signUp({email,password:pw}); if(error) throw error; return data; },
  async signIn(email, pw) { const {data,error} = await supa.auth.signInWithPassword({email,password:pw}); if(error) throw error; CURRENT_USER=data.user; return data; },
  async signOut() { await supa.auth.signOut(); CURRENT_USER=null; Object.keys(STORE).forEach(k=>delete STORE[k]); },
  async loadSettings() {
    if(!CURRENT_USER) return;
    const {data} = await supa.from('user_settings').select('*').eq('user_id',CURRENT_USER.id).single();
    if(data) DB.set('settings',{income:data.income,period:data.period,view:data.view,onboarded:data.onboarded});
  },
  async saveSettings(s) {
    if(!CURRENT_USER) return;
    await supa.from('user_settings').upsert({user_id:CURRENT_USER.id,income:s.income||0,period:s.period||'mes',view:s.view||'consumo',onboarded:s.onboarded||false,updated_at:new Date().toISOString()},{onConflict:'user_id'});
  },
  async loadCards() {
    if(!CURRENT_USER) return;
    const {data} = await supa.from('cards').select('*').eq('user_id',CURRENT_USER.id).order('created_at');
    if(data) DB.set('cards',data.map(c=>{return {id:c.id,name:c.name,type:c.type,closeDay:c.close_day,dueDay:c.due_day,color:c.color}}) );
  },
  async saveCard(card) {
    if(!CURRENT_USER) return card;
    const row={user_id:CURRENT_USER.id,name:card.name,type:card.type,close_day:card.closeDay,due_day:card.dueDay,color:card.color};
    const isNew = !card.id || card.id.toString().startsWith('card_') || card.id.toString().length < 30;
    if(!isNew) { await supa.from('cards').update(row).eq('id',card.id); return card; }
    const {data} = await supa.from('cards').insert(row).select().single();
    return data ? {...card,id:data.id} : card;
  },
  async deleteCard(id) { if(!CURRENT_USER) return; await supa.from('cards').delete().eq('id',id).eq('user_id',CURRENT_USER.id); },
  async loadTransactions() {
    if(!CURRENT_USER) return;
    const {data} = await supa.from('transactions').select('*').eq('user_id',CURRENT_USER.id).order('date',{ascending:false}).limit(500);
    if(data) DB.set('transactions',data.map(t=>{return {id:t.id,type:t.type,amount:t.amount,merchant:t.merchant,category:t.category,payMethod:t.pay_method,cardId:t.card_id,date:t.date,purchaseDate:t.purchase_date,cuotas:t.cuotas,cuotaNum:t.cuota_num,installmentAmt:t.installment_amt,planId:t.plan_id,note:t.note,source:t.source,recurring:t.recurring,receiptUrl:t.receipt_url,createdAt:t.created_at}}));
  },
  async saveTxns(txns) {
    if(!CURRENT_USER) return txns;
    const rows=txns.map(t=>{return {user_id:CURRENT_USER.id,type:t.type,amount:t.amount,merchant:t.merchant||null,category:t.category||null,pay_method:t.payMethod||null,card_id:t.cardId||null,date:t.date,purchase_date:t.purchaseDate||t.date,cuotas:t.cuotas||1,cuota_num:t.cuotaNum||1,installment_amt:t.installmentAmt||null,plan_id:t.planId||null,note:t.note||null,source:t.source||'manual',recurring:t.recurring||false,receipt_url:t.receiptUrl||null}});
    const {data,error} = await supa.from('transactions').insert(rows).select();
    if(error) throw error;
    return (data||[]).map((t,i)=>{return {...txns[i],id:t.id}});
  },
  async updateTxn(id,fields) {
    if(!CURRENT_USER) return;
    const row={};
    if(fields.merchant!==undefined) row.merchant=fields.merchant;
    if(fields.amount!==undefined) row.amount=fields.amount;
    if(fields.category!==undefined) row.category=fields.category;
    if(fields.date!==undefined) row.date=fields.date;
    if(fields.note!==undefined) row.note=fields.note;
    if(fields.recurring!==undefined) row.recurring=fields.recurring;
    if(fields.receiptUrl!==undefined) row.receipt_url=fields.receiptUrl;
    await supa.from('transactions').update(row).eq('id',id).eq('user_id',CURRENT_USER.id);
  },
  async deleteTxn(id) { if(!CURRENT_USER) return; await supa.from('transactions').delete().eq('id',id).eq('user_id',CURRENT_USER.id); },
  async deletePlan(planId) { if(!CURRENT_USER) return; await supa.from('transactions').delete().eq('plan_id',planId).eq('user_id',CURRENT_USER.id); },
  async uploadReceipt(dataUrl,txnId) {
    if(!CURRENT_USER||!dataUrl) return null;
    try {
      const base64=dataUrl.split(',')[1];
      const bytes=Uint8Array.from(atob(base64),c=>c.charCodeAt(0));
      const path=CURRENT_USER.id+'/'+txnId+'.jpg';
      const {error}=await supa.storage.from('receipts').upload(path,bytes,{contentType:'image/jpeg',upsert:true});
      if(error) return null;
      const {data}=supa.storage.from('receipts').getPublicUrl(path);
      return data?.publicUrl||null;
    } catch(e){return null;}
  },
  async loadAll() {
    // Clear any demo data before loading real data from server
    const existingTxns = DB.get('transactions', []);
    const hasDemoData = existingTxns.some(t => t.id && String(t.id).startsWith('demo_'));
    if (hasDemoData) { DB.set('transactions', []); DB.set('cards', []); }
    await Promise.all([SB.loadSettings(),SB.loadCards(),SB.loadTransactions()]);
    await loadPendingFromSB();
  }
};

// ‚îÄ‚îÄ DEFAULT CATEGORIES (system + expanded) ‚îÄ‚îÄ
const SYS_CATS = [
  { id:'comida',       name:'Comida',       icon:'restaurant',       color:'#10B981', emoji:'üçΩÔ∏è', system:true },
  { id:'transporte',   name:'Transporte',   icon:'directions_car',   color:'#3B82F6', emoji:'üöó', system:true },
  { id:'compras',      name:'Compras',      icon:'shopping_bag',     color:'#8B5CF6', emoji:'üõçÔ∏è', system:true },
  { id:'salud',        name:'Salud',        icon:'medical_services', color:'#EF4444', emoji:'üíä', system:true },
  { id:'servicios',    name:'Servicios',    icon:'bolt',             color:'#F59E0B', emoji:'üí°', system:true },
  { id:'ocio',         name:'Ocio',         icon:'celebration',      color:'#EC4899', emoji:'üé≠', system:true },
  { id:'deporte',      name:'Deporte',      icon:'sports_soccer',    color:'#14B8A6', emoji:'‚öΩ', system:true },
  { id:'transferencia',name:'Transferencia',icon:'send_money',       color:'#6366F1', emoji:'üí∏', system:true },
  { id:'inversiones',  name:'Inversiones',  icon:'trending_up',      color:'#0EA5E9', emoji:'üìà', system:true },
  { id:'otros',        name:'Otros',        icon:'more_horiz',       color:'#64748B', emoji:'üì¶', system:true },
];

const ICON_OPTIONS = ['restaurant','directions_car','shopping_bag','medical_services','bolt','celebration','sports_soccer','send_money','trending_up','home','pets','school','flight','fitness_center','music_note','coffee','local_pharmacy','theater_comedy','savings','work'];

function getAllCats() {
  const custom = DB.get('customCats', []);
  return [...SYS_CATS, ...custom];
}
function getCat(id) { return getAllCats().find(c => c.id === id) || SYS_CATS[SYS_CATS.length-1]; }

// ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ
function clp(n) { return '$' + Math.abs(Math.round(n)).toLocaleString('es-CL'); }
function today() { return new Date().toISOString().split('T')[0]; }
function formatDate(s) {
  const d = new Date(s + 'T12:00:00'), now = new Date();
  const diff = Math.floor((now - d) / 86400000);
  if (diff === 0) return 'Hoy';
  if (diff === 1) return 'Ayer';
  return d.toLocaleDateString('es-CL', { day:'numeric', month:'long' });
}
function fullDate(s) {
  const d = new Date(s + 'T12:00:00');
  return d.toLocaleDateString('es-CL', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BILLING CYCLE ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
/*
  Rules (confirmed with user):
  - closeDay = 20 ‚Üí period = day 21 of prev month ‚Üí day 20 of current month
  - dueDay = 5 ‚Üí must pay by day 5 of month AFTER closing
  
  Given a transaction date, find which cycle it belongs to.
  Given today, find the active cycle (the one not yet paid).
*/
function getCycleForDate(txnDate, closeDay) {
  const d = new Date(txnDate + 'T12:00:00');
  const day = d.getDate(), month = d.getMonth(), year = d.getFullYear();

  let cycleEndMonth, cycleEndYear;
  if (day <= closeDay) {
    // Belongs to cycle closing THIS month
    cycleEndMonth = month;
    cycleEndYear = year;
  } else {
    // Belongs to cycle closing NEXT month
    cycleEndMonth = month + 1;
    cycleEndYear = year;
    if (cycleEndMonth > 11) { cycleEndMonth = 0; cycleEndYear++; }
  }

  // Cycle start = day after closeDay of the PREVIOUS month
  let cycleStartMonth = cycleEndMonth - 1;
  let cycleStartYear = cycleEndYear;
  if (cycleStartMonth < 0) { cycleStartMonth = 11; cycleStartYear--; }

  const startDay = closeDay + 1;
  // Handle months shorter than closeDay
  const daysInStartMonth = new Date(cycleStartYear, cycleStartMonth + 1, 0).getDate();
  const actualStartDay = Math.min(startDay, daysInStartMonth);

  return {
    start: new Date(cycleStartYear, cycleStartMonth, actualStartDay),
    end: new Date(cycleEndYear, cycleEndMonth, closeDay),
    label: new Date(cycleEndYear, cycleEndMonth, 1).toLocaleDateString('es-CL', { month:'long', year:'numeric' }),
  };
}

function getActiveCycle(closeDay, dueDay) {
  const now = new Date();
  // The active (unpaid) cycle: closes on closeDay of current or next month
  const cycle = getCycleForDate(today(), closeDay);
  
  // Due date: dueDay of month AFTER cycle end
  const dueMonth = cycle.end.getMonth() + 1;
  const dueYear = dueMonth > 11 ? cycle.end.getFullYear() + 1 : cycle.end.getFullYear();
  const actualDueMonth = dueMonth > 11 ? 0 : dueMonth;
  const dueDate = new Date(dueYear, actualDueMonth, dueDay);

  return { ...cycle, dueDate };
}

function txnInCycle(txnDate, closeDay) {
  const cycle = getCycleForDate(txnDate, closeDay);
  const activeCycle = getActiveCycle(closeDay, 5);
  // Compare cycle end dates to see if txn is in active cycle
  return cycle.end.getTime() === activeCycle.end.getTime();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ONBOARDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let obPrefs = { period:'mes', view:'consumo' };
let obCardType = 'credito';

function goOb(step) {
  [1,2,3,4].forEach(i => {
    const el = document.getElementById('ob'+i);
    if (el) el.style.display = i === step ? 'flex' : 'none';
  });
}
function selectOBCardType(t) {
  obCardType = t;
  document.getElementById('obtype-credito').classList.toggle('active', t==='credito');
  document.getElementById('obtype-debito').classList.toggle('active', t==='debito');
  document.getElementById('obCreditFields').style.display = t==='credito' ? 'block' : 'none';
}
function selectOBPref(type, val) {
  obPrefs[type] = val;
  if (type === 'period') {
    document.getElementById('obp-mes').classList.toggle('selected', val==='mes');
    document.getElementById('obp-ciclo').classList.toggle('selected', val==='ciclo');
  } else {
    document.getElementById('obv-consumo').classList.toggle('selected', val==='consumo');
    document.getElementById('obv-porpagar').classList.toggle('selected', val==='porpagar');
  }
}
function saveOBCard() {
  const name = document.getElementById('ob2Name').value.trim();
  const close = parseInt(document.getElementById('ob2Close').value);
  const due = parseInt(document.getElementById('ob2Due').value);
  if (name && close && due) {
    const cards = DB.get('cards', []);
    cards.push({ id: Date.now(), name, type: obCardType, closeDay: close, dueDay: due, color:'#2563EB' });
    DB.set('cards', cards);
  }
  goOb(3);
}
function skipOB() { finishOBDash(); }
function saveOBIncome() {
  const inc = parseInt(document.getElementById('ob3Income').value) || 0;
  const s = DB.get('settings', {});
  if (inc > 0) s.income = inc;
  s.onboarded = true; s.period = 'mes'; s.view = 'consumo';
  DB.set('settings', s);
  document.getElementById('obScreen').style.display = 'none';
  startApp();
}
function collectOBIncome() {
  // Try ob3Income first (new step), fallback to ob1Income (welcome step)
  const v3 = parseInt(document.getElementById('ob3Income')?.value) || 0;
  const v1 = parseInt(document.getElementById('ob1Income')?.value) || 0;
  return v3 || v1;
}
async function finishOB() {
  const income = collectOBIncome();
  const s = DB.get('settings', {});
  const ns={...s,income,period:'mes',view:'consumo',onboarded:true}; DB.set('settings',ns);
  try{await SB.saveSettings(ns);}catch(e){}
  document.getElementById('obScreen').style.display = 'none';
  startApp();
  openOverlay('screenManual');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentPeriod = 'mes';  // kept for backward compat but dashboard is now always "mes"
let currentView = 'consumo'; // kept for compat
let selectedCardId = null;
// Month navigation: offset from current month (0 = this month, -1 = last month, etc.)
let dashMonthOffset = 0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let authMode = 'login';
function switchAuthTab(mode) {
  authMode = mode;
  const isLogin = mode==='login';
  const tl=document.getElementById('authTabLogin'), tr=document.getElementById('authTabRegister');
  tl.style.background=isLogin?'white':'transparent'; tl.style.color=isLogin?'#2563EB':'#64748B'; tl.style.boxShadow=isLogin?'0 1px 3px rgba(0,0,0,0.1)':'none';
  tr.style.background=!isLogin?'white':'transparent'; tr.style.color=!isLogin?'#2563EB':'#64748B'; tr.style.boxShadow=!isLogin?'0 1px 3px rgba(0,0,0,0.1)':'none';
  document.getElementById('authSubmitBtn').textContent=isLogin?'Ingresar':'Crear cuenta';
}
async function submitAuth() {
  const email=document.getElementById('authEmail').value.trim();
  const password=document.getElementById('authPassword').value;
  const errEl=document.getElementById('authError');
  const btn=document.getElementById('authSubmitBtn');
  errEl.style.display='none';
  if(!email||!password){errEl.textContent='Completa email y contrase√±a';errEl.style.display='block';return;}
  if(password.length<6){errEl.textContent='La contrase√±a debe tener al menos 6 caracteres';errEl.style.display='block';return;}
  btn.textContent=authMode==='login'?'Ingresando‚Ä¶':'Creando cuenta‚Ä¶'; btn.disabled=true;
  try {
    if(authMode==='login') { await SB.signIn(email,password); }
    else { await SB.signUp(email,password); await SB.signIn(email,password); }
    await onAuthSuccess();
  } catch(err) {
    const msg=err.message||'Error';
    errEl.textContent=msg.includes('Invalid')?'Email o contrase√±a incorrectos':msg.includes('already')?'Este email ya tiene cuenta ‚Äî usa Ingresar':msg;
    errEl.style.display='block';
    btn.textContent=authMode==='login'?'Ingresar':'Crear cuenta'; btn.disabled=false;
  }
}
async function onAuthSuccess() {
  await SB.loadAll();
  await loadBudgetFromSB();
  document.getElementById('authScreen').style.display='none';
  // Don't load demo data after login ‚Äî SB data takes precedence
  // loadDemoData(); // intentionally disabled
  const s=DB.get('settings',{});
  if(!s.onboarded){ document.getElementById('obScreen').style.display='flex'; }
  else { startApp(); }
}
async function handleLogout() {
  if (!confirm('¬øCerrar sesi√≥n? Tus datos est√°n guardados en la nube.')) return;
  try { await SB.signOut(); } catch(e) {}
  CURRENT_USER = null;
  // Only clear auth token, keep local data cache for next login
  localStorage.removeItem('lucas-auth-token');
  localStorage.removeItem('supabase.auth.token');
  // Reset UI
  document.getElementById('authScreen').style.display='flex';
  document.getElementById('authEmail').value='';
  document.getElementById('authPassword').value='';
  document.getElementById('authError').textContent='';
  showToast('Sesi√≥n cerrada');
}

function startApp() {
  const settings = DB.get('settings', {});
  currentPeriod = settings.period || 'mes';
  currentView = settings.view || 'consumo';

  document.getElementById('mainApp').style.display = 'flex';
  document.getElementById('mainApp').style.flexDirection = 'column';

  // Set default form dates
  const manualDate = document.getElementById('manualDate');
  const confirmDate = document.getElementById('confirmDate');
  if (manualDate) manualDate.value = today();
  if (confirmDate) confirmDate.value = today();

  // Safe toggle helper ‚Äî skips if element no longer exists in DOM
  const tog = (id, active) => { const el = document.getElementById(id); if (el) el.classList.toggle('active', active); };
  tog('segMes',     currentPeriod==='mes');
  tog('segCiclo',   currentPeriod==='ciclo');
  tog('tabConsumo', currentView==='consumo');
  tog('tabPorPagar',currentView==='porpagar');

  buildCatGrid();
  buildFilterChips();
  buildCatSelect();
  renderCards();
  renderCatManager();
  updateSettingsDisplay();
  renderDashboard();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab) {
  // Always close any open modals first so they don't cover the new tab
  document.querySelectorAll('.screen-modal.open').forEach(m => m.classList.remove('open'));
  document.querySelectorAll('.screen-overlay.open').forEach(m => m.classList.remove('open'));

  if (tab === 'movimientos') {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    const tabEl = document.getElementById('tab-movimientos');
    if (tabEl) tabEl.classList.add('active');
    openModal('screenMovimientos'); renderMovimientos(); return;
  }

  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));

  const tabEl = document.getElementById('tab-' + tab);
  const scrId = 'screen' + tab.charAt(0).toUpperCase() + tab.slice(1);
  const scrEl = document.getElementById(scrId);
  if (tabEl) tabEl.classList.add('active');
  if (scrEl) scrEl.classList.add('active');

  if (tab === 'inicio') renderDashboard();
  if (tab === 'ajustes') { updateSettingsDisplay(); updateApiKeyStatus(); }
}
const FAB_HIDE_SCREENS = ['screenTarjetas','screenCardDetail','screenBudgetDetail','screenBudgetConfig','screenMovimientos'];
function openModal(id) {
  document.getElementById(id).classList.add('open');
  if (id === 'screenBudgetDetail') renderBudgetDetail();
  if (id === 'screenBudgetConfig') renderBudgetConfig();
  if (FAB_HIDE_SCREENS.includes(id)) { const f=document.getElementById('fabBtn'); if(f) f.style.display='none'; }
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  const anyOpen = FAB_HIDE_SCREENS.some(mid => document.getElementById(mid)?.classList.contains('open'));
  const fab = document.getElementById('fabBtn');
  if (fab) fab.style.display = anyOpen ? 'none' : 'flex';
}
function openOverlay(id) { document.getElementById(id).classList.add('open'); }
function closeOverlay(id) { document.getElementById(id).classList.remove('open'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD ‚Äî 2-block architecture
// Block 1: Consumo del mes (mes calendario, all methods)
// Block 2: Lo que debes (ciclo activo por tarjeta, solo cr√©dito)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getDashMonth() {
  const d = new Date();
  d.setDate(1);
  d.setMonth(d.getMonth() + dashMonthOffset);
  return d;
}
function navigateMonth(dir) {
  dashMonthOffset += dir; // allow future months (for cuotas)
  renderDashboard();
}

// Stubs for legacy calls
function switchPeriod(p) {}
function switchView(v) {}
function switchPeriodAndReset(p) {}
function selectCard(id) { selectedCardId = String(id); renderDashboard(); }
function buildCardChips() {}

// All txns for the selected calendar month
function getTxnsForMonth() {
  // Block 1 = calendar month of PURCHASE DATE
  // For installments: cuota 1 has date=purchaseDate ‚Üí shows in purchase month ‚úì
  // Cuotas 2+ have date=future cycle date ‚Üí must be excluded from Block 1
  const ref = getDashMonth();
  return DB.get('transactions', []).filter(t => {
    // Exclude sub-cuotas (2, 3...) from Block 1 ‚Äî they appear in Block 2 only
    if (t.cuotas > 1 && t.cuotaNum > 1) return false;
    // Filter by purchaseDate for cuota 1, or date for regular txns
    const checkDate = t.purchaseDate || t.date;
    const d = new Date(checkDate + 'T12:00:00');
    return d.getMonth()===ref.getMonth() && d.getFullYear()===ref.getFullYear();
  });
}

// Credit txns that fall within a card's active billing cycle (not month)
function getCreditTxnsForCycle(card, refDate) {
  const ref = refDate || getDashMonth();
  const cycle = getCycleClosingInMonth(card.closeDay, card.dueDay, ref);
  const allTxns = DB.get('transactions', []);

  // First: find all cuota-1 txns whose purchaseDate falls in this cycle
  // Then: for each plan found, include the specific cuota that belongs to THIS cycle
  const totalCards = DB.get('cards',[]).filter(c=>c.type==='credito').length;
  const plansInCycle = new Set();
  const cuota1InCycle = new Set();

  allTxns.forEach(t => {
    if (t.type === 'income' || t.payMethod !== 'tarjeta') return;
    if (t.cardId && String(t.cardId) !== String(card.id)) return;
    if (!t.cardId && totalCards > 1) return;
    if (t.cuotas <= 1 || t.cuotaNum === 1) {
      // Single payment or cuota 1: check purchaseDate
      const d = new Date((t.purchaseDate || t.date) + 'T12:00:00');
      if (d >= cycle.start && d <= cycle.end) {
        if (t.planId) plansInCycle.add(t.planId);
        else cuota1InCycle.add(t.id);
      }
    }
  });

  return allTxns.filter(t => {
    if (t.type === 'income' || t.payMethod !== 'tarjeta') return false;
    // If transaction has an explicit cardId, it must match this card
    if (t.cardId && String(t.cardId) !== String(card.id)) return false;
    // If transaction has NO cardId AND there are multiple credit cards ‚Üí skip (ambiguous)
    if (!t.cardId && totalCards > 1) return false;

    if (t.cuotas <= 1) {
      // Single payment: purchaseDate in cycle
      const d = new Date((t.purchaseDate || t.date) + 'T12:00:00');
      return d >= cycle.start && d <= cycle.end;
    }

    // Installment plan: check which cuota number belongs to THIS cycle
    // cuota 1 belongs to the cycle where purchaseDate falls
    // cuota N belongs to the cycle N-1 months later
    if (!t.planId) return false;

    // Find cuota 1 of this plan to get the base cycle
    const cuota1 = allTxns.find(x => x.planId === t.planId && x.cuotaNum === 1);
    if (!cuota1) return false;

    const baseCycleRef = new Date((cuota1.purchaseDate || cuota1.date) + 'T12:00:00');
    const baseCycle = getCycleClosingInMonth(card.closeDay, card.dueDay, baseCycleRef);

    // Cuota N is due N-1 months after the base cycle
    const cuotaCycleRef = new Date(baseCycle.end);
    cuotaCycleRef.setMonth(cuotaCycleRef.getMonth() + (t.cuotaNum - 1));

    const cuotaCycle = getCycleClosingInMonth(card.closeDay, card.dueDay, cuotaCycleRef);

    // Does this cuota's cycle match the navigated cycle?
    return cuotaCycle.end.getMonth() === cycle.end.getMonth() &&
           cuotaCycle.end.getFullYear() === cycle.end.getFullYear();
  });
}

function getCycleClosingInMonth(closeDay, dueDay, refDate) {
  // Block 2 rule: show the cycle that CLOSES in refDate's month.
  // Feb ‚Üí cycle closing Feb 20 (21 Jan‚Äì20 Feb), due Mar 5
  // The closeDay is INCLUDED in the current cycle (purchases on closeDay ‚Üí this cycle).
  const ref = refDate || new Date();
  const cycleEndMonth = ref.getMonth();
  const cycleEndYear  = ref.getFullYear();

  // Clamp closeDay to actual days in the month (handles Feb 30, etc.)
  const daysInEndMonth = new Date(cycleEndYear, cycleEndMonth + 1, 0).getDate();
  const effectiveCloseDay = Math.min(closeDay, daysInEndMonth);
  const cycleEnd = new Date(cycleEndYear, cycleEndMonth, effectiveCloseDay);

  // Cycle start = day after closeDay of previous month
  let startMonth = cycleEndMonth - 1, startYear = cycleEndYear;
  if (startMonth < 0) { startMonth = 11; startYear--; }
  const daysInStartMonth = new Date(startYear, startMonth + 1, 0).getDate();
  const effectiveStartCloseDay = Math.min(closeDay, daysInStartMonth);
  const cycleStart = new Date(startYear, startMonth, effectiveStartCloseDay + 1);

  // Due date = dueDay of month after cycleEnd (clamped)
  let dueMonth = cycleEndMonth + 1, dueYear = cycleEndYear;
  if (dueMonth > 11) { dueMonth = 0; dueYear++; }
  const daysInDueMonth = new Date(dueYear, dueMonth + 1, 0).getDate();
  const dueDate = new Date(dueYear, dueMonth, Math.min(dueDay, daysInDueMonth));

  return { start: cycleStart, end: cycleEnd, dueDate,
    label: cycleEnd.toLocaleDateString('es-CL', {month:'long', year:'numeric'}) };
}

function renderDashboard() {
  const now = new Date();
  const ref = getDashMonth();
  const isCurrentMonth = dashMonthOffset === 0;
  const allCards = DB.get('cards', []);
  const creditCards = allCards.filter(c => c.type === 'credito');

  // Month label
  const monthStr = ref.toLocaleDateString('es-CL', {month:'long', year:'numeric'});
  document.getElementById('dashMonthLabel').textContent =
    isCurrentMonth
      ? ref.toLocaleDateString('es-CL',{month:'long',year:'numeric'}).replace(/^\w/, c=>c.toUpperCase())
      : monthStr.replace(/^\w/, c=>c.toUpperCase());
  const nextBtn = document.getElementById('nextMonthBtn');
  if (nextBtn) nextBtn.style.opacity = '1'; // always enabled ‚Äî user can browse future months

  // Greeting
  const h = now.getHours();
  document.getElementById('dashGreeting').textContent =
    (h<12?'Buenos d√≠as':h<19?'Buenas tardes':'Buenas noches') + ' üëã';

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // BLOCK 1: Consumo del mes calendario
  // All payment methods, purchase amounts
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const settings = DB.get('settings', {});
  const configuredIncome = settings.income || 0; // income set in onboarding/settings
  const allTxns = getTxnsForMonth();
  let totalGasto = 0, totalIngreso = 0;
  const byMethod = { efectivo:0, debito:0, tarjeta:0 };
  const catTotals = {};

  allTxns.forEach(t => {
    if (t.type === 'income') { totalIngreso += t.amount; return; }
    // For cuotas in consumo view: cuota1 represents full purchase, rest ignored
    let amt;
    if (t.cuotas > 1) {
      if (t.cuotaNum !== 1) return;
      amt = t.installmentAmt ? t.installmentAmt * t.cuotas : t.amount;
    } else {
      amt = t.amount;
    }
    totalGasto += amt;
    const m = t.payMethod === 'tarjeta' ? 'tarjeta' : (t.payMethod === 'debito' ? 'debito' : 'efectivo');
    byMethod[m] += amt;
    catTotals[t.category] = (catTotals[t.category]||0) + amt;
  });

  // Update Block 1 UI
  document.getElementById('dashTotalGasto').textContent = clp(totalGasto);
  document.getElementById('dashTotalIngreso').textContent = clp(totalIngreso);

  // Use configured income (from settings) OR sum of income transactions ‚Äî whichever is higher
  const effectiveIncome = configuredIncome + totalIngreso;
  const pct = effectiveIncome > 0 ? Math.min(100, Math.round(totalGasto/effectiveIncome*100)) : (totalGasto>0?100:0);
  const barColor = pct>=90 ? 'rgba(239,68,68,0.9)' : pct>=70 ? 'rgba(245,158,11,0.9)' : 'rgba(255,255,255,0.85)';
  document.getElementById('spendBar').style.cssText += `;width:${pct}%;background:${barColor}`;
  // Show configured income in the KPI if no income txns registered yet
  const displayIngreso = configuredIncome + totalIngreso;
  document.getElementById('dashTotalIngreso').textContent = clp(displayIngreso);
  const label = effectiveIncome > 0 ? `${pct}% del ingreso mensual` : 'Sin ingreso registrado';
  document.getElementById('spendBarLabel').textContent = label;

  const nExp = allTxns.filter(t=>t.type!=='income'&&(t.cuotas<=1||t.cuotaNum===1)).length;
  document.getElementById('dashTransCount').innerHTML =
    `<span class="material-symbols-rounded" style="font-size:13px;font-variation-settings:\"FILL\" 1;">receipt_long</span><span>${nExp} ${nExp===1?'gasto':'gastos'}</span>`;

  document.getElementById('kpiEfectivo').textContent = clp(byMethod.efectivo);
  document.getElementById('kpiDebito').textContent = clp(byMethod.debito);
  document.getElementById('kpiCredito').textContent = clp(byMethod.tarjeta);

  // Subtexts: show txn count per method
  const nEf = allTxns.filter(t=>t.type!=='income'&&t.payMethod!=='tarjeta'&&t.payMethod!=='debito'&&(t.cuotas<=1||t.cuotaNum===1)).length;
  const efSub = document.getElementById('kpiEfectivoSub');
  if (efSub) efSub.textContent = nEf + (nEf===1?' pago':' pagos');

  // Cr√©dito card: add urgency border if due soon
  const creditCard = document.getElementById('kpiCreditoCard');
  const nextDue = creditCards.map(c => {
    const cyc = getCycleClosingInMonth(c.closeDay, c.dueDay, ref);
    return Math.ceil((cyc.dueDate - now) / 86400000);
  });
  const minDays = nextDue.length ? Math.min(...nextDue) : 999;
  if (creditCard) {
    creditCard.style.borderColor = minDays<=5 ? 'var(--red)' : minDays<=10 ? 'var(--amber)' : '#DDD6FE';
    creditCard.style.background = minDays<=5 ? '#FFF1F1' : minDays<=10 ? '#FFFBEB' : '';
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // BUDGET WIDGET (between block1 and block2)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  renderBudgetWidget(totalGasto, catTotals, ref);

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // BLOCK 2: Lo que debes a tu tarjeta
  // Ciclo activo de cada tarjeta (crosses months)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const ppModule = document.getElementById('porPagarModule');

  if (!creditCards.length) {
    ppModule.innerHTML = `
      <div style="background:var(--card);border-radius:var(--radius);padding:18px 16px;box-shadow:var(--shadow);display:flex;gap:14px;align-items:center;">
        <div style="width:44px;height:44px;border-radius:12px;background:rgba(139,92,246,0.2);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <span class="material-symbols-rounded" style="color:#A78BFA;font-size:22px;font-variation-settings:\"FILL\" 1;">credit_card</span>
        </div>
        <div style="flex:1;">
          <p style="font-size:14px;font-weight:700;margin-bottom:3px;">¬øTienes tarjeta de cr√©dito?</p>
          <p style="font-size:12px;color:var(--muted);line-height:1.4;">Agr√©gala y Lucas calcular√° autom√°ticamente tu ciclo y cu√°ndo debes pagar.</p>
        </div>
        <button onclick="openModal('screenTarjetas')" style="background:var(--blue);border:none;border-radius:10px;padding:10px 16px;font-family:inherit;font-size:12px;font-weight:700;color:white;cursor:pointer;flex-shrink:0;white-space:nowrap;">+ Agregar</button>
      </div>`;
  } else {
    // Per-card: use each card's own active cycle
    let totalPorPagar = 0;
    const cardRows = creditCards.map(card => {
      const cycleTxns = getCreditTxnsForCycle(card, ref);
      // Also include txns with no cardId assigned if this is the only card
      const relevant = cycleTxns;

      let cardTotal = 0;
      const cuotaItems = [];
      const singleTxns = [];

      relevant.forEach(t => {
        // Block 2 uses installmentAmt (por pagar logic: cuota per period)
        const amt = t.cuotas > 1 ? (t.installmentAmt || Math.ceil(t.amount/t.cuotas)) : t.amount;
        cardTotal += amt;
        if (t.cuotas > 1) {
          cuotaItems.push({ name: t.merchant||getCat(t.category).name, amt, cuotaNum:t.cuotaNum, cuotas:t.cuotas });
        } else {
          singleTxns.push({ name: t.merchant||getCat(t.category).name, amt });
        }
      });

      totalPorPagar += cardTotal;
      const cycle = getCycleClosingInMonth(card.closeDay, card.dueDay, ref);
      const cycleStart = cycle.start.toLocaleDateString('es-CL',{day:'numeric',month:'short'});
      const cycleEnd = cycle.end.toLocaleDateString('es-CL',{day:'numeric',month:'short'});
      const dueStr = cycle.dueDate.toLocaleDateString('es-CL',{day:'numeric',month:'long'});
      const daysLeft = Math.ceil((cycle.dueDate - now) / 86400000);
      const urgColor = daysLeft<=5 ? 'var(--red)' : daysLeft<=10 ? 'var(--amber)' : '#7C3AED';
      const urgBg = daysLeft<=5 ? '#FEE2E2' : daysLeft<=10 ? '#FEF3C7' : '#EDE9FE';
      const daysText = daysLeft > 1 ? `en ${daysLeft} d√≠as` : daysLeft===1 ? 'ma√±ana' : daysLeft===0 ? '¬°hoy!' : 'vencida';

      return { card, cardTotal, cuotaItems, singleTxns, cycleStart, cycleEnd, dueStr, daysLeft, urgColor, urgBg, daysText, txCount: relevant.length };
    });

    ppModule.innerHTML = `
      <div style="background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;">

        <!-- Consolidated header -->
        <div style="padding:16px;background:linear-gradient(135deg,#4C1D95,#6D28D9);display:flex;align-items:center;justify-content:space-between;">
          <div>
            <p style="font-size:11px;font-weight:700;color:rgba(255,255,255,0.75);text-transform:uppercase;letter-spacing:0.06em;">Total por pagar</p>
            <div style="font-size:32px;font-weight:800;color:white;letter-spacing:-1px;margin-top:2px;">${clp(totalPorPagar)}</div>
            <p style="font-size:11px;color:rgba(255,255,255,0.7);margin-top:3px;">entre ${creditCards.length} tarjeta${creditCards.length>1?'s':''}</p>
          </div>
          <div style="text-align:right;">
            <div style="background:rgba(255,255,255,0.15);border-radius:10px;padding:8px 12px;">
              <p style="font-size:10px;color:rgba(255,255,255,0.7);font-weight:600;">Pr√≥ximo vencimiento</p>
              <p style="font-size:13px;font-weight:800;color:white;margin-top:2px;">${cardRows.reduce((min,r)=>r.daysLeft<min.daysLeft?r:min,cardRows[0]).dueStr}</p>
            </div>
          </div>
        </div>

        <!-- Per-card rows -->
        ${cardRows.map(({card,cardTotal,cuotaItems,singleTxns,cycleStart,cycleEnd,dueStr,daysLeft,urgColor,urgBg,daysText,txCount}) => `
        <div style="border-bottom:1px solid var(--border);">
          <!-- Card header row -->
          <div style="padding:14px 16px 10px;display:flex;align-items:flex-start;justify-content:space-between;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'" style="cursor:pointer;">
            <div style="display:flex;align-items:center;gap:10px;flex:1;cursor:pointer;" onclick="this.parentElement.nextElementSibling.style.display=this.parentElement.nextElementSibling.style.display==='none'?'block':'none'">
              <div style="width:36px;height:36px;border-radius:10px;background:${card.color}20;display:flex;align-items:center;justify-content:center;flex-shrink:0;border:1.5px solid ${card.color}40;">
                <span class="material-symbols-rounded" style="font-size:18px;color:${card.color};font-variation-settings:\"FILL\" 1;">credit_card</span>
              </div>
              <div>
                <p style="font-size:14px;font-weight:800;">${card.name}</p>
                <p style="font-size:11px;color:var(--muted);">Ciclo: ${cycleStart} ‚Üí ${cycleEnd}</p>
              </div>
            </div>
            <div style="text-align:right;flex-shrink:0;">
              <p style="font-size:18px;font-weight:800;color:#A78BFA;">${clp(cardTotal)}</p>
              <div style="display:inline-flex;align-items:center;gap:3px;background:${urgBg};border-radius:100px;padding:2px 8px;margin-top:3px;">
                <span class="material-symbols-rounded" style="font-size:11px;color:${urgColor};font-variation-settings:\"FILL\" 1;">schedule</span>
                <p style="font-size:10px;font-weight:700;color:${urgColor};">Vence ${daysText}</p>
              </div>
            </div>
          </div>

          <!-- Expandable detail (hidden by default) -->
          <div style="display:none;padding:0 16px 12px;">
            <div style="background:rgba(139,92,246,0.08);border-radius:8px;padding:10px 12px;">
              <p style="font-size:10px;font-weight:700;color:#A78BFA;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">Desglose ‚Äî ${txCount} cargo${txCount!==1?'s':''}</p>
              ${cuotaItems.map(i=>`
                <div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid #EDE9FE;">
                  <div style="display:flex;align-items:center;gap:6px;">
                    <span style="background:rgba(139,92,246,0.2);color:#A78BFA;border-radius:4px;padding:1px 6px;font-size:10px;font-weight:700;">${i.cuotaNum}/${i.cuotas}</span>
                    <p style="font-size:12px;color:var(--text);">${i.name}</p>
                  </div>
                  <p style="font-size:13px;font-weight:700;color:#A78BFA;">${clp(i.amt)}</p>
                </div>`).join('')}
              ${singleTxns.map(i=>`
                <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #EDE9FE;">
                  <p style="font-size:12px;color:var(--text);">${i.name}</p>
                  <p style="font-size:13px;font-weight:700;color:#A78BFA;">${clp(i.amt)}</p>
                </div>`).join('')}
              <div style="display:flex;justify-content:space-between;padding:8px 0 0;">
                <p style="font-size:12px;font-weight:700;">Total</p>
                <p style="font-size:13px;font-weight:800;color:#A78BFA;">${clp(cardTotal)}</p>
              </div>
            </div>
            <p style="font-size:10px;color:var(--muted);margin-top:6px;text-align:center;">Pagar antes del ${dueStr}</p>
          </div>
        </div>`).join('')}

        <!-- Educational footer -->
        <div style="padding:10px 16px;display:flex;gap:8px;align-items:flex-start;background:var(--card2);">
          <span class="material-symbols-rounded" style="font-size:14px;color:var(--muted);flex-shrink:0;margin-top:1px;font-variation-settings:\"FILL\" 1;">info</span>
          <p style="font-size:11px;color:var(--muted);line-height:1.5;">Los gastos en efectivo y d√©bito ya salieron de tu cuenta ‚Äî no hay nada que pagar al banco por ellos. Este bloque solo muestra deuda de cr√©dito.</p>
        </div>
      </div>`;
  }

  // Donut uses Block 1 data (calendar month, all methods)
  renderDonut(catTotals, totalGasto);
  renderRecentTxns(allTxns);
  renderEmailPendingWidget();
  renderPendingWidget(ref);
}

function renderPendingWidget(ref) {
  const widget = document.getElementById('pendingRecurringWidget');
  if (!widget) return;
  const pending = DB.get('pendingRecurring', []);
  // Show only pending items for the current viewed month
  const monthPending = pending.filter(p => {
    if (p.status !== 'pending') return false;
    const d = new Date(p.suggestedDate + 'T12:00:00');
    return d.getMonth() === ref.getMonth() && d.getFullYear() === ref.getFullYear();
  });
  if (!monthPending.length) { widget.innerHTML = ''; return; }
  widget.innerHTML = `
    <div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:var(--radius);padding:14px 16px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
        <span class="material-symbols-rounded" style="color:#D97706;font-size:18px;font-variation-settings:\"FILL\" 1;">pending_actions</span>
        <p style="font-size:13px;font-weight:800;color:#F59E0B;">Gastos recurrentes por confirmar</p>
        <span style="margin-left:auto;background:rgba(245,158,11,0.2);color:#F59E0B;border-radius:100px;padding:2px 8px;font-size:11px;font-weight:800;">${monthPending.length}</span>
      </div>
      ${monthPending.map(p => `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-top:1px solid #FDE68A;">
          <div>
            <p style="font-size:13px;font-weight:700;">${p.merchant || getCat(p.category).name}</p>
            <p style="font-size:11px;color:#F59E0B;">${clp(p.amount)} ¬∑ ${formatDate(p.suggestedDate)}</p>
          </div>
          <div style="display:flex;gap:6px;">
            <button onclick="confirmPending('${p.id}')" style="background:#10B981;border:none;border-radius:8px;padding:6px 12px;font-family:inherit;font-size:12px;font-weight:700;color:white;cursor:pointer;">‚úì Confirmar</button>
            <button onclick="dismissPending('${p.id}')" style="background:rgba(255,255,255,0.08);border:none;border-radius:8px;padding:6px 10px;font-family:inherit;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;">‚úï</button>
          </div>
        </div>`).join('')}
    </div>`;
}


// ‚îÄ‚îÄ Persist pendingRecurring to Supabase via user_settings ‚îÄ‚îÄ
async function savePendingToSB(pending) {
  if (!CURRENT_USER) return;
  await supa.from('user_settings').upsert({
    user_id: CURRENT_USER.id,
    pending_recurring: JSON.stringify(pending),
    updated_at: new Date().toISOString()
  }, { onConflict: 'user_id' });
}
async function loadPendingFromSB() {
  if (!CURRENT_USER) return;
  const { data } = await supa.from('user_settings')
    .select('pending_recurring')
    .eq('user_id', CURRENT_USER.id)
    .single();
  if (data?.pending_recurring) {
    try {
      const parsed = JSON.parse(data.pending_recurring);
      if (Array.isArray(parsed)) DB.set('pendingRecurring', parsed);
    } catch(e) {}
  }
}
async function confirmPending(pendingId) {
  const pending = DB.get('pendingRecurring', []);
  const item = pending.find(p => p.id === pendingId);
  if (!item) return;
  const newTxn = {
    id: 'txn_' + Date.now(),
    type: 'expense',
    amount: item.amount,
    merchant: item.merchant,
    category: item.category,
    payMethod: item.payMethod,
    cardId: item.cardId,
    date: item.suggestedDate,
    purchaseDate: item.suggestedDate,
    note: item.note || '',
    recurring: true,
    cuotas: 1, cuotaNum: 1, installmentAmt: item.amount,
    source: 'recurring', createdAt: new Date().toISOString(),
  };
  // Save to Supabase first
  let saved = [newTxn];
  try { saved = await SB.saveTxns([newTxn]); } catch(e) { console.warn('SB recurring confirm failed', e); }
  const txns = DB.get('transactions', []);
  saved.forEach(t => txns.push(t));
  DB.set('transactions', txns);
  // Mark as confirmed
  item.status = 'confirmed';
  DB.set('pendingRecurring', pending);
  // Persist pending state to Supabase
  try { await savePendingToSB(pending); } catch(e) {}
  renderDashboard();
  showToast('\u2713 Gasto confirmado');
}

async function dismissPending(pendingId) {
  const pending = DB.get('pendingRecurring', []);
  const item = pending.find(p => p.id === pendingId);
  if (item) {
    item.status = 'dismissed';
    DB.set('pendingRecurring', pending);
    try { await savePendingToSB(pending); } catch(e) {}
  }
  renderDashboard();
  showToast('Sugerencia descartada');
}

const CHART_COLORS = ['#2563EB','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#14B8A6','#64748B'];
function renderDonut(catTotals, total) {
  const entries = Object.entries(catTotals).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const svg = document.getElementById('donutSVG');
  const legend = document.getElementById('catLegend');
  if (!entries.length || total===0) {
    svg.innerHTML = `<circle cx="40" cy="40" r="30" fill="none" stroke="#E2E8F0" stroke-width="14"/><text x="40" y="44" text-anchor="middle" font-size="9" fill="#94A3B8" font-family="Plus Jakarta Sans">Sin datos</text>`;
    legend.innerHTML = `<p style="font-size:12px;color:var(--muted);">Agrega gastos para ver.</p>`;
    return;
  }
  const r=30, cx=40, cy=40, circ=2*Math.PI*r;
  let offset=0, segs='';
  entries.forEach(([id,val],i) => {
    const pct=val/total, dash=(pct*circ)-1;
    segs+=`<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${CHART_COLORS[i]}" stroke-width="14" stroke-dasharray="${dash} ${circ-dash}" stroke-dashoffset="${-offset}" style="transform:rotate(-90deg);transform-origin:50% 50%;"/>`;
    offset+=pct*circ;
  });
  svg.innerHTML=`<circle cx="40" cy="40" r="30" fill="none" stroke="#E2E8F0" stroke-width="14"/>${segs}`;
  legend.innerHTML=entries.map(([id,val],i)=>{
    const cat=getCat(id), pct=Math.round(val/total*100);
    return `<div class="cat-legend-item"><div style="display:flex;align-items:center;gap:6px;"><div class="cat-dot" style="background:${CHART_COLORS[i]}"></div><span style="font-weight:600;font-size:12px;">${cat.name}</span></div><span style="color:var(--muted);font-size:12px;">${pct}%</span></div>`;
  }).join('');
}

function renderRecentTxns(txns) {
  const el = document.getElementById('recentTxns');
  const recent = [...txns].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
  if (!recent.length) { el.innerHTML=`<div style="text-align:center;padding:32px;color:var(--muted);font-size:14px;">No hay gastos a√∫n.<br/>¬°Registra tu primer gasto!</div>`; return; }
  el.innerHTML = recent.map(txnHTML).join('');
}

function txnHTML(t) {
  const cat = getCat(t.category);
  const isIncome = t.type==='income';
  const isInstallment = t.cuotas > 1;
  const instAmt = t.installmentAmt || Math.ceil(t.amount / t.cuotas);
  const displayAmt = isIncome ? t.amount : (isInstallment ? instAmt : t.amount);
  const payLabel = t.payMethod==='tarjeta'?'Tarjeta cr√©d.':t.payMethod==='debito'?'D√©bito':'Efectivo';
  const nameLine = isInstallment
    ? `${t.merchant || cat.name} <span style="background:rgba(139,92,246,0.2);color:#A78BFA;border-radius:4px;padding:1px 6px;font-size:10px;font-weight:700;margin-left:4px;">Cuota ${t.cuotaNum}/${t.cuotas}</span>`
    : (t.merchant || cat.name);
  const subLine = isInstallment
    ? `${payLabel} ¬∑ total ${clp(instAmt * t.cuotas)}`
    : `${payLabel} ¬∑ ${cat.name}`;
  // Receipt thumbnail ‚Äî shown if transaction was registered via photo/OCR
  const hasReceipt = !!(t.receiptUrl || t.receiptDataUrl);
  const receiptSrc = t.receiptDataUrl || (t.receiptUrl && t.receiptUrl.startsWith('data:') ? t.receiptUrl : null);
  const iconHtml = receiptSrc
    ? `<div class="txn-icon" style="background:rgba(139,92,246,0.12);overflow:hidden;flex-shrink:0;">
        <img src="${receiptSrc}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'"/>
       </div>`
    : `<div class="txn-icon" style="background:${cat.color}18;">
        <span class="material-symbols-rounded" style="color:${cat.color};font-size:20px;font-variation-settings:\"FILL\" 1;">${cat.icon}</span>
       </div>`;
  return `<div class="swipe-container" data-id="${t.id}" style="position:relative;overflow:hidden;border-radius:14px;margin-bottom:0;">
    <div class="swipe-actions" style="position:absolute;right:0;top:0;bottom:0;display:flex;align-items:stretch;">
      <button onclick="openDetalle('${t.id}')" style="background:#3B82F6;border:none;color:white;font-family:inherit;font-size:11px;font-weight:700;padding:0 14px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;">
        <span class="material-symbols-rounded" style="font-size:18px;">edit</span>Editar
      </button>
      <button onclick="quickDeleteTxn('${t.id}')" style="background:#EF4444;border:none;color:white;font-family:inherit;font-size:11px;font-weight:700;padding:0 14px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;">
        <span class="material-symbols-rounded" style="font-size:18px;">delete</span>Borrar
      </button>
    </div>
    <div class="txn-item swipe-item" onclick="handleTxnClick(event,'${t.id}')" style="position:relative;z-index:1;transform:translateX(0);transition:transform 0.25s ease;background:var(--card2);">
      ${iconHtml}
      <div class="txn-info">
        <div class="txn-name">${nameLine}</div>
        <div class="txn-sub">${subLine}${t.note ? ' ¬∑ ' + t.note : ''}</div>
      </div>
      <div style="text-align:right;flex-shrink:0;">
        <div style="font-size:14px;font-weight:800;color:${isIncome?'var(--green)':'var(--red)'};">${isIncome?'+':'-'}${clp(displayAmt)}</div>
        <div style="font-size:10px;color:var(--muted);">${formatDate(t.date)}</div>
      </div>
    </div>
  </div>`;
}

function handleTxnClick(e, id) {
  // If item is swiped open, close it instead of opening detail
  const item = e.currentTarget;
  const tx = parseFloat(item.style.transform.replace('translateX(','').replace(')','').replace('px','')) || 0;
  if (tx < -10) { item.style.transform = 'translateX(0)'; return; }
  openDetalle(id);
}

function quickDeleteTxn(id) {
  if (!confirm('¬øEliminar este movimiento?')) return;
  const txns = DB.get('transactions',[]);
  const t = txns.find(x=>String(x.id)===String(id));
  if (t?.planId) {
    DB.set('transactions', txns.filter(x=>x.planId!==t.planId));
    try { SB.deletePlan(t.planId); } catch(e){}
  } else {
    DB.set('transactions', txns.filter(x=>String(x.id)!==String(id)));
    try { SB.deleteTxn(id); } catch(e){}
  }
  renderMovimientos();
  renderDashboard();
  showToast('‚úì Movimiento eliminado');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOVIMIENTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeFilter = 'all', activePayFilter = 'all', searchQ = '';

function buildFilterChips() {
  const cats = getAllCats();
  const chips = document.getElementById('filterChips');
  chips.innerHTML = `<div class="filter-chip active" onclick="setFilter('all',this)">Todos</div>` +
    cats.map(c=>`<div class="filter-chip" onclick="setFilter('${c.id}',this)">${c.name}</div>`).join('');
}

function setPayFilter(f, el) {
  activePayFilter = f;
  document.querySelectorAll('#payFilterChips .filter-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  renderMovimientos();
}
function setFilter(f, el) {
  activeFilter = f;
  document.querySelectorAll('#filterChips .filter-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  renderMovimientos();
}
function filterTxns() { searchQ = document.getElementById('searchInput').value.toLowerCase(); renderMovimientos(); }

let currentMovTab = 'gastos';
function switchMovTab(tab) {
  currentMovTab = tab;
  const isG = tab==='gastos';
  const tg=document.getElementById('movTabGastos'), ti=document.getElementById('movTabIngresos');
  if(tg){tg.style.background=isG?'white':'transparent';tg.style.color=isG?'var(--blue)':'var(--muted)';tg.style.boxShadow=isG?'0 1px 3px rgba(0,0,0,0.1)':'none';}
  if(ti){ti.style.background=!isG?'white':'transparent';ti.style.color=!isG?'var(--green)':'var(--muted)';ti.style.boxShadow=!isG?'0 1px 3px rgba(0,0,0,0.1)':'none';}
  renderMovimientos();
}

function movNavMonth(dir) {
  if (!window.movYear) { const n=new Date(); window.movYear=n.getFullYear(); window.movMonth=n.getMonth(); }
  window.movMonth += dir;
  if (window.movMonth > 11) { window.movMonth = 0; window.movYear++; }
  if (window.movMonth < 0) { window.movMonth = 11; window.movYear--; }
  renderMovimientos();
}
function renderMovimientos() {
  const txns = DB.get('transactions', []);
  // Month navigation for movimientos
  if (!window.movYear) { const n=new Date(); window.movYear=n.getFullYear(); window.movMonth=n.getMonth(); }
  const mY = window.movYear, mM = window.movMonth;
  // Update month label
  const movLbl = document.getElementById('movMonthLabel');
  if (movLbl) {
    const lbl = new Date(mY, mM, 1).toLocaleDateString('es-CL',{month:'long',year:'numeric'});
    movLbl.textContent = lbl.charAt(0).toUpperCase() + lbl.slice(1);
  }
  let filtered = txns.filter(t => {
    const d = new Date((t.date||t.purchaseDate)+'T12:00:00');
    const matchM = d.getFullYear()===mY && d.getMonth()===mM;
    const matchF = activeFilter==='all' || t.category===activeFilter;
    const matchP = activePayFilter==='all' || t.payMethod===activePayFilter;
    const matchS = !searchQ || (t.merchant||'').toLowerCase().includes(searchQ) || getCat(t.category).name.toLowerCase().includes(searchQ);
    return matchM && matchF && matchP && matchS;
  }).sort((a,b)=>new Date(b.date)-new Date(a.date));

  // Tab filter
  if (currentMovTab === 'ingresos') {
    filtered = filtered.filter(t => t.type === 'income');
  } else {
    filtered = filtered.filter(t => t.type !== 'income');
  }
  // Tab summary
  const summEl = document.getElementById('movTabSummary');
  if (summEl) {
    if (currentMovTab === 'ingresos') {
      const cfgInc = DB.get('settings',{}).income || 0;
      summEl.textContent = 'Total: ' + clp(cfgInc + filtered.reduce((s,t)=>s+t.amount,0));
      summEl.style.color = 'var(--green)';
    } else {
      summEl.textContent = filtered.length + ' movimiento' + (filtered.length!==1?'s':'');
      summEl.style.color = 'var(--muted)';
    }
  }
  const el = document.getElementById('movimientosList');
  if (!filtered.length) { el.innerHTML=`<div style="text-align:center;padding:48px 20px;color:var(--muted);font-size:14px;">No hay movimientos.</div>`; return; }

  // Group by payment date (each cuota on its own due date)
  const groups = {};
  filtered.forEach(t => { (groups[t.date]=groups[t.date]||[]).push(t); });
  let html='';
  Object.entries(groups).sort((a,b)=>new Date(b[0])-new Date(a[0])).forEach(([date,items])=>{
    html+=`<div class="date-group">${formatDate(date)}</div><div style="display:flex;flex-direction:column;gap:8px;padding:0 20px;">`;
    items.forEach(t => { html+=txnHTML(t); });
    html+='</div>';
  });
  el.innerHTML=html;
  // Init swipe gestures after DOM update
  requestAnimationFrame(() => initSwipeGestures());
}

function initSwipeGestures() {
  document.querySelectorAll('.swipe-item').forEach(item => {
    if (item._swipeInit) return;
    item._swipeInit = true;
    let startX = 0, startY = 0, moved = false;
    item.addEventListener('touchstart', e => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      moved = false;
    }, {passive:true});
    item.addEventListener('touchmove', e => {
      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;
      if (!moved && Math.abs(dy) > Math.abs(dx) + 5) return;
      moved = true;
      if (dx < 0) item.style.transform = `translateX(${Math.max(-120, dx)}px)`;
      else item.style.transform = 'translateX(0)';
    }, {passive:true});
    item.addEventListener('touchend', e => {
      const dx = e.changedTouches[0].clientX - startX;
      item.style.transform = dx < -60 ? 'translateX(-120px)' : 'translateX(0)';
    }, {passive:true});
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CATEGORIES ‚Äî build + manage
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedCat = 'comida';
let newCatColor = '#2563EB';
let newCatIcon = 'more_horiz';

function buildCatGrid() {
  const cats = getAllCats();
  const grid = document.getElementById('manualCatGrid');
  grid.innerHTML = cats.map(cat => `
    <button class="cat-btn ${cat.id===selectedCat?'selected':''}" id="catbtn-${cat.id}" onclick="selectCat('${cat.id}')">
      <div class="cat-icon-wrap">
        <span class="material-symbols-rounded" style="color:${cat.id===selectedCat?'var(--blue)':cat.color};font-size:24px;font-variation-settings:\"FILL\" 1;">${cat.icon}</span>
      </div>
      <span class="cat-name">${cat.name}</span>
    </button>`).join('') +
    `<button class="cat-add-btn" onclick="quickAddCatFromForm()">
      <div class="cat-icon-wrap" style="background:transparent;">
        <span class="material-symbols-rounded" style="color:var(--muted);font-size:24px;">add</span>
      </div>
      <span style="font-size:11px;font-weight:600;color:var(--muted);">Nueva</span>
    </button>`;
}

function selectCat(id) {
  // ‚òÖ "Otros" triggers name-your-category flow
  if (id === 'otros') {
    const custom = prompt('¬øC√≥mo quieres llamar a esta categor√≠a?\n(Se guardar√° como nueva categor√≠a)');
    if (custom && custom.trim()) {
      const newId = 'custom_' + Date.now();
      const customs = DB.get('customCats', []);
      customs.push({ id: newId, name: custom.trim(), icon:'more_horiz', color:'#64748B', emoji:'üì¶', system:false });
      DB.set('customCats', customs);
      selectedCat = newId;
      buildCatGrid();
      buildFilterChips();
      buildCatSelect();
      renderCatManager();
      showToast('‚úì Categor√≠a "' + custom.trim() + '" creada');
      return;
    }
  }
  selectedCat = id;
  document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('selected'));
  document.getElementById('catbtn-'+id)?.classList.add('selected');
}

function buildCatSelect() {
  // For confirm screen dropdown
  const sel = document.getElementById('confirmCategory');
  if (!sel) return;
  sel.innerHTML = getAllCats().map(c=>`<option value="${c.id}">${c.emoji||'üì¶'} ${c.name}</option>`).join('');
}

function renderCatManager() {
  const all = getAllCats();
  const el = document.getElementById('catManagerList');
  el.innerHTML = `<p class="lbl" style="margin-bottom:12px;">Categor√≠as del sistema</p>` +
    SYS_CATS.map(c=>`
      <div class="cat-manage-item">
        <div style="width:38px;height:38px;border-radius:10px;background:${c.color}18;display:flex;align-items:center;justify-content:center;">
          <span class="material-symbols-rounded" style="color:${c.color};font-size:20px;font-variation-settings:\"FILL\" 1;">${c.icon}</span>
        </div>
        <div style="flex:1;"><p style="font-size:15px;font-weight:600;">${c.name}</p></div>
        <span style="font-size:11px;font-weight:600;color:var(--muted);background:var(--bg);padding:3px 8px;border-radius:6px;">Sistema</span>
      </div>`).join('') +
    (DB.get('customCats',[]).length ? `<p class="lbl" style="margin:20px 0 12px;">Mis categor√≠as</p>` +
      DB.get('customCats',[]).map(c=>`
        <div class="cat-manage-item">
          <div style="width:38px;height:38px;border-radius:10px;background:${c.color}18;display:flex;align-items:center;justify-content:center;">
            <span class="material-symbols-rounded" style="color:${c.color};font-size:20px;font-variation-settings:\"FILL\" 1;">${c.icon}</span>
          </div>
          <div style="flex:1;"><p style="font-size:15px;font-weight:600;">${c.name}</p></div>
          <button onclick="deleteCat('${c.id}')" style="background:none;border:none;cursor:pointer;">
            <span class="material-symbols-rounded" style="color:var(--muted);font-size:20px;">delete</span>
          </button>
        </div>`).join('') : '') +
    `<div style="margin-top:20px;"><button class="btn-primary" onclick="openAddCategory()">+ Agregar categor√≠a nueva</button></div>`;
}

function quickAddCatFromForm() {
  closeOverlay('screenManual');
  openModal('screenCatManager');
  setTimeout(()=>openAddCategory(), 100);
}

function openAddCategory() {
  document.getElementById('newCatName').value = '';
  newCatColor = '#2563EB';
  newCatIcon = 'more_horiz';
  // Build icon picker
  document.getElementById('iconPicker').innerHTML = ICON_OPTIONS.map(icon=>
    `<button onclick="pickIcon('${icon}')" id="iconbtn-${icon}" style="width:44px;height:44px;border-radius:10px;border:2px solid transparent;background:var(--bg);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;">
      <span class="material-symbols-rounded" style="font-size:22px;color:var(--muted);font-variation-settings:\"FILL\" 1;">${icon}</span>
    </button>`).join('');
  openOverlay('screenAddCat');
}
function pickIcon(icon) {
  newCatIcon = icon;
  document.querySelectorAll('[id^="iconbtn-"]').forEach(b=>{ b.style.borderColor='transparent'; b.style.background='var(--bg)'; });
  const btn = document.getElementById('iconbtn-'+icon);
  if (btn) { btn.style.borderColor=newCatColor; btn.style.background=newCatColor+'22'; }
}
function pickCatColor(c) {
  newCatColor = c;
  document.querySelectorAll('.catcolor-pick').forEach(el=>el.style.border='3px solid transparent');
  document.querySelector(`.catcolor-pick[data-c="${c}"]`).style.border=`3px solid ${c}`;
}
function saveNewCat() {
  const name = document.getElementById('newCatName').value.trim();
  if (!name) { showToast('Ingresa un nombre'); return; }
  const id = 'custom_' + Date.now();
  const customs = DB.get('customCats', []);
  customs.push({ id, name, icon: newCatIcon, color: newCatColor, emoji:'üì¶', system:false });
  DB.set('customCats', customs);
  closeOverlay('screenAddCat');
  renderCatManager();
  buildCatGrid();
  buildFilterChips();
  buildCatSelect();
  showToast('‚úì Categor√≠a "' + name + '" creada');
}
function deleteCat(id) {
  // confirm blocked in sandbox ‚Äî proceed directly
  DB.set('customCats', DB.get('customCats',[]).filter(c=>c.id!==id));
  renderCatManager();
  buildCatGrid();
  buildFilterChips();
  showToast('Categor√≠a eliminada');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSTALLMENT ENGINE
// Splits a cuotas purchase into N transactions,
// one per future billing cycle.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addMonths(dateStr, n) {
  const d = new Date(dateStr + 'T12:00:00');
  const targetMonth = d.getMonth() + n;
  const targetYear = d.getFullYear() + Math.floor(targetMonth / 12);
  const normMonth = ((targetMonth % 12) + 12) % 12;
  // Clamp day to last day of target month
  const daysInTarget = new Date(targetYear, normMonth + 1, 0).getDate();
  const clampedDay = Math.min(d.getDate(), daysInTarget);
  return new Date(targetYear, normMonth, clampedDay).toISOString().split('T')[0];
}

function buildInstallmentTxns(base, purchaseDate, cuotas) {
  const installmentAmt = Math.ceil(base.amount / cuotas);
  const planId = 'plan_' + Date.now();
  const txns = [];

  if (cuotas <= 1) {
    txns.push({
      ...base,
      id: 'txn_' + Date.now(),
      date: purchaseDate,
      purchaseDate,
      cuotas: 1, cuotaNum: 1, planId: null,
      installmentAmt: base.amount,
    });
    return txns;
  }

  const cards = DB.get('cards', []);
  const card = cards.find(c => String(c.id) === String(base.cardId)) || cards.find(c => c.type === 'credito');
  const closeDay = card ? card.closeDay : 20;

  // First cuota billing cycle: the cycle CLOSING AFTER the purchase date
  const firstCycle = getCycleForDate(purchaseDate, closeDay);
  const firstCycleCloseDate = firstCycle.end.toISOString().split('T')[0];

  for (let i = 0; i < cuotas; i++) {
    // Each cuota date = closing date of its respective cycle
    // Cuota 1: first cycle close, Cuota 2: next month close, etc.
    const cuotaDate = addMonths(firstCycleCloseDate, i);
    txns.push({
      ...base,
      id: 'txn_' + Date.now() + '_c' + (i+1),
      // KEY FIX: cuota 1 date = purchaseDate ‚Üí appears in Block 1 of purchase month
      // Cuotas 2+ date = cycle close date ‚Üí appears in Block 2 of future months
      date: i === 0 ? purchaseDate : cuotaDate,
      purchaseDate,
      cuotas,
      cuotaNum: i + 1,
      planId,
      installmentAmt,
      amount: base.amount, // always store full amount; display logic uses installmentAmt
    });
  }
  return txns;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MANUAL ENTRY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedPayMethod = 'efectivo';

let selectedEntryType = 'gasto';
function selectEntryType(type) {
  selectedEntryType = type;
  document.getElementById('type-gasto').classList.toggle('active', type==='gasto');
  document.getElementById('type-ingreso').classList.toggle('active', type==='ingreso');
  // Hide payment method + cuotas for ingresos
  document.getElementById('payMethodSection').style.display = type==='ingreso' ? 'none' : 'block';
  document.getElementById('cuotasSection').style.display = 'none';
  document.getElementById('cardSelector').style.display = 'none';
  // Change save button color
  document.getElementById('saveManualBtn').style.background = type==='ingreso' ? 'var(--green)' : 'var(--blue)';
  document.getElementById('saveManualBtn').innerHTML = type==='ingreso'
    ? '<span class="material-symbols-rounded" style="font-variation-settings:\"FILL\" 1;">add_circle</span> Guardar Ingreso'
    : '<span class="material-symbols-rounded" style="font-variation-settings:\"FILL\" 1;">save</span> Guardar Gasto';
  // Update merchant label contextually
  const merchantLabel = document.getElementById('merchantFieldLabel');
  if (merchantLabel) merchantLabel.textContent = type==='ingreso' ? 'Descripci√≥n / Fuente' : 'Comercio (opcional)';
  const merchantInput = document.getElementById('manualMerchant');
  if (merchantInput) merchantInput.placeholder = type==='ingreso' ? 'Ej: Sueldo, Freelance, Arriendo...' : 'Ej: Jumbo, Copec...';
}
function selectPayMethod(m) {
  selectedPayMethod = m;
  ['efectivo','debito','tarjeta'].forEach(x => document.getElementById('pay-'+x)?.classList.toggle('active', x===m));
  // Show card selector for BOTH tarjeta and debito
  const needsCard = m==='tarjeta' || m==='debito';
  document.getElementById('cardSelector').style.display = needsCard ? 'block' : 'none';
  document.getElementById('cuotasSection').style.display = m==='tarjeta' ? 'block' : 'none';
  if (needsCard) populateCardSelect(m);
}
function populateCardSelect(method) {
  const all = DB.get('cards',[]);
  const cards = method==='debito'
    ? all.filter(c=>c.type==='debito')
    : all.filter(c=>c.type==='credito');
  const label = document.getElementById('cardSelectorLabel');
  if (label) label.textContent = method==='debito' ? 'Cuenta d√©bito' : 'Tarjeta de cr√©dito';
  document.getElementById('manualCard').innerHTML =
    `<option value="">Sin especificar</option>` +
    cards.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}
function toggleCuotas() {
  document.getElementById('cuotasInput').style.display = document.getElementById('cuotasToggle').checked ? 'block' : 'none';
}

function openManual(prefill={}) {
  selectedCat = prefill.category || 'comida';
  selectedPayMethod = prefill.payMethod || 'efectivo';
  selectedEntryType = 'gasto';
  document.getElementById('manualAmount').value = prefill.amount || '';
  document.getElementById('manualMerchant').value = prefill.merchant || '';
  document.getElementById('manualDate').value = prefill.date || today();
  document.getElementById('manualNote').value = '';
  document.getElementById('cuotasToggle').checked = false;
  document.getElementById('cuotasInput').style.display = 'none';
  document.getElementById('cuotasSection').style.display = 'none';
  document.getElementById('cardSelector').style.display = 'none';
  const recTog = document.getElementById('recurringToggle');
  if (recTog) recTog.checked = false;
  document.getElementById('payMethodSection').style.display = 'block';
  // Reset type toggle
  document.getElementById('type-gasto')?.classList.add('active');
  document.getElementById('type-ingreso')?.classList.remove('active');
  const btn = document.getElementById('saveManualBtn');
  if (btn) { btn.style.background=''; btn.innerHTML='<span class="material-symbols-rounded" style="font-variation-settings:\"FILL\" 1;">save</span> Guardar Gasto'; }
  buildCatGrid();
  ['efectivo','debito','tarjeta'].forEach(x => document.getElementById('pay-'+x)?.classList.toggle('active', x==='efectivo'));
  openOverlay('screenManual');
  setTimeout(()=>document.getElementById('manualAmount').focus(), 350);
}
function quickEntry(merchant, category) { openManual({ merchant, category }); }

async function saveManual() {
  const amount = parseInt(document.getElementById('manualAmount').value);
  if (!amount || amount<=0) { showToast('Ingresa un monto v√°lido'); return; }
  // Require card selection when paying with credit card
  if (selectedPayMethod === 'tarjeta' && selectedEntryType !== 'ingreso') {
    const cards = DB.get('cards',[]).filter(c=>c.type==='credito');
    if (cards.length > 0 && !selectedCardId) {
      showToast('Selecciona qu√© tarjeta usaste');
      document.getElementById('creditCardFields')?.scrollIntoView({behavior:'smooth',block:'center'});
      return;
    }
  }
  // Show loading state
  const saveBtn = document.getElementById('saveManualBtn');
  if (saveBtn) { saveBtn.disabled = true; saveBtn.innerHTML = '<span class="material-symbols-rounded" style="font-size:18px;vertical-align:-3px;margin-right:6px;animation:spin 1s linear infinite;">sync</span>Guardando...'; }

  // Handle INCOME separately
  if (selectedEntryType === 'ingreso') {
    const txn = {
      id: 'txn_'+Date.now(), type:'income', amount,
      merchant: document.getElementById('manualMerchant').value.trim() || 'Ingreso',
      category: 'ingresos',
      payMethod: document.getElementById('manualCard').value ? 'debito' : 'efectivo',
      cardId: document.getElementById('manualCard').value || null,
      date: document.getElementById('manualDate').value,
      note: document.getElementById('manualNote').value.trim(),
      cuotas:1, cuotaNum:1, installmentAmt:amount,
      source:'manual', createdAt: new Date().toISOString(),
    };
    let savedInc = [txn];
    try { savedInc = await SB.saveTxns([txn]); } catch(e) { console.warn('SB income save failed', e); }
    const txns = DB.get('transactions',[]);
    savedInc.forEach(t => txns.push(t));
    DB.set('transactions', txns);
    closeOverlay('screenManual');
    renderDashboard();
    if (document.getElementById('screenMovimientos').classList.contains('open')) renderMovimientos();
    showToast('‚úì Ingreso registrado: ' + clp(amount));
    return;
  }

  const cuotasOn = document.getElementById('cuotasToggle').checked;
  const cuotas = cuotasOn ? Math.max(2,parseInt(document.getElementById('numCuotas').value)||12) : 1;
  const cardId = document.getElementById('manualCard').value || null;
  const purchaseDate = document.getElementById('manualDate').value;
  const base = {
    type:'expense', amount,
    merchant: document.getElementById('manualMerchant').value.trim(),
    category: selectedCat, payMethod: selectedPayMethod, cardId,
    note: document.getElementById('manualNote').value.trim(),
    source:'manual', createdAt: new Date().toISOString(),
  };
  const newTxns = buildInstallmentTxns(base, purchaseDate, cuotas);

  // Save to Supabase FIRST to get real IDs
  let savedM = newTxns;
  try { savedM = await SB.saveTxns(newTxns); } catch(e) { console.warn('SB save failed', e); }

  // Handle recurring AFTER SB save so rootTxn.id is real
  const isRecurring = document.getElementById('recurringToggle')?.checked;
  if (isRecurring && cuotas === 1 && savedM[0]) {
    const rootTxn = savedM[0];
    savedM[0] = { ...rootTxn, recurring: true };
    try { await SB.updateTxn(rootTxn.id, { recurring: true }); } catch(e) { console.warn(e); }
    const pending = DB.get('pendingRecurring', []);
    for (let m = 1; m <= 12; m++) {
      const d = new Date(purchaseDate + 'T12:00:00');
      d.setMonth(d.getMonth() + m);
      pending.push({
        id: 'pend_' + Date.now() + '_' + m,
        type: 'recurring',
        basedOn: rootTxn.id,
        suggestedDate: d.toISOString().split('T')[0],
        amount: rootTxn.amount,
        merchant: rootTxn.merchant,
        category: rootTxn.category,
        payMethod: rootTxn.payMethod,
        cardId: rootTxn.cardId,
        note: rootTxn.note,
        status: 'pending',
        createdAt: new Date().toISOString(),
      });
    }
    DB.set('pendingRecurring', pending);
    try { await savePendingToSB(pending); } catch(e) { console.warn('SB pending save failed', e); }
  }

  // Push savedM (real IDs from Supabase) to local DB
  const txns = DB.get('transactions', []);
  savedM.forEach(t => txns.push(t));
  DB.set('transactions', txns);
  closeOverlay('screenManual');
  renderDashboard();
  if (document.getElementById('screenMovimientos').classList.contains('open')) renderMovimientos();
  const toastMsg = isRecurring
    ? '‚úì Guardado ¬∑ 12 sugerencias pendientes creadas'
    : cuotas > 1 ? '‚úì Gasto en ' + cuotas + ' cuotas guardado' : '‚úì Gasto guardado';
  // Reset save button
  const saveBtnReset = document.getElementById('saveManualBtn');
  if (saveBtnReset) { saveBtnReset.disabled = false; saveBtnReset.innerHTML = '<span class="material-symbols-rounded" style="font-size:18px;vertical-align:-3px;margin-right:6px;">save</span>Guardar gasto'; }
  showToast(toastMsg);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CAMERA + UPLOAD + OCR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCamera() { openOverlay('screenCamera'); }
function openUpload() { openOverlay('screenUpload'); }
function triggerFile(src) {
  document.getElementById(src==='camera'?'cameraInput':'uploadInput').click();
}
// ‚îÄ‚îÄ OCR ABORT CONTROLLER ‚îÄ‚îÄ
let ocrAbortController = null;

function cancelOCR() {
  // Signal the fetch to abort
  if (ocrAbortController) {
    ocrAbortController.abort();
    ocrAbortController = null;
  }
  closeOverlay('screenOCR');
  // Don't open confirm screen ‚Äî just go back silently
}

// ‚îÄ‚îÄ API KEY MANAGEMENT ‚îÄ‚îÄ
function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key.startsWith('sk-')) { showToast('Key inv√°lida ‚Äî debe empezar con sk-'); return; }
  STORE['openai_key'] = key;
  document.getElementById('apiKeyInput').value = '';
  updateApiKeyStatus();
  showToast('‚úì API Key guardada');
}
function getApiKey() { return STORE['openai_key'] || ''; }
function updateApiKeyStatus() {
  const el = document.getElementById('apiKeyStatus');
  if (!el) return;
  const key = getApiKey();
  const inputVal = document.getElementById('apiKeyInput')?.value || '';
  if (key) {
    el.textContent = '‚úì Configurada ‚Äî OCR real activo';
    el.style.color = 'var(--green)';
  } else if (inputVal.startsWith('sk-')) {
    el.textContent = 'Lista para guardar';
    el.style.color = 'var(--amber)';
  } else {
    el.textContent = 'No configurada ‚Äî OCR usa simulaci√≥n';
    el.style.color = 'var(--muted)';
  }
}

// ‚îÄ‚îÄ OCR: REAL (OpenAI Vision) or FALLBACK (simulation) ‚îÄ‚îÄ
function processFile(input) {
  const file = input.files[0]; if (!file) return;
  closeOverlay('screenCamera'); closeOverlay('screenUpload');
  // Fresh abort controller for this OCR run
  ocrAbortController = new AbortController();
  openOverlay('screenOCR');
  const reader = new FileReader();
  reader.onload = async e => {
    const dataUrl = e.target.result;
    const apiKey = getApiKey();
    await runRealOCR(dataUrl, file.type);
  };
  reader.readAsDataURL(file);
  input.value='';
}

async function runRealOCR(dataUrl, fileType) {
  const setMsg = (main, sub) => {
    const m = document.getElementById('ocrMessage');
    const s = document.getElementById('ocrSubMessage');
    if (m) m.textContent = main;
    if (s) s.textContent = sub || '';
  };
  setMsg('Analizando boleta‚Ä¶', 'Enviando imagen a la IA‚Ä¶');

  try {
    const base64 = dataUrl.split(',')[1];
    // Detect media type ‚Äî default jpeg if not image (e.g. PDF treated as image)
    const mediaType = (fileType && fileType.startsWith('image/')) ? fileType : 'image/jpeg';

    setMsg('Procesando‚Ä¶', 'Enviando a GPT-4o‚Ä¶');

    const response = await fetch(SUPABASE_URL + '/functions/v1/ocr-receipt', {
      method: 'POST',
      signal: ocrAbortController?.signal,
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + SUPABASE_KEY },
      body: JSON.stringify({ imageBase64: base64, mediaType })
    });
    if (!response.ok) {
      const errData = await response.json().catch(() => ({}));
      throw new Error(errData.error || 'Error ' + response.status);
    }
    setMsg('Extrayendo datos‚Ä¶', 'Casi listo‚Ä¶');
    const json = await response.json();
    if (!json.success) throw new Error(json.error || 'Error en el servidor');
    const result = json.data;
    if (!result.amount && result.amount !== 0) throw new Error('No se detect√≥ monto en la boleta');

    setMsg('¬°Listo!', 'Datos extra√≠dos correctamente');
    await new Promise(r => setTimeout(r, 400)); // brief success pause

    closeOverlay('screenOCR');
    showOCRResult(dataUrl, fileType, result);

  } catch (err) {
    // If user cancelled ‚Äî abort error is expected, just stop silently
    if (err.name === 'AbortError' || ocrAbortController?.signal.aborted) return;
    console.error('OCR error:', err);
    const isCORS = err instanceof TypeError;
    const userMsg = isCORS
      ? 'Error de red ‚Äî abre el archivo directamente en Chrome (no en el visor de Claude)'
      : err.message.substring(0, 80);
    setMsg('Error de conexi√≥n', userMsg);
    await new Promise(r => setTimeout(r, 2500));
    if (ocrAbortController?.signal.aborted) return; // cancelled during error pause
    closeOverlay('screenOCR');
    showOCRResult(dataUrl, fileType, null, userMsg);
  }
}

function showOCRResult(dataUrl, fileType, result, errorMsg) {
  // result = { merchant, amount, date, category, confidence } or null
  const isReal = !!result && !errorMsg;
  const confidence = result?.confidence || (errorMsg ? 'error' : 'simulada');

  // Map category from OCR to our system categories
  const catMap = {
    'comida': 'comida', 'restaurante': 'comida', 'supermercado': 'comida',
    'transporte': 'transporte', 'bencina': 'transporte', 'uber': 'transporte',
    'compras': 'compras', 'ropa': 'compras', 'tienda': 'compras',
    'salud': 'salud', 'farmacia': 'salud', 'medico': 'salud',
    'servicios': 'servicios', 'entretenimiento': 'entretenimiento',
    'educacion': 'educacion', 'otros': 'otros'
  };
  const mappedCat = catMap[result?.category?.toLowerCase()] || result?.category || 'compras';

  document.getElementById('confirmMerchant').value = result?.merchant || '';
  document.getElementById('confirmAmount').value = result?.amount > 0 ? result.amount : '';
  document.getElementById('confirmDate').value = result?.date || today();
  document.getElementById('confirmCategory').value = mappedCat;
  document.getElementById('confirmTimestamp').textContent =
    isReal ? 'Analizado con IA ¬∑ ' + new Date().toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'})
           : errorMsg ? 'Error de an√°lisis ‚Äî completa manualmente'
           : 'Simulaci√≥n ‚Äî ingresa tu API key para OCR real';

  const badge = document.getElementById('confidenceBadge');
  const confLabel = confidence === 'alta' ? 'Alta' : confidence === 'media' ? 'Media' : confidence === 'baja' ? 'Baja' : confidence === 'error' ? 'Error' : 'Demo';
  const confClass = confidence === 'alta' ? 'conf-alta' : confidence === 'media' ? 'conf-media' : 'conf-baja';
  badge.className = 'conf-badge ' + confClass;
  badge.innerHTML = `<span class="material-symbols-rounded" style="font-size:16px;font-variation-settings:\"FILL\" 1;">${isReal ? 'verified' : 'info'}</span> Confianza: ${confLabel}`;

  const confText = document.getElementById('confidenceText');
  if (errorMsg) {
    confText.textContent = 'No se pudo leer la boleta: ' + errorMsg.substring(0, 60);
    confText.style.color = 'var(--red)';
  } else if (isReal) {
    confText.textContent = confidence === 'alta' ? 'Datos extra√≠dos correctamente ‚Äî revisa y confirma' :
                           confidence === 'media' ? 'Algunos campos pueden tener errores ‚Äî revisa bien' :
                           'Imagen poco clara ‚Äî verifica todos los campos';
    confText.style.color = 'var(--text)';
  } else {
    confText.textContent = 'Modo demo ‚Äî configura tu API key en Ajustes para OCR real';
    confText.style.color = 'var(--muted)';
  }

  if (fileType && fileType.startsWith('image')) {
    document.getElementById('receiptThumb').innerHTML =
      `<img src="${dataUrl}" style="width:100%;height:100%;object-fit:cover;"/>`;
  }
  buildCatSelect();
  // Re-set category after buildCatSelect rebuilds the dropdown
  setTimeout(() => {
    const sel = document.getElementById('confirmCategory');
    if (sel && mappedCat) sel.value = mappedCat;
  }, 50);
  // Default to Cr√©dito if user has credit cards, otherwise Efectivo
  const hasCredit = DB.get('cards',[]).some(c => c.type === 'credito');
  selectConfirmPay(hasCredit ? 'tarjeta' : 'efectivo');
  document.getElementById('confirmCuotasToggle').checked = false;
  document.getElementById('confirmCuotasInput').style.display = 'none';
  // Reset note field
  const noteEl = document.getElementById('confirmNote');
  if (noteEl) noteEl.value = '';
  // Store receipt image so saveConfirmed can attach it to the transaction
  STORE['pendingReceiptDataUrl'] = (dataUrl && fileType && fileType.startsWith('image')) ? dataUrl : null;
  openOverlay('screenConfirm');
}
function selectConfirmPay(m) {
  ['efectivo','debito','tarjeta'].forEach(x => document.getElementById('cpay-'+x)?.classList.toggle('active', x===m));
  const selector = document.getElementById('confirmCardSelector');
  const label = document.getElementById('confirmCardLabel');
  if (!selector) return;
  if (m === 'tarjeta' || m === 'debito') {
    selector.style.display = 'block';
    const cards = DB.get('cards', []).filter(c => m === 'debito' ? c.type === 'debito' : c.type === 'credito');
    if (label) label.textContent = m === 'debito' ? 'Cuenta d√©bito' : 'Tarjeta de cr√©dito';
    const sel = document.getElementById('confirmCardSelect');
    if (sel) {
      if (!cards.length) {
        sel.innerHTML = '<option value="">Sin tarjetas ‚Äî agrega en Ajustes</option>';
      } else {
        sel.innerHTML = cards.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      }
    }
  } else {
    selector.style.display = 'none';
  }
}
function toggleConfirmCuotas() {
  document.getElementById('confirmCuotasInput').style.display = document.getElementById('confirmCuotasToggle').checked ? 'block' : 'none';
}
async function saveConfirmed() {
  const amount = parseInt(document.getElementById('confirmAmount').value);
  if (!amount||amount<=0) { showToast('Monto inv√°lido'); return; }
  const cuotasOn = document.getElementById('confirmCuotasToggle').checked;
  const cuotas = cuotasOn ? Math.max(2,parseInt(document.getElementById('confirmNumCuotas').value)||12) : 1;
  const payMethod = ['efectivo','debito','tarjeta'].find(m=>document.getElementById('cpay-'+m)?.classList.contains('active'))||'efectivo';
  const purchaseDate = document.getElementById('confirmDate').value;
  const cardId = (payMethod === 'tarjeta' || payMethod === 'debito')
    ? document.getElementById('confirmCardSelect')?.value || null
    : null;
  const note = document.getElementById('confirmNote')?.value.trim() || '';
  const receiptDataUrl = STORE['pendingReceiptDataUrl'] || null;
  const base = {
    type:'expense', amount,
    merchant: document.getElementById('confirmMerchant').value.trim(),
    category: document.getElementById('confirmCategory').value,
    payMethod, cardId,
    note, receiptDataUrl,
    source:'ocr', createdAt: new Date().toISOString(),
  };
  const newTxns = buildInstallmentTxns(base, purchaseDate, cuotas);
  // Attach dataUrl locally so receipt shows immediately
  if (receiptDataUrl) newTxns[0].receiptDataUrl = receiptDataUrl;
  let savedC = newTxns;
  try {
    savedC = await SB.saveTxns(newTxns);
    if (receiptDataUrl && savedC[0]) {
      const url = await SB.uploadReceipt(receiptDataUrl, savedC[0].id);
      if (url) { savedC[0].receiptUrl = url; await SB.updateTxn(savedC[0].id, {receiptUrl: url}); }
      savedC[0].receiptDataUrl = receiptDataUrl; // keep local copy for immediate display
    }
  } catch(e) { console.warn('SB save failed', e); savedC = newTxns; }
  const txnsC = DB.get('transactions', []);
  savedC.forEach(t => txnsC.push(t));
  DB.set('transactions', txnsC);
  STORE['pendingReceiptDataUrl'] = null;
  closeOverlay('screenConfirm');
  renderDashboard();
  if (document.getElementById('screenMovimientos').classList.contains('open')) renderMovimientos();
  showToast(cuotas > 1 ? '\u2713 Gasto en ' + cuotas + ' cuotas guardado' : '\u2713 Gasto guardado');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETALLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentTxnId = null;
function openDetalle(id) {
  currentTxnId = id;
  const allTxns = DB.get('transactions',[]);
  const t = allTxns.find(x=>x.id===id);
  if (!t) return;
  const cat = getCat(t.category);
  const isIncome = t.type==='income';
  const isInstallment = t.cuotas > 1;
  const fullAmt = isInstallment ? (t.installmentAmt * t.cuotas) : t.amount;
  const instAmt = t.installmentAmt || Math.ceil(t.amount / t.cuotas);

  // Build installment plan section if applicable
  let planSection = '';
  if (isInstallment && t.planId) {
    const planTxns = allTxns
      .filter(x => x.planId === t.planId)
      .sort((a,b) => a.cuotaNum - b.cuotaNum);
    const rows = planTxns.map(c => {
      const isPast = new Date(c.date+'T12:00:00') < new Date();
      const statusIcon = isPast ? '‚úì' : '‚óã';
      const statusColor = isPast ? 'var(--green)' : 'var(--muted)';
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:13px;color:${statusColor};font-weight:700;">${statusIcon}</span>
          <div>
            <p style="font-size:13px;font-weight:600;">Cuota ${c.cuotaNum} de ${c.cuotas}</p>
            <p style="font-size:11px;color:var(--muted);">${fullDate(c.date)}</p>
          </div>
        </div>
        <p style="font-size:14px;font-weight:800;color:${isPast?'var(--muted)':'var(--red)'};">${clp(c.installmentAmt)}</p>
      </div>`;
    }).join('');
    planSection = `
    <div class="card" style="margin-bottom:16px;overflow:hidden;">
      <div style="padding:12px 16px;background:rgba(139,92,246,0.12);border-bottom:1px solid #DDD6FE;">
        <p style="font-size:12px;font-weight:800;color:#A78BFA;">Plan de cuotas ‚Äî ${t.cuotas} pagos</p>
        <p style="font-size:11px;color:#A78BFA;margin-top:2px;">Total: ${clp(fullAmt)} ¬∑ ${clp(instAmt)}/mes</p>
      </div>
      <div style="padding:0 16px;">${rows}</div>
    </div>`;
  }

  // Receipt hero section ‚Äî big if has photo, small icon if not
  const hasReceipt = !!(t.receiptUrl || t.receiptDataUrl);
  const heroSection = hasReceipt ? `
    <div style="margin:-0px -0px 0;position:relative;background:${cat.color}18;border-radius:0;overflow:hidden;">
      <div style="padding:16px 20px 12px;display:flex;align-items:center;justify-content:space-between;">
        <p style="font-size:11px;font-weight:700;color:${cat.color};text-transform:uppercase;letter-spacing:0.06em;">üì∑ Comprobante adjunto</p>
        <span style="font-size:11px;color:var(--muted);">${fullDate(t.purchaseDate||t.date)}</span>
      </div>
      <div style="padding:0 20px 16px;display:flex;justify-content:center;">
        <img src="${t.receiptDataUrl || t.receiptUrl}"
          style="width:100%;max-height:220px;object-fit:contain;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.15);"
          onclick="this.style.maxHeight=this.style.maxHeight==='none'?'220px':'none'"
          onerror="this.src='';this.style.display='none';this.nextElementSibling.style.display='flex'"
        /><div style="display:none;align-items:center;justify-content:center;padding:20px;background:rgba(139,92,246,0.12);border-radius:12px;flex-direction:column;gap:8px;"><span class='material-symbols-rounded' style='color:#A78BFA;font-size:40px;font-variation-settings:"FILL" 1;'>receipt_long</span><p style='font-size:12px;color:#A78BFA;'>Comprobante guardado en servidor</p></div>
      </div>
      <!-- Amount overlay -->
      <div style="padding:16px 20px 20px;text-align:center;">
        <div style="font-size:40px;font-weight:800;color:${isIncome?'var(--green)':'var(--red)'};">${isIncome?'+':'-'}${clp(fullAmt)}</div>
        ${isInstallment?`<div style="margin-top:6px;"><span class="cuota-badge">${t.cuotas} cuotas ¬∑ ${clp(instAmt)}/mes</span></div>`:''}
      </div>
    </div>` : `
    <div style="text-align:center;padding:20px 0 16px;">
      <div style="width:64px;height:64px;border-radius:18px;background:${cat.color}18;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;">
        <span class="material-symbols-rounded" style="font-size:34px;color:${cat.color};font-variation-settings:\"FILL\" 1;">${cat.icon}</span>
      </div>
      <div style="font-size:38px;font-weight:800;color:${isIncome?'var(--green)':'var(--red)'};">${isIncome?'+':'-'}${clp(fullAmt)}</div>
      ${isInstallment?`<div style="margin-top:6px;"><span class="cuota-badge">${t.cuotas} cuotas ¬∑ ${clp(instAmt)}/mes</span></div>`:''}
      <p style="font-size:13px;color:var(--muted);margin-top:6px;">${fullDate(t.purchaseDate||t.date)}</p>
    </div>`;

  document.getElementById('detalleContent').innerHTML = `
    ${heroSection}
    <div style="padding:0 20px;">
    <div class="card" style="margin-bottom:16px;margin-top:${hasReceipt?'16px':'0'};overflow:hidden;">
      <div style="padding:14px 16px;border-bottom:1px solid var(--border);">
        <div class="lbl" style="margin-bottom:6px;">Comercio</div>
        <input type="text" class="form-input" id="det-merchant" value="${t.merchant||''}" placeholder="Sin nombre" style="padding:8px 12px;font-size:15px;"/>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border);">
        <div style="padding:14px 16px;border-right:1px solid var(--border);">
          <div class="lbl" style="margin-bottom:6px;">Fecha compra</div>
          <input type="date" class="form-input" id="det-date" value="${t.purchaseDate||t.date}" style="padding:8px 12px;font-size:14px;"/>
        </div>
        <div style="padding:14px 16px;">
          <div class="lbl" style="margin-bottom:6px;">Monto total CLP</div>
          <input type="number" class="form-input" id="det-amount" value="${fullAmt}" style="padding:8px 12px;font-size:14px;" inputmode="numeric" ${isInstallment?'readonly style="padding:8px 12px;font-size:14px;background:rgba(255,255,255,0.04);"':''}/>
        </div>
      </div>
      <div style="padding:14px 16px;border-bottom:1px solid var(--border);">
        <div class="lbl" style="margin-bottom:6px;">Categor√≠a</div>
        <select class="form-select" id="det-category" style="padding:8px 12px;font-size:15px;">
          ${getAllCats().map(c=>`<option value="${c.id}" ${c.id===t.category?'selected':''}>${c.emoji||'üì¶'} ${c.name}</option>`).join('')}
        </select>
      </div>
      <div style="padding:14px 16px;">
        <div class="lbl" style="margin-bottom:6px;">M√©todo de pago</div>
        <select class="form-select" id="det-paymethod" style="padding:8px 12px;font-size:14px;" onchange="detUpdatePayMethod()">
          <option value="efectivo" ${t.payMethod==='efectivo'?'selected':''}>üíµ Efectivo</option>
          <option value="debito" ${t.payMethod==='debito'?'selected':''}>üè¶ D√©bito</option>
          <option value="tarjeta" ${t.payMethod==='tarjeta'?'selected':''}>üí≥ Tarjeta cr√©dito</option>
        </select>
      </div>
      <div id="det-card-section" style="padding:0 16px 14px;${t.payMethod!=='tarjeta'?'display:none;':''}">
        <div class="lbl" style="margin-bottom:6px;">Tarjeta</div>
        <select class="form-select" id="det-card" style="padding:8px 12px;font-size:14px;">
          <option value="">Sin especificar</option>
          ${DB.get('cards',[]).filter(x=>x.type==='credito').map(x=>`<option value="${x.id}" ${t.cardId===x.id?'selected':''}>${x.name}</option>`).join('')}
        </select>
      </div>
    </div>
    ${planSection}
    ${!isInstallment ? `
    <div class="card card-p" style="margin-bottom:16px;">
      <div class="toggle-row">
        <div><div style="font-size:15px;font-weight:600;">Gasto recurrente</div><div style="font-size:12px;color:var(--muted);">Se replica cada mes por 12 meses</div></div>
        <label class="toggle"><input type="checkbox" id="det-recurring" ${t.recurring?'checked':''}/><span class="toggle-slider"></span></label>
      </div>
    </div>` : ''}
    <div class="form-field" style="margin-bottom:24px;">
      <label class="form-label">Comentario</label>
      <input type="text" class="form-input" id="det-note" value="${t.note||''}" placeholder="Agrega un comentario‚Ä¶"/>
    </div>
    </div>`;
  openOverlay('screenDetalle');
}
function toggleDetCuotas() {
  document.getElementById('det-cuotas-wrap').style.display = document.getElementById('det-cuotas').checked ? 'block' : 'none';
}
function detUpdatePayMethod() {
  const val = document.getElementById('det-paymethod')?.value;
  const cardSection = document.getElementById('det-card-section');
  if (cardSection) cardSection.style.display = val === 'tarjeta' ? 'block' : 'none';
}
async function saveDetalle() {
  const txns = DB.get('transactions',[]);
  const idx = txns.findIndex(t=>t.id===currentTxnId);
  if (idx===-1) return;
  // Use optional chaining ‚Äî some fields may not exist for all txn types
  const cuotasOn = document.getElementById('det-cuotas')?.checked || false;
  const newPayMethod = document.getElementById('det-paymethod')?.value || txns[idx].payMethod;
  const newCardId = document.getElementById('det-card')?.value || txns[idx].cardId || null;
  const updates = {
    merchant: document.getElementById('det-merchant')?.value?.trim() || txns[idx].merchant,
    date: document.getElementById('det-date')?.value || txns[idx].date,
    amount: parseInt(document.getElementById('det-amount')?.value) || txns[idx].amount,
    payMethod: newPayMethod,
    cardId: newPayMethod === 'tarjeta' ? newCardId : null,
    category: document.getElementById('det-category')?.value || txns[idx].category,
    cuotas: cuotasOn ? parseInt(document.getElementById('det-num-cuotas')?.value)||1 : txns[idx].cuotas,
    recurring: document.getElementById('det-recurring')?.checked || false,
    note: document.getElementById('det-note')?.value || '',
  };
  txns[idx] = { ...txns[idx], ...updates };
  DB.set('transactions', txns);
  // Persist to Supabase
  try {
    await SB.updateTxn(currentTxnId, {
      merchant: txns[idx].merchant,
      amount: txns[idx].amount,
      category: txns[idx].category,
      date: txns[idx].date,
      note: txns[idx].note,
      recurring: txns[idx].recurring,
    });
  } catch(e) { console.warn('SB update failed', e); }
  closeOverlay('screenDetalle');
  renderDashboard();
  if (document.getElementById('screenMovimientos').classList.contains('open')) renderMovimientos();
  showToast('‚úì Cambios guardados');
}
async function deleteCurrentTxn() {
  // Delete this transaction (and sibling cuotas from same plan)
  const txns = DB.get('transactions',[]);
  const target = txns.find(t=>t.id===currentTxnId);
  let filtered;
  if (target && target.planId) {
    // Delete all cuotas of same plan
    filtered = txns.filter(t=>t.planId!==target.planId);
    showToast('‚úì Compra en cuotas eliminada (' + target.cuotas + ' cuotas)');
  } else {
    filtered = txns.filter(t=>t.id!==currentTxnId);
    showToast('‚úì Movimiento eliminado');
  }
  DB.set('transactions', filtered);
  // Persist to Supabase
  try {
    if (target && target.planId) {
      await supa.from('transactions').delete().eq('plan_id', target.planId).eq('user_id', CURRENT_USER?.id);
    } else {
      await supa.from('transactions').delete().eq('id', currentTxnId).eq('user_id', CURRENT_USER?.id);
    }
  } catch(e) { console.warn('SB delete failed', e); }
  closeOverlay('screenDetalle');
  renderDashboard();
  if (document.getElementById('screenMovimientos').classList.contains('open')) renderMovimientos();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedCardColor = '#2563EB';
let selectedCardType = 'credito';

// ‚îÄ‚îÄ‚îÄ Card Detail ‚îÄ‚îÄ‚îÄ
let currentDetailCardId = null;
let currentDetailTab = 'actual';

function openCardDetail(cardId) {
  currentDetailCardId = cardId;
  currentDetailTab = 'actual';
  const card = DB.get('cards',[]).find(c => String(c.id) === String(cardId));
  if (!card) return;
  document.getElementById('cardDetailTitle').textContent = card.name;
  renderCardDetail();
  openModal('screenCardDetail');
}

function switchCardTab(tab) {
  currentDetailTab = tab;
  ['actual','proximo','historial'].forEach(t => {
    const btn = document.getElementById('cardTab_'+t);
    if (btn) btn.classList.toggle('active', t===tab);
  });
  renderCardDetailContent();
}

function renderCardDetail() {
  const card = DB.get('cards',[]).find(c => String(c.id) === String(currentDetailCardId));
  if (!card) return;
  const grad = getCardGradient(card.color);
  const network = getCardNetwork(card.name);
  const last4 = card.last4 ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + card.last4 : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  const el = document.getElementById('cardDetailContent');
  el.innerHTML = `
    <!-- Mini visual card -->
    <div style="padding:20px 20px 0;">
      <div class="card-visual" style="background:${grad};height:160px;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;position:relative;z-index:1;">
          <div class="card-chip"></div>
          <span class="card-network">${network}</span>
        </div>
        <div style="position:relative;z-index:1;">
          <div class="card-number">${last4}</div>
          <div style="display:flex;justify-content:space-between;margin-top:8px;">
            <div><div class="card-lbl">Titular</div><div class="card-val" style="font-size:12px;">${card.name}</div></div>
            <div style="text-align:right;"><div class="card-lbl">Cierre ¬∑ Vence</div><div class="card-val">d√≠a ${card.closeDay} ¬∑ d√≠a ${card.dueDay}</div></div>
          </div>
        </div>
      </div>
    </div>
    <!-- Segment control -->
    <div class="seg-ctrl" style="margin-top:16px;">
      <button class="seg-btn active" id="cardTab_actual" onclick="switchCardTab('actual')">Ciclo Actual</button>
      <button class="seg-btn" id="cardTab_proximo" onclick="switchCardTab('proximo')">Pr√≥ximo</button>
      <button class="seg-btn" id="cardTab_historial" onclick="switchCardTab('historial')">Historial</button>
    </div>
    <div id="cardDetailTabContent"></div>`;
  renderCardDetailContent();
}

function renderCardDetailContent() {
  const card = DB.get('cards',[]).find(c => String(c.id) === String(currentDetailCardId));
  if (!card) return;
  const el = document.getElementById('cardDetailTabContent');
  const now = new Date();

  if (currentDetailTab === 'actual') {
    const cycle = getCycleClosingInMonth(card.closeDay, card.dueDay, now);
    let cycleTxns = getCreditTxnsForCycle(card, now);
    // If no txns found with this card's ID, try matching by payMethod only (single-card users)
    if (cycleTxns.length === 0) {
      const allCards = DB.get('cards',[]).filter(c=>c.type==='credito');
      if (allCards.length === 1) {
        const allTxns = DB.get('transactions',[]);
        cycleTxns = allTxns.filter(t => {
          if (t.type==='income' || t.payMethod!=='tarjeta') return false;
          const d = new Date((t.purchaseDate||t.date)+'T12:00:00');
          return d >= cycle.start && d <= cycle.end;
        });
      }
    }
    let consumo = 0, cuotasTotal = 0;
    const cuotaItems = [], singleItems = [];
    cycleTxns.forEach(t => {
      const amt = t.cuotas > 1 ? (t.installmentAmt || Math.ceil(t.amount / t.cuotas)) : t.amount;
      if (t.cuotas > 1) { cuotasTotal += amt; cuotaItems.push(t); }
      else { consumo += amt; singleItems.push(t); }
    });
    const total = consumo + cuotasTotal;
    const dueStr = cycle.dueDate.toLocaleDateString('es-CL', {day:'numeric', month:'long'});
    const daysLeft = Math.ceil((cycle.dueDate - now) / 86400000);
    const cycleStr = cycle.start.toLocaleDateString('es-CL',{day:'numeric',month:'short'}) + ' ‚Äì ' + cycle.end.toLocaleDateString('es-CL',{day:'numeric',month:'short'});

    // Urgency colors
    const urgBg = daysLeft<=5 ? 'rgba(239,68,68,0.12)' : daysLeft<=10 ? 'rgba(245,158,11,0.12)' : 'rgba(59,130,246,0.10)';
    const urgBorder = daysLeft<=5 ? 'rgba(239,68,68,0.3)' : daysLeft<=10 ? 'rgba(245,158,11,0.3)' : 'rgba(59,130,246,0.25)';
    const urgColor = daysLeft<=5 ? '#EF4444' : daysLeft<=10 ? '#F59E0B' : '#3B82F6';

    // Single txns list (up to 3 + overflow)
    const singleHtml = singleItems.length === 0 ? '' :
      singleItems.slice(0,3).map(t => {
        const cat = getCat(t.category);
        return `<div class="cuota-line"><span style="color:var(--muted);">‚îî ${t.merchant||cat.name}</span><span>${clp(t.amount)}</span></div>`;
      }).join('') +
      (singleItems.length > 3 ? `<div class="cuota-line"><span style="color:var(--muted);">‚îî +${singleItems.length-3} m√°s</span><span>${clp(singleItems.slice(3).reduce((s,t)=>s+t.amount,0))}</span></div>` : '');

    // Cuotas list (up to 4 + link)
    const cuotaHtml = cuotaItems.length === 0
      ? `<div style="font-size:13px;color:var(--muted);padding:6px 0;">Sin cuotas en este ciclo</div>`
      : cuotaItems.slice(0,4).map(t => {
          const amt = t.installmentAmt || Math.ceil(t.amount/t.cuotas);
          return `<div class="cuota-line">
            <span style="display:flex;align-items:center;gap:6px;">
              <span style="font-size:10px;background:rgba(167,139,250,0.15);color:#A78BFA;padding:2px 6px;border-radius:10px;font-weight:700;">${t.cuotaNum||'?'}/${t.cuotas}</span>
              <span style="color:var(--muted);">${t.merchant||'Cuota'}</span>
            </span>
            <span style="color:#A78BFA;font-weight:600;">${clp(amt)}</span>
          </div>`;
        }).join('') +
        (cuotaItems.length > 4 ? `<div style="padding:8px 0 0;"><span style="font-size:13px;color:var(--blue);cursor:pointer;">Ver todas las cuotas ‚Üí</span></div>` : '');

    // Recent txns (up to 5)
    const recentHtml = cycleTxns.length === 0
      ? `<div style="text-align:center;padding:24px;color:var(--muted);font-size:13px;">Sin movimientos en este ciclo</div>`
      : cycleTxns.slice(0,5).map(t => {
          const cat = getCat(t.category);
          const amt = t.cuotas>1 ? (t.installmentAmt||Math.ceil(t.amount/t.cuotas)) : t.amount;
          return `<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);cursor:pointer;" onclick="openDetalle('${t.id}')">
            <div class="txn-icon" style="background:${cat.color}18;flex-shrink:0;">
              <span class="material-symbols-rounded" style="color:${cat.color};font-size:18px;font-variation-settings:'FILL' 1;">${cat.icon}</span>
            </div>
            <div style="flex:1;min-width:0;">
              <div style="font-size:14px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.merchant||cat.name}</div>
              <div style="font-size:11px;color:var(--muted);">${t.date}</div>
            </div>
            <div style="font-size:14px;font-weight:700;color:var(--red);flex-shrink:0;">-${clp(amt)}</div>
          </div>`;
        }).join('');

    el.innerHTML = `
      <!-- Cycle header -->
      <div class="cyc-block" style="margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <span style="font-size:11px;color:var(--muted);">üìÖ ${cycleStr}</span>
          <span style="font-size:11px;color:var(--muted);">${Math.round(total>0?(consumo+cuotasTotal)/total*100:0)}% utilizado</span>
        </div>
        <!-- Stacked progress bar -->
        <div style="height:6px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;display:flex;">
          <div style="width:${total>0?Math.min(100,consumo/total*100):0}%;background:var(--blue);transition:width 0.6s ease;"></div>
          <div style="width:${total>0?Math.min(100,cuotasTotal/total*100):0}%;background:#A78BFA;transition:width 0.6s ease;"></div>
        </div>
        <div style="display:flex;gap:14px;margin-top:8px;">
          <span style="font-size:11px;color:var(--blue);">‚óè Consumo ${clp(consumo)}</span>
          <span style="font-size:11px;color:#A78BFA;">‚óè Cuotas ${clp(cuotasTotal)}</span>
        </div>
      </div>

      <!-- Consumo section -->
      <div class="cyc-block" style="margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span style="font-size:11px;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:0.07em;">Consumo (compras del ciclo)</span>
          <span style="font-size:16px;font-weight:800;">${clp(consumo)}</span>
        </div>
        <div class="prog-bar"><div class="prog-fill" style="width:${total>0?Math.min(100,consumo/total*100):0}%;background:var(--blue);"></div></div>
        ${singleHtml}
      </div>

      <!-- Cuotas section -->
      <div class="cyc-block" style="margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span style="font-size:11px;font-weight:700;color:#A78BFA;text-transform:uppercase;letter-spacing:0.07em;">Cuotas comprometidas</span>
          <span style="font-size:16px;font-weight:800;color:#A78BFA;">${clp(cuotasTotal)}</span>
        </div>
        <div class="prog-bar"><div class="prog-fill" style="width:${total>0?Math.min(100,cuotasTotal/total*100):0}%;background:#A78BFA;"></div></div>
        ${cuotaHtml}
      </div>

      <!-- Total a pagar -->
      <div style="background:${urgBg};border:1px solid ${urgBorder};border-radius:14px;padding:16px;margin:0 20px 16px;">
        <div style="font-size:11px;font-weight:700;color:${urgColor};text-transform:uppercase;letter-spacing:0.07em;margin-bottom:4px;">Total a pagar</div>
        <div style="font-size:28px;font-weight:900;color:${urgColor};margin-bottom:4px;">${clp(total)}</div>
        <div style="font-size:12px;color:${urgColor};opacity:0.85;">Vence ${dueStr}${daysLeft<=10?' ¬∑ '+daysLeft+' d√≠as':''}</div>
      </div>

      <!-- Movimientos recientes -->
      <div style="padding:0 20px 20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <span style="font-size:13px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em;">Movimientos del ciclo</span>
          <span style="font-size:12px;color:var(--blue);cursor:pointer;" onclick="switchTab('movimientos')">Ver todos</span>
        </div>
        ${recentHtml}
      </div>`;

  } else if (currentDetailTab === 'proximo') {
    const nextRef = new Date(now.getFullYear(), now.getMonth()+1, 1);
    const nextCycle = getCycleClosingInMonth(card.closeDay, card.dueDay, nextRef);
    const nextTxns = getCreditTxnsForCycle(card, nextRef);
    let nextConsumo = 0, nextCuotas = 0;
    nextTxns.forEach(t => {
      const amt = t.cuotas>1 ? (t.installmentAmt||Math.ceil(t.amount/t.cuotas)) : t.amount;
      if (t.cuotas>1) nextCuotas+=amt; else nextConsumo+=amt;
    });
    const nextDue = nextCycle.dueDate.toLocaleDateString('es-CL',{day:'numeric',month:'long'});
    const cycleStr = nextCycle.start.toLocaleDateString('es-CL',{day:'numeric',month:'short'}) + ' ‚Äì ' + nextCycle.end.toLocaleDateString('es-CL',{day:'numeric',month:'short'});
    const estimado = nextConsumo + nextCuotas;
    const daysToClose = Math.ceil((nextCycle.end - now) / 86400000);

    el.innerHTML = `
      <!-- Grid 2 col -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:0 20px;margin-bottom:12px;">
        <div class="cyc-block" style="margin:0;padding:14px;">
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:6px;">Consumo acumulado</div>
          <div style="font-size:20px;font-weight:800;margin-bottom:6px;">${clp(nextConsumo)}</div>
          <div class="prog-bar" style="margin:0;"><div class="prog-fill" style="width:${estimado>0?Math.min(100,nextConsumo/estimado*100):0}%;background:var(--blue);"></div></div>
        </div>
        <div class="cyc-block" style="margin:0;padding:14px;">
          <div style="font-size:10px;color:#A78BFA;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:6px;">Cuotas comprometidas</div>
          <div style="font-size:20px;font-weight:800;color:#A78BFA;margin-bottom:6px;">${clp(nextCuotas)}</div>
          <div class="prog-bar" style="margin:0;"><div class="prog-fill" style="width:${estimado>0?Math.min(100,nextCuotas/estimado*100):0}%;background:#A78BFA;"></div></div>
        </div>
      </div>

      <!-- Estimado -->
      <div style="background:rgba(59,130,246,0.10);border:1px solid rgba(59,130,246,0.2);border-radius:14px;padding:16px;margin:0 20px 12px;">
        <div style="font-size:11px;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:4px;">Estimado pr√≥ximo pago</div>
        <div style="font-size:26px;font-weight:900;color:var(--blue);margin-bottom:2px;">~${clp(estimado)}+</div>
        <div style="font-size:12px;color:var(--blue);opacity:0.7;">consumo puede aumentar hasta el cierre ¬∑ ${daysToClose} d√≠as restantes</div>
        <div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(59,130,246,0.15);font-size:12px;color:var(--blue);">Vencimiento: ${nextDue}</div>
      </div>

      <!-- Tip educativo -->
      <div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.15);border-radius:12px;padding:12px 14px;margin:0 20px;">
        <div style="display:flex;gap:8px;align-items:flex-start;">
          <span style="font-size:18px;flex-shrink:0;">üí°</span>
          <p style="font-size:12px;color:#F59E0B;font-weight:500;line-height:1.6;">Todo lo que gastes con esta tarjeta hasta el d√≠a <strong>${card.closeDay}</strong> se cobra en el vencimiento del mes siguiente.</p>
        </div>
      </div>`;

  } else {
    // Historial ‚Äî last 6 cycles
    const histRows = [];
    for (let m = 1; m <= 6; m++) {
      const ref = new Date(now.getFullYear(), now.getMonth()-m, 1);
      const cycle = getCycleClosingInMonth(card.closeDay, card.dueDay, ref);
      const txns = getCreditTxnsForCycle(card, ref);
      let consumo = 0, cuotas = 0;
      txns.forEach(t => {
        const amt = t.cuotas>1 ? (t.installmentAmt||Math.ceil(t.amount/t.cuotas)) : t.amount;
        if (t.cuotas>1) cuotas+=amt; else consumo+=amt;
      });
      const total = consumo + cuotas;
      const monthName = ref.toLocaleDateString('es-CL',{month:'long',year:'numeric'}).replace(/^./,s=>s.toUpperCase());
      const periodStr = cycle.start.toLocaleDateString('es-CL',{day:'numeric',month:'short'}) + ' ‚Äì ' + cycle.end.toLocaleDateString('es-CL',{day:'numeric',month:'short'});
      histRows.push({monthName, consumo, cuotas, total, periodStr});
    }
    const avg = histRows.length ? Math.round(histRows.reduce((s,r)=>s+r.total,0)/histRows.length) : 0;

    el.innerHTML = `
      <div style="padding-bottom:20px;">
        ${histRows.map(r => `
          <div class="hist-item">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <div>
                <div style="font-size:14px;font-weight:700;">${r.monthName}</div>
                <div style="font-size:11px;color:var(--muted);">${r.periodStr}</div>
              </div>
              <span style="font-size:11px;background:rgba(16,185,129,0.15);color:#10B981;padding:4px 10px;border-radius:20px;font-weight:700;">‚úì Pagado</span>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
              <div style="background:rgba(255,255,255,0.04);border-radius:8px;padding:8px;text-align:center;">
                <div style="font-size:10px;color:var(--muted);margin-bottom:2px;">Consumo</div>
                <div style="font-size:13px;font-weight:700;">${clp(r.consumo)}</div>
              </div>
              <div style="background:rgba(167,139,250,0.08);border-radius:8px;padding:8px;text-align:center;">
                <div style="font-size:10px;color:#A78BFA;margin-bottom:2px;">Cuotas</div>
                <div style="font-size:13px;font-weight:700;color:#A78BFA;">${clp(r.cuotas)}</div>
              </div>
              <div style="background:rgba(59,130,246,0.08);border-radius:8px;padding:8px;text-align:center;">
                <div style="font-size:10px;color:var(--blue);margin-bottom:2px;">Total</div>
                <div style="font-size:13px;font-weight:700;color:var(--blue);">${clp(r.total)}</div>
              </div>
            </div>
          </div>`).join('')}
        <div style="margin:0 20px;padding:16px;background:var(--card);border-radius:12px;border:1px solid rgba(255,255,255,0.06);text-align:center;">
          <div style="font-size:11px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.06em;">Promedio √∫ltimos 6 meses</div>
          <div style="font-size:24px;font-weight:900;color:var(--blue);">${clp(avg)}</div>
        </div>
      </div>`;
  }
}


// ‚îÄ‚îÄ‚îÄ Bank quick select ‚îÄ‚îÄ‚îÄ
function selectBank(bankName, color) {
  const nameField = document.getElementById('newCardName');
  if (nameField) nameField.value = bankName;
  pickColor(color);
  document.querySelectorAll('.bank-chip').forEach(el => {
    el.classList.toggle('selected', el.textContent.trim() === bankName);
  });
}

// ‚îÄ‚îÄ‚îÄ Edit Card ‚îÄ‚îÄ‚îÄ
let editingCardId = null;
let selectedEditCardColor = '#2563EB';

function openEditCard(cardId) {
  editingCardId = cardId;
  const card = DB.get('cards',[]).find(c => String(c.id) === String(cardId));
  if (!card) return;
  selectedEditCardColor = card.color;
  const colors = ['#2563EB','#7C3AED','#10B981','#EF4444','#F59E0B','#EC4899'];
  document.getElementById('editCardForm').innerHTML = `
    <div class="form-field">
      <label class="form-label">Nombre de la tarjeta</label>
      <input type="text" class="form-input" id="editCardName" value="${card.name}"/>
    </div>
    <div class="form-field">
      <label class="form-label">√öltimos 4 d√≠gitos (opcional)</label>
      <input type="number" class="form-input" id="editCardLast4" value="${card.last4||''}" placeholder="Ej: 4521" maxlength="4" inputmode="numeric"/>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="form-field">
        <label class="form-label">D√≠a de cierre</label>
        <input type="number" class="form-input" id="editCardClose" value="${card.closeDay}" min="1" max="31" inputmode="numeric"/>
      </div>
      <div class="form-field">
        <label class="form-label">D√≠a de vencimiento</label>
        <input type="number" class="form-input" id="editCardDue" value="${card.dueDay}" min="1" max="31" inputmode="numeric"/>
      </div>
    </div>
    <div class="form-field">
      <label class="form-label">Color de la tarjeta</label>
      <div style="display:flex;gap:12px;margin-top:4px;">
        ${colors.map(col => `
          <div class="color-pick-edit" data-c="${col}" onclick="pickEditColor('${col}')"
            style="width:36px;height:36px;border-radius:50%;background:${col};cursor:pointer;
            border:3px solid ${col===card.color?'#FFF':'transparent'};
            box-shadow:${col===card.color?'0 0 0 2px '+col:'none'};transition:all 0.15s;"></div>
        `).join('')}
      </div>
    </div>
  `;
  openOverlay('screenEditCard');
}

function pickEditColor(col) {
  selectedEditCardColor = col;
  document.querySelectorAll('.color-pick-edit').forEach(el => {
    const sel = el.dataset.c === col;
    el.style.border = sel ? '3px solid #FFF' : '3px solid transparent';
    el.style.boxShadow = sel ? '0 0 0 2px ' + col : 'none';
  });
}

async function saveEditCard() {
  const cards = DB.get('cards',[]);
  const idx = cards.findIndex(c => String(c.id) === String(editingCardId));
  if (idx === -1) return;
  const nameVal = document.getElementById('editCardName')?.value?.trim();
  if (nameVal) cards[idx].name = nameVal;
  cards[idx].last4 = document.getElementById('editCardLast4')?.value?.slice(-4) || null;
  cards[idx].closeDay = parseInt(document.getElementById('editCardClose')?.value) || cards[idx].closeDay;
  cards[idx].dueDay = parseInt(document.getElementById('editCardDue')?.value) || cards[idx].dueDay;
  cards[idx].color = selectedEditCardColor;
  DB.set('cards', cards);
  try { await SB.saveCard(cards[idx]); } catch(e) { console.warn('SB edit failed', e); }
  closeOverlay('screenEditCard');
  renderCards();
  if (document.getElementById('screenCardDetail').classList.contains('open')) renderCardDetail();
  renderDashboard();
  showToast('‚úì Tarjeta actualizada');
}

function confirmDeleteCard() {
  if (confirm('¬øEliminar esta tarjeta y todos sus registros asociados?')) {
    deleteCard(editingCardId);
    closeOverlay('screenEditCard');
    closeModal('screenCardDetail');
    showToast('‚úì Tarjeta eliminada');
  }
}

function getCardGradient(color) {
  const gradients = {
    '#2563EB': 'linear-gradient(135deg,#1e3a5f 0%,#2563eb 100%)',
    '#7C3AED': 'linear-gradient(135deg,#3b1f6e 0%,#7c3aed 100%)',
    '#059669': 'linear-gradient(135deg,#1a3c34 0%,#059669 100%)',
    '#DC2626': 'linear-gradient(135deg,#5a1a1a 0%,#dc2626 100%)',
    '#D97706': 'linear-gradient(135deg,#4a2c00 0%,#d97706 100%)',
    '#0F172A': 'linear-gradient(135deg,#0f172a 0%,#334155 100%)',
  };
  return gradients[color] || `linear-gradient(135deg,${color}cc 0%,${color} 100%)`;
}
function getCardNetwork(name) {
  const n = (name||'').toLowerCase();
  if (n.includes('visa')) return 'VISA';
  if (n.includes('master')) return 'MC';
  if (n.includes('cmr') || n.includes('falabella')) return 'CMR';
  if (n.includes('amex')) return 'AMEX';
  if (n.includes('ripley')) return 'RIPLEY';
  return '‚óè‚óè';
}
function renderCards() {
  const cards = DB.get('cards',[]);
  const allTxns = DB.get('transactions',[]);
  const now = new Date();
  document.getElementById('cardsCount').textContent = cards.length + (cards.length===1?' tarjeta':' tarjetas');
  const el = document.getElementById('cardsList');
  if (!cards.length) {
    el.innerHTML=`<div style="text-align:center;padding:40px 20px;color:var(--muted);font-size:14px;">No tienes tarjetas.<br/><br/><button class="btn-primary" style="max-width:220px;" onclick="openAddCard()">+ Agregar tarjeta</button></div>`;
    return;
  }
  el.innerHTML = cards.map(card => {
    const grad = getCardGradient(card.color);
    const network = getCardNetwork(card.name);
    const last4 = card.last4 ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + card.last4 : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    // Calculate cycle totals if credit card
    let consumo = 0, cuotasTotal = 0, dueStr = '', daysLeft = 999, urgColor = 'var(--blue)';
    if (card.type === 'credito') {
      const cycle = getCycleClosingInMonth(card.closeDay, card.dueDay, now);
      const cycleTxns = getCreditTxnsForCycle(card, now);
      cycleTxns.forEach(t => {
        const amt = t.cuotas > 1 ? (t.installmentAmt || Math.ceil(t.amount/t.cuotas)) : t.amount;
        if (t.cuotas > 1) cuotasTotal += amt; else consumo += amt;
      });
      dueStr = cycle.dueDate.toLocaleDateString('es-CL',{day:'numeric',month:'long'});
      daysLeft = Math.ceil((cycle.dueDate - now) / 86400000);
      urgColor = daysLeft<=5 ? 'var(--red)' : daysLeft<=10 ? 'var(--amber)' : 'var(--blue)';
    }
    const total = consumo + cuotasTotal;
    return `
    <div style="margin-bottom:32px;">
      <!-- Visual Card ‚Äî fully rounded, standalone floating card -->
      <div class="card-visual" style="background:${grad};border-radius:16px;" onclick="openCardDetail('${card.id}')">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;position:relative;z-index:1;">
          <span class="${network==='VISA'?'card-network':'card-network-plain'}">${network}</span>
          <span style="font-size:13px;font-weight:600;color:rgba(255,255,255,0.7);">${card.name.replace(network,'').replace('Banco','').replace('  ',' ').trim()||card.name}</span>
        </div>
        <div style="position:relative;z-index:1;margin:12px 0;">
          <div class="card-number">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.last4||'‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:flex-end;position:relative;z-index:1;">
          <div class="card-chip"></div>
          <span class="material-symbols-rounded" style="color:rgba(255,255,255,0.5);font-size:28px;">contactless</span>
        </div>
      </div>
      <!-- Card Info Below -->
      ${card.type==='credito' ? `
      <div class="card-list-item">
        <!-- stitch-style info -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <span style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;">Pr√≥ximo pago</span>
          <span style="font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;background:${daysLeft<=10?'rgba(245,158,11,0.15)':'rgba(16,185,129,0.12)'};color:${daysLeft<=10?'#F59E0B':'#10B981'};">${daysLeft<=10?'‚ö† Vence en '+daysLeft+' d√≠as':'‚úì Al d√≠a'}</span>
        </div>
        <div style="font-size:28px;font-weight:800;color:var(--text);margin-bottom:12px;">${clp(total)}</div>
        <div style="height:1px;background:rgba(255,255,255,0.08);margin-bottom:14px;"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px 20px;margin-bottom:14px;">
          <div><div style="font-size:11px;color:var(--muted);margin-bottom:2px;">Fecha Cierre</div><div style="font-size:14px;font-weight:700;">${new Date(new Date().getFullYear(),new Date().getMonth(),card.closeDay).toLocaleDateString('es-CL',{day:'numeric',month:'long'})}</div></div>
          <div><div style="font-size:11px;color:var(--muted);margin-bottom:2px;">Vencimiento</div><div style="font-size:14px;font-weight:700;">${dueStr}</div></div>
          <div><div style="font-size:11px;color:var(--muted);margin-bottom:2px;">Consumo mes</div><div style="font-size:14px;font-weight:700;">${clp(consumo)}</div></div>
          <div><div style="font-size:11px;color:var(--muted);margin-bottom:2px;">Cuotas</div><div style="font-size:14px;font-weight:700;color:#A78BFA;">${clp(cuotasTotal)}</div></div>
        </div>
        <div style="height:1px;background:rgba(255,255,255,0.08);margin-bottom:14px;"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding-top:12px;border-top:1px solid rgba(255,255,255,0.06);cursor:pointer;" onclick="openCardDetail('${card.id}')">
          <span style="font-size:13px;font-weight:600;color:var(--blue);">Ver detalle del ciclo</span>
          <span class="material-symbols-rounded" style="color:var(--blue);font-size:18px;">arrow_forward_ios</span>
        </div>
        </div>
      </div>` : `
      <div class="card-list-item">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:14px;color:var(--muted);">Cuenta d√©bito</span>
          <button onclick="deleteCard('${card.id}')" style="background:rgba(239,68,68,0.12);border:none;border-radius:8px;padding:6px 10px;cursor:pointer;"><span class="material-symbols-rounded" style="color:var(--red);font-size:18px;display:block;">delete</span></button>
        </div>
      </div>`}
    </div>`;
  }).join('');
}
async function deleteCard(id) {
  try { await SB.deleteCard(id); } catch(e) { console.warn('SB card delete failed', e); }
  DB.set('cards', DB.get('cards',[]).filter(c=>String(c.id)!==String(id)));
  DB.set('transactions', DB.get('transactions',[]).filter(t=>String(t.cardId)!==String(id)));
  renderCards();
  renderDashboard();
  showToast('‚úì Tarjeta eliminada');
}
function openAddCard() {
  document.getElementById('newCardName').value='';
  document.getElementById('newCardClose').value='';
  document.getElementById('newCardDue').value='';
  selectedCardColor='#2563EB'; selectedCardType='credito';
  document.getElementById('creditCardFields').style.display='block';
  document.getElementById('cardtype-credito').classList.add('active');
  document.getElementById('cardtype-debito').classList.remove('active');
  openOverlay('screenAddCard');
}
function selectCardType(t) {
  selectedCardType=t;
  document.getElementById('cardtype-credito').classList.toggle('active',t==='credito');
  document.getElementById('cardtype-debito').classList.toggle('active',t==='debito');
  document.getElementById('creditCardFields').style.display=t==='credito'?'block':'none';
}
function pickColor(c) {
  selectedCardColor=c;
  document.querySelectorAll('.color-pick').forEach(el=>{el.style.border='3px solid transparent';el.style.boxShadow='none';});
  const sel = document.querySelector(`.color-pick[data-c="${c}"]`);
  if (sel) { sel.style.border='3px solid #000'; sel.style.boxShadow='0 0 0 2px white inset'; }
}
async function saveCard() {
  const name = document.getElementById('newCardName').value.trim();
  if (!name) { showToast('Ingresa un nombre'); return; }
  let newCard = {
    id: 'card_' + Date.now(),
    name,
    type: selectedCardType,
    closeDay: parseInt(document.getElementById('newCardClose').value) || 5,
    dueDay: parseInt(document.getElementById('newCardDue').value) || 28,
    color: selectedCardColor,
    last4: document.getElementById('newCardLast4')?.value?.slice(-4) || null,
  };
  // Save to Supabase first to get real ID
  try { const sv = await SB.saveCard(newCard); if (sv) newCard = sv; } catch(e) { console.warn('SB card save failed', e); }
  const cards = DB.get('cards', []);
  cards.push(newCard);
  DB.set('cards', cards);
  closeOverlay('screenAddCard');
  renderCards();
  renderDashboard();
  showToast('‚úì Tarjeta guardada');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateSettingsDisplay() {
  const s = DB.get('settings',{});
  document.getElementById('incomeDisplay').textContent = s.income ? clp(s.income)+'/mes' : 'No configurado';
  initEmailAutoSettings();
  document.getElementById('defaultViewDisplay').textContent = (s.period==='ciclo'?'Ciclo Tarjeta':'Mes') + ' ¬∑ ' + (s.view==='porpagar'?'Por Pagar':'Consumo');
  document.getElementById('catCount').textContent = getAllCats().length + ' categor√≠as';
  // Budget status
  const budget = DB.get('budget', {});
  const budgetStatus = document.getElementById('budgetSettingsStatus');
  if (budgetStatus) {
    if (budget.totalAmount) {
      const catCount = budget.categories ? Object.keys(budget.categories).length : 0;
      budgetStatus.textContent = clp(budget.totalAmount) + ' ¬∑ ' + catCount + ' categor√≠as';
    } else {
      budgetStatus.textContent = 'No configurado';
    }
  }
}
async function editIncome() {
  const s = DB.get('settings',{});
  const val = prompt('Ingreso mensual en CLP:', s.income||'');
  if (val!==null) { s.income=parseInt(val)||0; DB.set('settings',s); try{await SB.saveSettings(s);}catch(e){} renderDashboard(); updateSettingsDisplay(); showToast('‚úì Ingreso actualizado'); }
}
function exportCSV() {
  const txns = DB.get('transactions',[]);
  if (!txns.length) { showToast('No hay datos'); return; }
  const rows = txns.map(t=>[t.date,t.merchant||'',getCat(t.category).name,t.amount,t.payMethod,t.cuotas||1,t.type,t.note||''].map(v=>`"${v}"`).join(','));
  const csv = ['Fecha,Comercio,Categor√≠a,Monto,Pago,Cuotas,Tipo,Nota',...rows].join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='lucas_'+today()+'.csv'; a.click();
  showToast('‚úì CSV exportado');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg) {
  const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}


function updateCyclePreview() {
  const closeDay = parseInt(document.getElementById('ob2Close')?.value);
  const dueDay = parseInt(document.getElementById('ob2Due')?.value);
  const preview = document.getElementById('cyclePreview');
  const previewText = document.getElementById('cyclePreviewText');
  if (!preview || !previewText) return;
  if (!closeDay || !dueDay) { preview.style.display='none'; return; }
  // Calculate example using current date
  const now = new Date();
  const cycle = getActiveCycle(closeDay, dueDay);
  const start = cycle.start.toLocaleDateString('es-CL',{day:'numeric',month:'long'});
  const end = cycle.end.toLocaleDateString('es-CL',{day:'numeric',month:'long'});
  const due = cycle.dueDate.toLocaleDateString('es-CL',{day:'numeric',month:'long'});
  previewText.textContent = 'Per√≠odo actual: ' + start + ' al ' + end + '. Debes pagar antes del ' + due + '.';
  preview.style.display = 'block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEMO SEED DATA ‚Äî loaded on first boot
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildDemoCards() {
  return [
    {"id":"card_bci","name":"Visa BCI","type":"credito","closeDay":20,"dueDay":5,"color":"#2563EB","last4":"4521"},
    {"id":"card_cmr","name":"CMR Falabella","type":"credito","closeDay":15,"dueDay":1,"color":"#DC2626","last4":"8834"},
    {"id":"card_santander","name":"Santander","type":"debito","closeDay":null,"dueDay":null,"color":"#EA580C","last4":"2210"}
  ];
}
function buildDemoTxns() {
  function t(id,type,amount,merchant,category,pay,card,date,cuotas,num,plan,purchase,inst) {
    return {id:'demo_'+id,type,amount,merchant,category,payMethod:pay,cardId:card,date,
      cuotas:cuotas||1,cuotaNum:num||1,planId:plan||null,
      purchaseDate:purchase||date,installmentAmt:inst||amount,
      source:'demo',createdAt:'2026-02-22T10:00:00.000Z',note:''};
  }
  return [
    t('inc1','income',2500000,'Sueldo febrero','ingresos','debito','card_santander','2026-02-05'),
    t('ef1','expense',4800,'Feria / verduras','comida','efectivo',null,'2026-02-08'),
    t('ef2','expense',3200,'Propina restaurante','comida','efectivo',null,'2026-02-15'),
    t('ef3','expense',8500,'Estacionamiento','transporte','efectivo',null,'2026-02-19'),
    t('db1','expense',67400,'Supermercado L\u00edder','comida','debito','card_santander','2026-02-04'),
    t('db2','expense',42300,'Copec bencina','transporte','debito','card_santander','2026-02-11'),
    t('db3','expense',38900,'Farmacias Ahumada','salud','debito','card_santander','2026-02-17'),
    t('db4','expense',85000,'Dividendo hipotecario','servicios','debito','card_santander','2026-02-05'),
    t('db5','expense',28400,'Santa Isabel','comida','debito','card_santander','2026-02-21'),
    t('bci1','expense',34900,'Netflix','servicios','tarjeta','card_bci','2026-02-01'),
    t('bci2','expense',56800,'Restaurante El Mes\u00f3n','comida','tarjeta','card_bci','2026-02-07'),
    t('bci3','expense',18500,'Uber','transporte','tarjeta','card_bci','2026-02-12'),
    t('bci4','expense',129000,'Zara','compras','tarjeta','card_bci','2026-02-14'),
    t('bci5','expense',45600,'Copec bencina','transporte','tarjeta','card_bci','2026-01-28'),
    t('bci6','expense',22900,'Spotify + Apple TV','servicios','tarjeta','card_bci','2026-01-15'),
    t('bci_s1','expense',450000,'TV Samsung 55"','compras','tarjeta','card_bci','2026-02-18',6,1,'plan_sam','2026-01-25',75000),
    t('bci_s2','expense',75000,'TV Samsung 55"','compras','tarjeta','card_bci','2026-03-18',6,2,'plan_sam','2026-01-25',75000),
    t('bci_s3','expense',75000,'TV Samsung 55"','compras','tarjeta','card_bci','2026-04-18',6,3,'plan_sam','2026-01-25',75000),
    t('bci_s4','expense',75000,'TV Samsung 55"','compras','tarjeta','card_bci','2026-05-18',6,4,'plan_sam','2026-01-25',75000),
    t('bci_s5','expense',75000,'TV Samsung 55"','compras','tarjeta','card_bci','2026-06-18',6,5,'plan_sam','2026-01-25',75000),
    t('bci_s6','expense',75000,'TV Samsung 55"','compras','tarjeta','card_bci','2026-07-18',6,6,'plan_sam','2026-01-25',75000),
    t('cmr1','expense',89900,'Falabella tienda','compras','tarjeta','card_cmr','2026-01-22'),
    t('cmr2','expense',31200,'Caf\u00e9 Costanera','comida','tarjeta','card_cmr','2026-02-03'),
    t('cmr3','expense',15900,'Spotify Premium','servicios','tarjeta','card_cmr','2026-02-10'),
    t('cmr4','expense',47800,'Farmacia Cruz Verde','salud','tarjeta','card_cmr','2026-01-30'),
    t('cmr_s1','expense',240000,'Sill\u00f3n Paris','compras','tarjeta','card_cmr','2026-02-10',3,1,'plan_sillon','2026-01-20',80000),
    t('cmr_s2','expense',80000,'Sill\u00f3n Paris','compras','tarjeta','card_cmr','2026-03-10',3,2,'plan_sillon','2026-01-20',80000),
    t('cmr_s3','expense',80000,'Sill\u00f3n Paris','compras','tarjeta','card_cmr','2026-04-10',3,3,'plan_sillon','2026-01-20',80000),
  ];
}
function loadDemoData() {
  // Clean start ‚Äî no pre-loaded data, user goes through onboarding fresh
  // (demo data available via resetDemo if needed)
}
async function resetAllData() {
  if (!confirm('‚ö†Ô∏è ¬øBorrar TODOS tus datos? Gastos, tarjetas y presupuesto. No se puede deshacer.')) return;
  if (CURRENT_USER) {
    try {
      await supa.from('transactions').delete().eq('user_id',CURRENT_USER.id);
      await supa.from('cards').delete().eq('user_id',CURRENT_USER.id);
    } catch(e) { console.warn('wipe error',e); }
  }
  Object.keys(STORE).forEach(k => delete STORE[k]);
  localStorage.removeItem('lucas_budget');
  renderDashboard(); renderCards(); updateSettingsDisplay();
  showToast('‚úì Todos los datos eliminados');
}

function resetDemo() {
  // Only wipe transactions + cards ‚Äî onboarding/settings stay intact
  delete STORE['transactions'];
  delete STORE['cards'];
  // Reload the demo data fresh
  loadDemoDataForced();
  renderDashboard();
  renderCards();
  showToast('\u2713 Datos de demo reseteados');
}
function loadDemoDataForced() {
  // Separate from loadDemoData ‚Äî always runs, no guard
  const cards = buildDemoCards();
  const txns  = buildDemoTxns();
  DB.set('cards', cards);
  DB.set('transactions', txns);
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updateFabPosition() {
  const fab = document.getElementById('fabBtn');
  const app = document.getElementById('app');
  if (!fab || !app) return;
  const rect = app.getBoundingClientRect();
  // Position FAB: right edge of app - 12px margin
  fab.style.right = (window.innerWidth - rect.right + 12) + 'px';
}
window.addEventListener('resize', updateFabPosition);
window.addEventListener('DOMContentLoaded', () => { setTimeout(updateFabPosition, 100); });

// Detect if running inside iframe (Claude viewer) ‚Äî OCR won't work there
window.addEventListener('DOMContentLoaded', () => {
  const inIframe = window.self !== window.top;
  if (inIframe) {
    const notice = document.getElementById('iframeNotice');
    if (notice) notice.style.display = 'flex';
  }
});

window.addEventListener('DOMContentLoaded', async () => {
  // Restore Supabase session or show auth screen
  try {
    const { data: { session } } = await supa.auth.getSession();
    if (session && session.user) {
      CURRENT_USER = session.user;
      document.getElementById('authScreen').style.display = 'none';
      showToast('Cargando tus datos‚Ä¶');
      await SB.loadAll();
      loadDemoData();
      const s = DB.get('settings', {});
      if (s.onboarded) { document.getElementById('obScreen').style.display='none'; startApp(); }
      else { document.getElementById('obScreen').style.display='flex'; }
      return;
    }
  } catch(e) {
    console.warn('Session restore failed', e);
    // If offline but have cached data, allow limited offline use
    const cachedTxns = DB.get('transactions', []);
    const cachedCards = DB.get('cards', []);
    const hasLocalData = cachedTxns.length > 0 || cachedCards.length > 0;
    if (hasLocalData) {
      showToast('üì∂ Sin conexi√≥n ‚Äî usando datos guardados');
      document.getElementById('authScreen').style.display = 'none';
      loadDemoData();
      const s = DB.get('settings', {});
      if (s.onboarded) { document.getElementById('obScreen').style.display='none'; startApp(); }
      else { document.getElementById('obScreen').style.display='flex'; }
      return;
    }
  }
  // No session ‚Äî show auth
  document.getElementById('authScreen').style.display = 'flex';
});
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMAIL PENDING (Automatizaci√≥n)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEMO_EMAIL_PENDINGS = [
  { id: 'ep_1', merchant: 'Uber Eats', amount: 14990, date: today(), category: 'comida',
    payMethod: 'tarjeta', cardLast4: '4521', bankEmail: 'alertas@bci.cl',
    rawSubject: 'Compra aprobada BCI $14.990 - Uber Eats', status: 'pending', source: 'email' },
  { id: 'ep_2', merchant: 'Shell', amount: 52000, date: today(), category: 'transporte',
    payMethod: 'tarjeta', cardLast4: '4521', bankEmail: 'alertas@bci.cl',
    rawSubject: 'Compra aprobada BCI $52.000 - Shell Bencinera', status: 'pending', source: 'email' },
  { id: 'ep_3', merchant: 'Zara', amount: 89990, date: today(), category: 'compras',
    payMethod: 'tarjeta', cardLast4: '4521', bankEmail: 'alertas@bci.cl',
    rawSubject: 'Compra aprobada BCI $89.990 - Zara', status: 'pending', source: 'email' },
];

function getEmailPendings() {
  return DB.get('emailPendings', []);
}

function loadDemoEmailPendings() {
  // Load demo items if none exist and toggle is on
  const s = DB.get('settings', {});
  if (!s.emailAutoEnabled) return;
  const existing = DB.get('emailPendings', []);
  if (existing.length === 0) {
    DB.set('emailPendings', DEMO_EMAIL_PENDINGS);
  }
}

function toggleEmailAuto() {
  const on = document.getElementById('emailAutoToggle').checked;
  const setup = document.getElementById('emailAutoSetup');
  const status = document.getElementById('emailAutoStatus');
  setup.style.display = on ? 'block' : 'none';
  const s = DB.get('settings', {});
  s.emailAutoEnabled = on;
  DB.set('settings', s);
  if (on) {
    status.textContent = '‚úì Activo ‚Äî esperando correos';
    status.style.color = 'var(--green)';
    loadDemoEmailPendings();
    renderDashboard();
  } else {
    status.textContent = 'No configurado';
    status.style.color = 'var(--muted)';
  }
}

function copyForwardEmail() {
  const email = document.getElementById('userForwardEmail').textContent;
  navigator.clipboard?.writeText(email).then(() => showToast('‚úì Email copiado'));
}

function addBankEmail() {
  const input = document.getElementById('newBankEmail');
  const email = input.value.trim();
  if (!email || !email.includes('@')) { showToast('Ingresa un email v√°lido'); return; }
  const s = DB.get('settings', {});
  s.bankEmails = s.bankEmails || [];
  if (s.bankEmails.includes(email)) { showToast('Ya est√° agregado'); return; }
  s.bankEmails.push(email);
  DB.set('settings', s);
  input.value = '';
  renderBankEmails();
  showToast('‚úì Email agregado');
}

function removeBankEmail(email) {
  const s = DB.get('settings', {});
  s.bankEmails = (s.bankEmails || []).filter(e => e !== email);
  DB.set('settings', s);
  renderBankEmails();
}

function renderBankEmails() {
  const list = document.getElementById('bankEmailsList');
  if (!list) return;
  const s = DB.get('settings', {});
  const emails = s.bankEmails || [];
  if (!emails.length) {
    list.innerHTML = '<p style="font-size:12px;color:var(--muted);">Ninguno a√∫n ‚Äî agrega el email de notificaciones de tu banco.</p>';
    return;
  }
  list.innerHTML = emails.map(e => `
    <div style="display:flex;align-items:center;justify-content:space-between;background:var(--bg);border-radius:8px;padding:8px 12px;">
      <p style="font-size:13px;font-weight:600;">${e}</p>
      <button onclick="removeBankEmail('${e}')" style="background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer;">‚úï</button>
    </div>`).join('');
}

function confirmEmailPending(id) {
  const pendings = DB.get('emailPendings', []);
  const item = pendings.find(p => p.id === id);
  if (!item) return;
  // Create real transaction
  const txns = DB.get('transactions', []);
  txns.push({
    id: 'txn_' + Date.now(),
    type: 'expense',
    amount: item.amount,
    merchant: item.merchant,
    category: item.category,
    payMethod: item.payMethod,
    cardLast4: item.cardLast4,
    date: item.date,
    purchaseDate: item.date,
    cuotas: 1, cuotaNum: 1,
    installmentAmt: item.amount,
    source: 'email',
    note: '',
    createdAt: new Date().toISOString(),
  });
  DB.set('transactions', txns);
  item.status = 'confirmed';
  DB.set('emailPendings', pendings);
  renderDashboard();
  if (document.getElementById('screenMovimientos').classList.contains('open')) renderMovimientos();
  showToast('‚úì Movimiento confirmado');
}

function editEmailPending(id) {
  // Open manual entry pre-filled with pending data
  const pendings = DB.get('emailPendings', []);
  const item = pendings.find(p => p.id === id);
  if (!item) return;
  // Mark as dismissed then open manual pre-filled
  item.status = 'dismissed';
  DB.set('emailPendings', pendings);
  renderDashboard();
  // Pre-fill manual form
  openManual();
  setTimeout(() => {
    const amtEl = document.getElementById('manualAmount');
    const mchEl = document.getElementById('manualMerchant');
    const dateEl = document.getElementById('manualDate');
    if (amtEl) amtEl.value = item.amount;
    if (mchEl) mchEl.value = item.merchant;
    if (dateEl) dateEl.value = item.date;
    // Select category
    const catSel = document.getElementById('manualCategory');
    if (catSel) catSel.value = item.category;
    // Select payment method
    selectPayMethod('tarjeta');
  }, 100);
}

function dismissEmailPending(id) {
  const pendings = DB.get('emailPendings', []);
  const item = pendings.find(p => p.id === id);
  if (item) item.status = 'dismissed';
  DB.set('emailPendings', pendings);
  renderDashboard();
  showToast('Movimiento descartado');
}

function renderEmailPendingWidget() {
  const widget = document.getElementById('emailPendingWidget');
  if (!widget) return;
  const s = DB.get('settings', {});
  if (!s.emailAutoEnabled) { widget.innerHTML = ''; return; }
  const pendings = DB.get('emailPendings', []).filter(p => p.status === 'pending');
  if (!pendings.length) { widget.innerHTML = ''; return; }

  widget.innerHTML = `
    <div style="background:var(--card);border:1px solid rgba(59,130,246,0.25);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);">
      <!-- Header -->
      <div style="padding:12px 16px;background:linear-gradient(135deg,#1D4ED8,#2563EB);display:flex;align-items:center;justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="material-symbols-rounded" style="color:white;font-size:18px;font-variation-settings:\"FILL\" 1;">mark_email_unread</span>
          <p style="font-size:13px;font-weight:800;color:white;">Movimientos por confirmar</p>
        </div>
        <span style="background:rgba(255,255,255,0.25);color:white;border-radius:100px;padding:2px 9px;font-size:11px;font-weight:800;">${pendings.length}</span>
      </div>
      <!-- Items -->
      <div style="divide-y:1px solid var(--border);">
        ${pendings.map((p, i) => {
          const cat = getCat(p.category);
          return `
          <div style="padding:12px 16px;${i > 0 ? 'border-top:1px solid var(--border);' : ''}display:flex;align-items:center;gap:12px;">
            <!-- Icon -->
            <div style="width:38px;height:38px;border-radius:10px;background:${cat.color}18;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
              <span class="material-symbols-rounded" style="font-size:18px;color:${cat.color};font-variation-settings:\"FILL\" 1;">${cat.icon}</span>
            </div>
            <!-- Info -->
            <div style="flex:1;min-width:0;">
              <p style="font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.merchant}</p>
              <p style="font-size:11px;color:var(--muted);">${clp(p.amount)} ¬∑ ¬∑¬∑¬∑${p.cardLast4 || '****'}</p>
            </div>
            <!-- Actions -->
            <div style="display:flex;gap:6px;flex-shrink:0;">
              <button onclick="editEmailPending('${p.id}')"
                style="background:rgba(255,255,255,0.08);border:none;border-radius:8px;padding:7px 10px;font-family:inherit;font-size:11px;font-weight:700;color:var(--muted);cursor:pointer;">
                Editar
              </button>
              <button onclick="confirmEmailPending('${p.id}')"
                style="background:#22C55E;border:none;border-radius:8px;padding:7px 12px;font-family:inherit;font-size:12px;font-weight:700;color:white;cursor:pointer;">
                ‚úì
              </button>
              <button onclick="dismissEmailPending('${p.id}')"
                style="background:rgba(239,68,68,0.12);border:none;border-radius:8px;padding:7px 8px;font-family:inherit;font-size:12px;font-weight:700;color:var(--red);cursor:pointer;">
                ‚úï
              </button>
            </div>
          </div>`;
        }).join('')}
      </div>
      <!-- Footer -->
      <div style="padding:8px 16px;background:rgba(59,130,246,0.06);border-top:1px solid rgba(59,130,246,0.15);display:flex;align-items:center;gap:6px;">
        <span class="material-symbols-rounded" style="font-size:12px;color:#3B82F6;">info</span>
        <p style="font-size:11px;color:#3B82F6;">Capturados autom√°ticamente desde tu correo del banco</p>
      </div>
    </div>`;
}

function initEmailAutoSettings() {
  const s = DB.get('settings', {});
  const toggle = document.getElementById('emailAutoToggle');
  const setup = document.getElementById('emailAutoSetup');
  const status = document.getElementById('emailAutoStatus');
  if (!toggle) return;
  toggle.checked = !!s.emailAutoEnabled;
  setup.style.display = s.emailAutoEnabled ? 'block' : 'none';
  if (s.emailAutoEnabled) {
    if (status) { status.textContent = '‚úì Activo ‚Äî esperando correos'; status.style.color = 'var(--green)'; }
  }
  renderBankEmails();
}

function openAddSheet() {
  const sheet = document.getElementById('addSheet');
  sheet.style.display = 'block';
  requestAnimationFrame(() => {
    document.getElementById('addSheetPanel').style.transform = 'translateX(-50%) translateY(0)';
  });
}
function closeAddSheet() {
  document.getElementById('addSheet').style.display = 'none';
}
function openQuickIncome() {
  document.getElementById('quickIncomeAmt').value = '';
  document.getElementById('quickIncomeNote').value = '';
  const qid=document.getElementById('quickIncomeDate'); if(qid) qid.value=today();
  document.getElementById('quickIncomeSheet').style.display = 'block';
  setTimeout(() => document.getElementById('quickIncomeAmt').focus(), 100);
}
function closeQuickIncome() {
  document.getElementById('quickIncomeSheet').style.display = 'none';
}
function quickIncomeSetToday() {
  const qid=document.getElementById('quickIncomeDate'); if(qid) qid.value=today();
  document.getElementById('qi-today').style.borderColor = '#22C55E';
  document.getElementById('qi-today').style.background = '#F0FDF4';
  document.getElementById('qi-yesterday').style.borderColor = 'var(--border)';
  document.getElementById('qi-yesterday').style.background = 'white';
}
function quickIncomeSetYesterday() {
  const d = new Date(); d.setDate(d.getDate()-1);
  document.getElementById('quickIncomeDate').value = d.toISOString().split('T')[0];
  document.getElementById('qi-yesterday').style.borderColor = '#22C55E';
  document.getElementById('qi-yesterday').style.background = '#F0FDF4';
  document.getElementById('qi-today').style.borderColor = 'var(--border)';
  document.getElementById('qi-today').style.background = 'white';
}
async function saveQuickIncome() {
  const amt = parseInt(document.getElementById('quickIncomeAmt').value);
  if (!amt || amt <= 0) { showToast('Ingresa un monto'); document.getElementById('quickIncomeAmt').focus(); return; }
  const note = document.getElementById('quickIncomeNote').value.trim();
  const date = document.getElementById('quickIncomeDate')?.value || today();
  const txn = {
    id: 'txn_' + Date.now(),
    type: 'income', amount: amt,
    merchant: note || 'Ingreso',
    category: 'ingresos',
    payMethod: 'debito', cardId: null,
    date, purchaseDate: date,
    cuotas: 1, cuotaNum: 1, installmentAmt: amt,
    source: 'manual', createdAt: new Date().toISOString(), note,
  };
  let saved = [txn];
  try { saved = await SB.saveTxns([txn]); } catch(e) { console.warn(e); }
  const txns = DB.get('transactions', []);
  saved.forEach(t => txns.push(t));
  DB.set('transactions', txns);
  closeQuickIncome();
  renderDashboard();
  if (document.getElementById('screenMovimientos').classList.contains('open')) renderMovimientos();
  showToast('\u2713 Ingreso registrado: ' + clp(amt));
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// M√ìDULO DE PRESUPUESTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Persistencia Supabase ‚îÄ‚îÄ
async function saveBudgetToSB(budget) {
  if (!CURRENT_USER) return;
  try {
    await supa.from('user_settings').upsert({
      user_id: CURRENT_USER.id,
      budget: JSON.stringify(budget),
      updated_at: new Date().toISOString()
    }, { onConflict: 'user_id' });
  } catch(e) { console.warn('Budget SB save failed', e); }
}

async function loadBudgetFromSB() {
  if (!CURRENT_USER) return;
  try {
    const { data } = await supa.from('user_settings')
      .select('budget')
      .eq('user_id', CURRENT_USER.id)
      .single();
    if (data?.budget) {
      const parsed = JSON.parse(data.budget);
      if (parsed && typeof parsed === 'object') DB.set('budget', parsed);
    }
  } catch(e) {}
}

// ‚îÄ‚îÄ Helper: compute catTotals from current month ‚îÄ‚îÄ
function getBudgetCatTotals() {
  const txns = getTxnsForMonth();
  const catTotals = {};
  txns.forEach(t => {
    if (t.type === 'income') return;
    const amt = t.cuotas > 1 ? (t.installmentAmt || Math.ceil(t.amount / t.cuotas)) : t.amount;
    catTotals[t.category] = (catTotals[t.category] || 0) + amt;
  });
  return catTotals;
}

// ‚îÄ‚îÄ COMPONENTE 1: Budget Widget en Dashboard ‚îÄ‚îÄ
function renderBudgetWidget(totalGasto, catTotals, ref) {
  const widget = document.getElementById('budgetWidget');
  if (!widget) return;
  const budget = DB.get('budget', {});

  if (!budget.totalAmount && (!budget.categories || !Object.keys(budget.categories).length)) {
    widget.innerHTML = `
      <div class="card card-p" style="display:flex;gap:14px;align-items:center;cursor:pointer;" onclick="openModal('screenBudgetConfig');renderBudgetConfig();">
        <div style="width:44px;height:44px;border-radius:12px;background:rgba(245,158,11,0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <span class="material-symbols-rounded" style="color:#F59E0B;font-size:22px;font-variation-settings:'FILL' 1;">savings</span>
        </div>
        <div style="flex:1;">
          <p style="font-size:14px;font-weight:700;">¬øQuieres controlar tus gastos?</p>
          <p style="font-size:12px;color:var(--muted);line-height:1.4;margin-top:2px;">Configura un presupuesto mensual y LuKas te avisa cuando te acerques al l√≠mite.</p>
        </div>
        <span class="material-symbols-rounded" style="color:var(--blue);font-size:20px;">chevron_right</span>
      </div>`;
    return;
  }

  const total = budget.totalAmount || 0;
  const pct = total > 0 ? Math.min(120, Math.round(totalGasto / total * 100)) : 0;
  const barColor = pct >= 90 ? 'var(--red)' : pct >= 70 ? 'var(--amber)' : 'var(--green)';

  const now = new Date();
  const refMonth = ref || getDashMonth();
  const daysInMonth = new Date(refMonth.getFullYear(), refMonth.getMonth() + 1, 0).getDate();
  const isCurr = refMonth.getMonth() === now.getMonth() && refMonth.getFullYear() === now.getFullYear();
  const daysElapsed = isCurr ? now.getDate() : daysInMonth;
  const daysRemaining = daysInMonth - daysElapsed;
  const dailyPace = daysElapsed > 0 ? Math.round(totalGasto / daysElapsed) : 0;
  const idealPace = total > 0 ? Math.round(total / daysInMonth) : 0;
  const paceOk = dailyPace <= idealPace;

  const threshold = budget.alertThreshold || 0.8;
  const catBudgets = budget.categories || {};
  const atRisk = Object.entries(catBudgets)
    .map(([catId, limit]) => {
      const spent = catTotals[catId] || 0;
      const catPct = limit > 0 ? spent / limit : 0;
      return { catId, limit, spent, pct: catPct };
    })
    .filter(c => c.pct >= threshold)
    .sort((a, b) => b.pct - a.pct)
    .slice(0, 3);

  widget.innerHTML = `
    <div class="card card-p" style="cursor:pointer;border-left:3px solid ${barColor};" onclick="openModal('screenBudgetDetail');renderBudgetDetail();">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="material-symbols-rounded" style="font-size:16px;color:#F59E0B;font-variation-settings:'FILL' 1;">savings</span>
          <span style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em;">Presupuesto mensual</span>
        </div>
        <button onclick="event.stopPropagation();openModal('screenBudgetConfig');renderBudgetConfig();" style="background:none;border:none;font-family:inherit;font-size:12px;font-weight:700;color:var(--blue);cursor:pointer;">Editar</button>
      </div>
      <div style="margin-bottom:8px;">
        <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px;">
          <span style="font-size:22px;font-weight:800;">${clp(totalGasto)}</span>
          <span style="font-size:13px;color:var(--muted);font-weight:600;">de ${clp(total)}</span>
        </div>
        <div style="height:7px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;">
          <div style="height:100%;border-radius:4px;width:${Math.min(100,pct)}%;background:${barColor};transition:width 0.7s ease;${pct>100?'box-shadow:0 0 8px rgba(239,68,68,0.4);':''}"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:5px;">
          <span style="font-size:11px;color:var(--muted);">${pct}% ¬∑ ${isCurr ? (daysRemaining > 0 ? 'Quedan ' + daysRemaining + ' d√≠as' : '√öltimo d√≠a') : 'Mes cerrado'}</span>
          <span style="font-size:11px;color:${paceOk?'var(--green)':'var(--amber)'};font-weight:700;">${clp(dailyPace)}/d√≠a ${paceOk?'‚úÖ':'‚ö†Ô∏è'}</span>
        </div>
      </div>
      <div style="border-top:1px solid var(--border);padding-top:8px;margin-top:2px;">
        ${atRisk.length > 0
          ? atRisk.map(r => {
              const cat = getCat(r.catId);
              const cc = r.pct >= 1 ? 'var(--red)' : 'var(--amber)';
              const cp = Math.min(100, Math.round(r.pct * 100));
              return `<div style="display:flex;align-items:center;gap:8px;padding:3px 0;">
                <span style="font-size:14px;">${cat.emoji||'üì¶'}</span>
                <span style="font-size:12px;font-weight:600;flex:1;">${cat.name}</span>
                <div style="width:60px;height:3px;background:rgba(255,255,255,0.08);border-radius:2px;overflow:hidden;">
                  <div style="height:100%;width:${cp}%;background:${cc};border-radius:2px;"></div>
                </div>
                <span style="font-size:11px;font-weight:700;color:${cc};min-width:34px;text-align:right;">${cp}%</span>
              </div>`;
            }).join('')
          : `<p style="font-size:12px;color:var(--green);font-weight:600;">‚úÖ Todas las categor√≠as bajo control</p>`
        }
      </div>
    </div>`;
}

// ‚îÄ‚îÄ COMPONENTE 2: Budget Detail Screen ‚îÄ‚îÄ
function renderBudgetDetail() {
  const el = document.getElementById('budgetDetailContent');
  if (!el) return;
  const budget = DB.get('budget', {});
  const catBudgets = budget.categories || {};
  const catTotals = getBudgetCatTotals();
  const allTxns = getTxnsForMonth();
  let totalGasto = 0;
  allTxns.forEach(t => {
    if (t.type === 'income') return;
    totalGasto += t.cuotas > 1 ? (t.installmentAmt || Math.ceil(t.amount / t.cuotas)) : t.amount;
  });

  const total = budget.totalAmount || 0;
  const pct = total > 0 ? Math.min(120, Math.round(totalGasto / total * 100)) : 0;
  const barColor = pct >= 90 ? 'var(--red)' : pct >= 70 ? 'var(--amber)' : 'var(--green)';

  const now = new Date();
  const ref = getDashMonth();
  const daysInMonth = new Date(ref.getFullYear(), ref.getMonth() + 1, 0).getDate();
  const isCurr = ref.getMonth() === now.getMonth() && ref.getFullYear() === now.getFullYear();
  const daysElapsed = isCurr ? now.getDate() : daysInMonth;
  const daysRemaining = daysInMonth - daysElapsed;
  const dailyPace = daysElapsed > 0 ? Math.round(totalGasto / daysElapsed) : 0;
  const idealPace = total > 0 ? Math.round(total / daysInMonth) : 0;
  const paceOk = dailyPace <= idealPace;
  const projection = dailyPace * daysInMonth;
  const remaining = total - totalGasto;

  // Split cats into: with budget / without budget
  const allCats = getAllCats();
  const catsWithBudget = allCats.filter(cat => catBudgets[cat.id] > 0);
  const catsWithout = allCats.filter(cat => !catBudgets[cat.id] && catTotals[cat.id] > 0);

  el.innerHTML = `
    <!-- Global progress header -->
    <div class="card card-p" style="margin-bottom:12px;border-left:3px solid ${barColor};">
      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px;">
        <div>
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em;font-weight:700;margin-bottom:2px;">Total gastado</div>
          <div style="font-size:26px;font-weight:900;">${clp(totalGasto)}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:11px;color:var(--muted);">de</div>
          <div style="font-size:20px;font-weight:700;color:var(--muted);">${total > 0 ? clp(total) : '‚Äî'}</div>
        </div>
      </div>
      ${total > 0 ? `
      <div style="height:8px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;margin-bottom:6px;">
        <div style="height:100%;border-radius:4px;width:${Math.min(100,pct)}%;background:${barColor};transition:width 0.8s ease;"></div>
      </div>
      <div style="display:flex;justify-content:space-between;">
        <span style="font-size:12px;color:var(--muted);">${pct}% utilizado ¬∑ ${remaining >= 0 ? clp(remaining) + ' disponible' : clp(Math.abs(remaining)) + ' sobre el l√≠mite'}</span>
        <span style="font-size:12px;color:${paceOk?'var(--green)':'var(--amber)'};font-weight:700;">${paceOk?'‚úÖ':'‚ö†Ô∏è'} ${clp(dailyPace)}/d√≠a</span>
      </div>` : ''}
    </div>

    <!-- Proyecci√≥n -->
    ${total > 0 && isCurr ? `
    <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.15);border-radius:12px;padding:14px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div style="font-size:11px;color:var(--blue);font-weight:700;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:3px;">Proyecci√≥n del mes</div>
        <div style="font-size:18px;font-weight:800;color:${projection > total ? 'var(--red)' : 'var(--green)'};">~${clp(projection)}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px;">${daysRemaining} d√≠as restantes</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:11px;color:var(--muted);">Ritmo ideal</div>
        <div style="font-size:16px;font-weight:700;">${clp(idealPace)}/d√≠a</div>
        <div style="font-size:11px;color:var(--muted);">Actual: ${clp(dailyPace)}/d√≠a</div>
      </div>
    </div>` : ''}

    <!-- Categor√≠as con presupuesto -->
    ${catsWithBudget.length > 0 ? `
    <div style="margin-bottom:16px;">
      <p style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:10px;">Por categor√≠a</p>
      ${catsWithBudget.map(cat => {
        const spent = catTotals[cat.id] || 0;
        const limit = catBudgets[cat.id];
        const cp = limit > 0 ? Math.min(120, Math.round(spent / limit * 100)) : 0;
        const cc = cp >= 90 ? 'var(--red)' : cp >= 70 ? 'var(--amber)' : 'var(--green)';
        const remaining = limit - spent;
        return `<div style="background:var(--card);border-radius:12px;padding:14px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.06);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-size:20px;">${cat.emoji||'üì¶'}</span>
              <span style="font-size:14px;font-weight:700;">${cat.name}</span>
            </div>
            <div style="text-align:right;">
              <div style="font-size:14px;font-weight:800;">${clp(spent)}</div>
              <div style="font-size:11px;color:var(--muted);">de ${clp(limit)}</div>
            </div>
          </div>
          <div style="height:5px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;margin-bottom:5px;">
            <div style="height:100%;border-radius:3px;width:${Math.min(100,cp)}%;background:${cc};transition:width 0.6s ease;"></div>
          </div>
          <div style="display:flex;justify-content:space-between;">
            <span style="font-size:11px;color:${cc};font-weight:700;">${cp}%</span>
            <span style="font-size:11px;color:${remaining>=0?'var(--muted)':'var(--red)'};">${remaining>=0?clp(remaining)+' disponible':clp(Math.abs(remaining))+' sobre el l√≠mite'}</span>
          </div>
        </div>`;
      }).join('')}
    </div>` : ''}

    <!-- Sin presupuesto (pero con gasto) -->
    ${catsWithout.length > 0 ? `
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <p style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em;">Sin presupuesto asignado</p>
        <button onclick="openModal('screenBudgetConfig');renderBudgetConfig();" style="background:none;border:none;font-size:12px;font-weight:700;color:var(--blue);cursor:pointer;font-family:inherit;">Asignar ‚Üí</button>
      </div>
      ${catsWithout.map(cat => `
        <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--card);border-radius:10px;margin-bottom:6px;border:1px solid rgba(255,255,255,0.05);">
          <span style="font-size:18px;">${cat.emoji||'üì¶'}</span>
          <span style="font-size:13px;font-weight:600;flex:1;">${cat.name}</span>
          <span style="font-size:13px;font-weight:700;color:var(--muted);">${clp(catTotals[cat.id])}</span>
        </div>`).join('')}
    </div>` : ''}
  `;
}

// ‚îÄ‚îÄ COMPONENTE 3: Budget Config ‚îÄ‚îÄ
function renderBudgetConfig() {
  const el = document.getElementById('budgetConfigContent');
  if (!el) return;
  const budget = DB.get('budget', {});
  const catBudgets = budget.categories || {};
  const settings = DB.get('settings', {});
  const suggestedTotal = settings.income ? Math.round(settings.income * 0.9) : 0;

  // Compute last 3 months average per cat for auto-distribute
  const allTxns = DB.get('transactions', []);
  const now = new Date();
  const recentCatTotals = {};
  for (let m = 1; m <= 3; m++) {
    const ref = new Date(now.getFullYear(), now.getMonth() - m, 1);
    allTxns.forEach(t => {
      if (t.type === 'income') return;
      const d = new Date((t.purchaseDate || t.date) + 'T12:00:00');
      if (d.getMonth() === ref.getMonth() && d.getFullYear() === ref.getFullYear()) {
        const amt = t.cuotas > 1 ? (t.installmentAmt || Math.ceil(t.amount / t.cuotas)) : t.amount;
        recentCatTotals[t.category] = (recentCatTotals[t.category] || 0) + amt;
      }
    });
  }
  // Average over 3 months
  Object.keys(recentCatTotals).forEach(k => recentCatTotals[k] = Math.round(recentCatTotals[k] / 3));

  el.innerHTML = `
    <!-- Total presupuesto -->
    <div class="form-field" style="margin-bottom:16px;">
      <label class="form-label">Presupuesto total mensual</label>
      <div style="position:relative;">
        <span style="position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:16px;font-weight:700;color:var(--muted);">$</span>
        <input type="number" class="form-input" id="budgetTotalInput" style="padding-left:28px;font-size:18px;font-weight:700;"
          value="${budget.totalAmount || ''}" placeholder="Ej: 1.200.000" inputmode="numeric"/>
      </div>
      ${suggestedTotal > 0 ? `
      <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.15);border-radius:10px;padding:10px 12px;margin-top:8px;display:flex;justify-content:space-between;align-items:center;">
        <span style="font-size:12px;color:var(--blue);">üí° Sugerido (90% de tu ingreso): <strong>${clp(suggestedTotal)}</strong></span>
        <button onclick="document.getElementById('budgetTotalInput').value='${suggestedTotal}';updateBudgetSummary();" style="background:var(--blue);border:none;border-radius:8px;color:white;font-family:inherit;font-size:11px;font-weight:700;padding:5px 10px;cursor:pointer;">Usar</button>
      </div>` : ''}
    </div>

    <!-- Umbral de alerta -->
    <div class="form-field" style="margin-bottom:20px;">
      <label class="form-label">Alertar cuando llegue al</label>
      <select class="form-input" id="budgetAlertThreshold" style="font-size:15px;">
        <option value="0.7" ${(budget.alertThreshold||0.8)===0.7?'selected':''}>70% del presupuesto</option>
        <option value="0.8" ${(!budget.alertThreshold||budget.alertThreshold===0.8)?'selected':''}>80% del presupuesto</option>
        <option value="0.9" ${(budget.alertThreshold||0.8)===0.9?'selected':''}>90% del presupuesto</option>
      </select>
    </div>

    <!-- Auto distribute button -->
    <button onclick="autoDistributeBudget()" style="width:100%;padding:11px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:12px;font-family:inherit;font-size:13px;font-weight:700;color:#A78BFA;cursor:pointer;margin-bottom:16px;display:flex;align-items:center;justify-content:center;gap:6px;">
      <span class="material-symbols-rounded" style="font-size:16px;">auto_fix</span>
      ${Object.keys(recentCatTotals).length > 0 ? 'Distribuir seg√∫n historial (√∫ltimos 3 meses)' : 'Distribuir en partes iguales'}
    </button>

    <!-- Categories -->
    <p style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:10px;">L√≠mite por categor√≠a (opcional)</p>
    <div id="budgetCatList">
      ${getAllCats().map(cat => `
        <div style="background:var(--card);border-radius:12px;padding:12px 14px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.06);display:flex;align-items:center;gap:12px;">
          <span style="font-size:20px;flex-shrink:0;">${cat.emoji||'üì¶'}</span>
          <span style="font-size:14px;font-weight:600;flex:1;">${cat.name}</span>
          <div style="position:relative;width:120px;">
            <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--muted);">$</span>
            <input type="number" id="budgetCat_${cat.id}" class="form-input"
              style="padding:8px 8px 8px 22px;font-size:13px;font-weight:700;text-align:right;width:100%;"
              value="${catBudgets[cat.id]||''}" placeholder="Sin l√≠mite" inputmode="numeric"
              oninput="updateBudgetSummary()"/>
          </div>
        </div>`).join('')}
    </div>

    <!-- Summary -->
    <div id="budgetSummaryBlock" style="background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.12);border-radius:12px;padding:14px;margin-top:4px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
        <span style="font-size:12px;color:var(--muted);">Asignado a categor√≠as</span>
        <span style="font-size:13px;font-weight:700;" id="budgetSumAssigned">$0</span>
      </div>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
        <span style="font-size:12px;color:var(--muted);">Sin asignar</span>
        <span style="font-size:13px;font-weight:700;color:var(--green);" id="budgetSumFree">‚Äî</span>
      </div>
      <div style="display:flex;justify-content:space-between;padding-top:8px;border-top:1px solid var(--border);">
        <span style="font-size:13px;font-weight:700;">Total presupuesto</span>
        <span style="font-size:14px;font-weight:800;" id="budgetSumTotal">‚Äî</span>
      </div>
    </div>

    <!-- Save buttons inside scroll ‚Äî iPhone always reaches them -->
    <div style="padding:24px 0 16px;">
      <button class="btn-primary" onclick="saveBudget()" style="width:100%;padding:16px;font-size:16px;font-weight:700;border-radius:14px;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px;">
        <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;font-size:20px;">save</span>
        Guardar presupuesto
      </button>
      <button onclick="copyLastMonthBudget()" style="width:100%;padding:12px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:12px;font-family:inherit;font-size:14px;font-weight:600;color:var(--blue);cursor:pointer;">
        Copiar del mes anterior
      </button>
    </div>
  `;
  updateBudgetSummary();
}

function updateBudgetSummary() {
  const totalInput = parseInt(document.getElementById('budgetTotalInput')?.value) || 0;
  let assigned = 0;
  getAllCats().forEach(cat => {
    const v = parseInt(document.getElementById('budgetCat_' + cat.id)?.value) || 0;
    assigned += v;
  });
  const free = totalInput - assigned;
  const aEl = document.getElementById('budgetSumAssigned');
  const fEl = document.getElementById('budgetSumFree');
  const tEl = document.getElementById('budgetSumTotal');
  if (aEl) aEl.textContent = clp(assigned);
  if (fEl) {
    fEl.textContent = totalInput > 0 ? clp(Math.max(0, free)) : '‚Äî';
    fEl.style.color = free < 0 ? 'var(--red)' : 'var(--green)';
  }
  if (tEl) tEl.textContent = totalInput > 0 ? clp(totalInput) : '‚Äî';
}

function autoDistributeBudget() {
  const totalInput = parseInt(document.getElementById('budgetTotalInput')?.value) || 0;
  if (!totalInput) { showToast('Primero ingresa el presupuesto total'); return; }
  const allTxns = DB.get('transactions', []);
  const now = new Date();
  const catTotals3m = {};
  for (let m = 1; m <= 3; m++) {
    const ref = new Date(now.getFullYear(), now.getMonth() - m, 1);
    allTxns.forEach(t => {
      if (t.type === 'income') return;
      const d = new Date((t.purchaseDate || t.date) + 'T12:00:00');
      if (d.getMonth() === ref.getMonth() && d.getFullYear() === ref.getFullYear()) {
        const amt = t.cuotas > 1 ? (t.installmentAmt || Math.ceil(t.amount / t.cuotas)) : t.amount;
        catTotals3m[t.category] = (catTotals3m[t.category] || 0) + amt;
      }
    });
  }
  const sumAll = Object.values(catTotals3m).reduce((a, b) => a + b, 0);
  if (!sumAll) {
    // Equal distribution fallback
    const smartDist = {'comida':0.28,'servicios':0.18,'transporte':0.12,'compras':0.12,'ocio':0.10,'salud':0.08,'deporte':0.05,'otros':0.07};
    Object.entries(smartDist).forEach(([catId,pct]) => {
      const input = document.getElementById('budgetCat_' + catId);
      if (input) input.value = Math.round(totalInput * pct / 1000) * 1000;
    });
    updateBudgetSummary();
    showToast('‚úì Distribuci√≥n t√≠pica aplicada');
    return;
  }
  getAllCats().forEach(cat => {
    const input = document.getElementById('budgetCat_' + cat.id);
    if (!input) return;
    const proportion = (catTotals3m[cat.id] || 0) / sumAll;
    const suggested = Math.round(totalInput * proportion / 1000) * 1000; // round to 1000
    if (suggested > 0) input.value = suggested;
    else input.value = '';
  });
  updateBudgetSummary();
  showToast('‚úì Distribuci√≥n autom√°tica aplicada');
}

async function saveBudget() {
  const totalAmount = parseInt(document.getElementById('budgetTotalInput')?.value) || 0;
  const alertThreshold = parseFloat(document.getElementById('budgetAlertThreshold')?.value) || 0.8;
  const categories = {};
  getAllCats().forEach(cat => {
    const input = document.getElementById('budgetCat_' + cat.id);
    if (input && input.value) {
      const val = parseInt(input.value);
      if (val > 0) categories[cat.id] = val;
    }
  });
  const budget = { totalAmount, alertThreshold, categories, updatedAt: new Date().toISOString() };
  DB.set('budget', budget);
  try { await saveBudgetToSB(budget); } catch(e) { console.warn('Budget save failed', e); }
  closeModal('screenBudgetConfig');
  renderDashboard();
  updateSettingsDisplay();
  showToast('‚úì Presupuesto guardado');
}

function copyLastMonthBudget() {
  const budget = DB.get('budget', {});
  if (budget.totalAmount || (budget.categories && Object.keys(budget.categories).length)) {
    renderBudgetConfig();
    showToast('Presupuesto anterior aplicado');
  } else {
    showToast('No hay presupuesto anterior guardado');
  }
}

</script>

  <!-- ‚îÄ‚îÄ ADD SHEET ‚îÄ‚îÄ -->
  <div id="addSheet" style="display:none;position:fixed;inset:0;z-index:300;" onclick="closeAddSheet()">
    <div style="position:absolute;inset:0;background:rgba(0,0,0,0.5);"></div>
    <div id="addSheetPanel" style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:var(--card);border-radius:24px 24px 0 0;padding:12px 20px 40px;box-shadow:0 -8px 40px rgba(0,0,0,0.2);" onclick="event.stopPropagation()">
      <div style="width:36px;height:4px;background:rgba(255,255,255,0.15);border-radius:2px;margin:0 auto 20px;"></div>
      <p style="font-size:16px;font-weight:800;margin-bottom:16px;">¬øQu√© quieres registrar?</p>

      <!-- INGRESO R√ÅPIDO ‚Äî 5 seconds -->
      <div style="background:rgba(16,185,129,0.08);border:1.5px solid #86EFAC;border-radius:16px;padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;cursor:pointer;" onclick="closeAddSheet();openQuickIncome()">
        <div style="width:44px;height:44px;border-radius:12px;background:#22C55E;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <span class="material-symbols-rounded" style="color:white;font-size:22px;font-variation-settings:\"FILL\" 1;">add_circle</span>
        </div>
        <div style="flex:1;">
          <p style="font-size:15px;font-weight:800;color:#34D399;">Ingreso r√°pido</p>
          <p style="font-size:12px;color:#4ADE80;">Sueldo, transferencia, vuelto‚Ä¶ en 5 seg</p>
        </div>
        <span class="material-symbols-rounded" style="color:#22C55E;font-size:20px;">chevron_right</span>
      </div>

      <!-- GASTO MANUAL -->
      <div style="background:var(--card);border:1.5px solid var(--border);border-radius:16px;padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;cursor:pointer;" onclick="closeAddSheet();openManual()">
        <div style="width:44px;height:44px;border-radius:12px;background:var(--blue);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <span class="material-symbols-rounded" style="color:white;font-size:22px;font-variation-settings:\"FILL\" 1;">edit</span>
        </div>
        <div style="flex:1;">
          <p style="font-size:15px;font-weight:800;">Gasto manual</p>
          <p style="font-size:12px;color:var(--muted);">Monto, categor√≠a, tarjeta, cuotas</p>
        </div>
        <span class="material-symbols-rounded" style="color:var(--muted);font-size:20px;">chevron_right</span>
      </div>

      <!-- FOTO BOLETA -->
      <div style="background:var(--card);border:1.5px solid var(--border);border-radius:16px;padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;cursor:pointer;" onclick="closeAddSheet();openCamera()">
        <div style="width:44px;height:44px;border-radius:12px;background:#7C3AED;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <span class="material-symbols-rounded" style="color:white;font-size:22px;font-variation-settings:\"FILL\" 1;">photo_camera</span>
        </div>
        <div style="flex:1;">
          <p style="font-size:15px;font-weight:800;">Foto boleta</p>
          <p style="font-size:12px;color:var(--muted);">OCR extrae monto y comercio</p>
        </div>
        <span class="material-symbols-rounded" style="color:var(--muted);font-size:20px;">chevron_right</span>
      </div>

      <!-- SUBIR PDF/IMAGEN -->
      <div style="background:var(--card);border:1.5px solid var(--border);border-radius:16px;padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;" onclick="closeAddSheet();openUpload()">
        <div style="width:44px;height:44px;border-radius:12px;background:#EA580C;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <span class="material-symbols-rounded" style="color:white;font-size:22px;font-variation-settings:\"FILL\" 1;">upload_file</span>
        </div>
        <div style="flex:1;">
          <p style="font-size:15px;font-weight:800;">Subir PDF / imagen</p>
          <p style="font-size:12px;color:var(--muted);">Boleta digital, comprobante, cartola</p>
        </div>
        <span class="material-symbols-rounded" style="color:var(--muted);font-size:20px;">chevron_right</span>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ QUICK INCOME SHEET ‚îÄ‚îÄ -->
  <div id="quickIncomeSheet" style="display:none;position:fixed;inset:0;z-index:310;" onclick="closeQuickIncome()">
    <div style="position:absolute;inset:0;background:rgba(0,0,0,0.5);"></div>
    <div style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:var(--card);border-radius:24px 24px 0 0;padding:12px 20px 40px;" onclick="event.stopPropagation()">
      <div style="width:36px;height:4px;background:rgba(255,255,255,0.15);border-radius:2px;margin:0 auto 16px;"></div>
      <p style="font-size:16px;font-weight:800;margin-bottom:4px;">üí∞ Registrar ingreso</p>
      <p style="font-size:13px;color:var(--muted);margin-bottom:20px;">Sueldo, transferencia, vuelto de amigo‚Ä¶</p>

      <!-- Amount row -->
      <div style="display:flex;align-items:center;gap:8px;background:rgba(16,185,129,0.08);border:2px solid #22C55E;border-radius:14px;padding:14px 16px;margin-bottom:12px;">
        <span style="font-size:22px;font-weight:800;color:#22C55E;">$</span>
        <input type="number" id="quickIncomeAmt" placeholder="0" inputmode="numeric"
          style="flex:1;border:none;background:none;font-family:inherit;font-size:28px;font-weight:800;color:#34D399;outline:none;"
          onkeydown="if(event.key==='Enter')saveQuickIncome()"/>
      </div>
      <!-- Note -->
      <input type="text" id="quickIncomeNote" placeholder="Descripci√≥n (opcional): Sueldo, vuelto‚Ä¶"
        style="width:100%;border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;font-family:inherit;font-size:14px;margin-bottom:12px;background:var(--card);color:var(--text);box-sizing:border-box;outline:none;"
        onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='var(--border)'"/>
      <!-- Date -->
      <input type="date" id="quickIncomeDate"
        style="width:100%;border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;font-family:inherit;font-size:14px;margin-bottom:16px;background:var(--card);color:var(--text);box-sizing:border-box;outline:none;"
        onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='var(--border)'"/>
      <!-- Save button -->
      <button onclick="saveQuickIncome()"
        style="width:100%;padding:16px;background:#22C55E;border:none;border-radius:14px;font-family:inherit;font-size:16px;font-weight:800;color:white;cursor:pointer;">
        üí∞ Registrar ingreso
      </button>

